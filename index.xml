<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Sam&#39;s Blog</title>
<link>https://samanklesaria.github.io/</link>
<atom:link href="https://samanklesaria.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>Dabbling in Data Science</description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Fri, 19 Dec 2025 06:00:00 GMT</lastBuildDate>
<item>
  <title>Air Quality and Congestion Pricing</title>
  <link>https://samanklesaria.github.io/posts/congestion_pricing/Notebook.html</link>
  <description><![CDATA[ 





<p>This post dives into the data of a recent paper quantifying the effects of Manhattan’s recent congestion pricing scheme (<span class="citation" data-cites="fraser_first_2025">Fraser et al. (2025)</span>). The authors argue that congestion pricing decreased the average daily maximum PM 2.5 concentration by 3 μg/m^3. Obviously, this isn’t the kind of treatment effect one can show experimentally; they first had to estimate what particulate concentration would have been if congestion pricing hadn’t been put into place, and then take the difference between what was observed and what they predicted. I’ll be adapting their methodology to use a Bayesian workflow.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lubridate)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstanarm)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bayesplot"</span>)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span></code></pre></div></div>
</div>
<p>The data below comes from air quality sensors throughout the NYC metropolitan area. For each day from January 1 2024 through June 1 2025, we observe the maximum PM 2.5 concentration at that sensor, along with environmental factors near that sensor that might influence the reading (e.g.&nbsp;distance from a highway, temperature, precipitation, population density, median income, etc). Sensors come from three different “areas”: the congestion reduction zone (abbreviated CRZ) where, starting in January 2025, congestion pricing was implemented, the five boroughs of New York (abbreviated NYC), and the rest of the greater metropolitan area (abbreviated CBSA).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_rds</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel_daily_nyc.rds"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(week, within, area, date, bgmean, value, treated, temp, precip,</span>
<span id="cb2-3">         pop_density, median_income) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_trunc=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor_date</span>(date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weeks"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">week_start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb2-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treated_crz =</span> treated <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> within) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>()</span></code></pre></div></div>
</div>
<p>Below, we’ll plot bands of 25% to 75% quantiles of weekly PM 2.5 concentration over time. The vertical bar indicates the start of the treatment period.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">quants <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> \(spec, prefix) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setNames</span>(</span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c_across</span>({{spec}}), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)),</span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(prefix, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lo"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"median"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>)))</span>
<span id="cb3-4"></span>
<span id="cb3-5">tdate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(data, treated)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>date_trunc)</span>
<span id="cb3-6"></span>
<span id="cb3-7">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(area, date_trunc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quants</span>(value, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"val"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(q) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>date_trunc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>val_lo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>val_hi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>area)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> tdate)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looking over the graph gives us some important intuitions:</p>
<ul>
<li>It seems like emissions in all three areas tended to following the same trajectories over time. This suggests basing our prediction for counterfactual particle counts in the CRZ on particle counts in the CBSA and NYC regions.</li>
<li>CRZ emissions before congestion pricing tended to be higher than the other areas. After congestion pricing, that no longer seems to be the case.</li>
<li>At the same time, there seems to be a downward trend overall throughout the two years starting well before congestion pricing began.</li>
</ul>
<section id="a-simple-difference-in-differences-model" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-difference-in-differences-model">A Simple Difference in Differences Model</h2>
<p>With these intuitions in mind, we’ll start with the following simple model using the following assumptions:</p>
<ul>
<li>There’s an overall time-trend affecting all three regions.</li>
<li>The effect of congestion pricing is homogeneous in time and affects only the CRZ.</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(date_trunc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> treated_crz <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> area, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data)</span></code></pre></div></div>
</div>
<p>Let’s compare this model’s predictions of what sensor readings without congestion pricing would have been like to what we observed in practice.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_predict</span>(fit1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treated_crz=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>),])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(preds) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(preds)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(area, date_trunc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>), mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quants</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(q) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(date_trunc, value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>pred_lo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>pred_hi)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true value"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"predicted HDI"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> tdate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>area, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"predicted HDI"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true value"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>))</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The predicted sensor readings generally match the true values before the treatment period, but are higher than what we observed after the treatment period within the CRZ. This suggests that congestion pricing did cause lower emissions. We can also see this in the posterior distribution of the treatment coefficient, with support almost entirely below zero.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mcmc_hist</span>(fit1, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treated_crzTRUE"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="effects-beyond-the-crz" class="level2">
<h2 class="anchored" data-anchor-id="effects-beyond-the-crz">Effects Beyond the CRZ</h2>
<p>So far, we’ve assumed that any treatment effect is localized to the CRZ area. But this may not be the case: perhaps emissions from vehicles driven in the CRZ carry over into other regions as well. If we can’t use areas outside the CRZ as controls, however, we’ll need to choose other sensor locations.</p>
<p>The original paper identified a handful of sensor locations known to be upwind of the CRZ. The average PM 2.5 levels of these sensor locations were identified as “background levels”. These levels are shown below.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(area, date_trunc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bgmean=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bgmean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(date_trunc, bgmean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> tdate)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In our next model, we’ll let all three regions have treatment effects deviating from the linear trend identified by this background PM 2.5 level. We’ll also control for environmental effects.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> bgmean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> treated<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-2">                   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(temp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> precip <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(pop_density <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(median_income <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-3">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mcmc_intervals</span>(fit2)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the posterior plot above, it doesn’t seem like areas outside the CRZ experienced treatment effects after all. Once again, we can plot the counterfactual particle levels from this model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_predict</span>(fit2, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">treated=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>),])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(preds) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb10-3">pred_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(preds))</span>
<span id="cb10-4">pred_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(area, date_trunc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>), mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quants</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(q) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(date_trunc, value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>pred_lo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>pred_hi)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> tdate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>area, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Interestingly, it seems from the plot above like the treatment effect decreases with time: initial PM 2.5 levels dropped in 2025, but now they seem almost level with our counterfactual predictions. We’ll come back to this idea of time-varying treatment effects.</p>
<p>For now, let’s try to calculate the posterior on the treatment effect itself. Because we’re modeling the square root of the PM 2.5 concentration rather than the concentration itself, we can’t just look at posterior of the <code>treated</code> coefficient. Instead, we have to manually calculate the difference between actual observations and couterfactual predictions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">pred_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(treated_crz) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>), \(x) value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>), mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reframe</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">effect=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c_across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pred"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(effect) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(effect)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>() </span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/congestion_pricing/Notebook_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-fraser_first_2025" class="csl-entry">
Fraser, Timothy, Yeonkyeong Gina Park, Danni Lu, Mohammad Tayarani, Haiyan Deng, and H. Oliver Gao. 2025. <span>“A First Look into Congestion Pricing in the <span>United</span> <span>States</span>: <span>PM2</span>.5 Impacts After Six Months of <span>New</span> <span>York</span> <span>City</span> Cordon Pricing.”</span> <em>Npj Clean Air</em> 1 (1): 39. <a href="https://doi.org/10.1038/s44407-025-00037-2">https://doi.org/10.1038/s44407-025-00037-2</a>.
</div>
</div></section></div> ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/congestion_pricing/Notebook.html</guid>
  <pubDate>Fri, 19 Dec 2025 06:00:00 GMT</pubDate>
</item>
<item>
  <title>AnkiVec: Vector Search for Anki</title>
  <link>https://samanklesaria.github.io/posts/ankivec/ankivec.html</link>
  <description><![CDATA[ 





<p>I just released <a href="https://ankiweb.net/shared/info/2028823832?cb=1763666137047">AnkiVec</a>, an Anki addon that creates vector embeddings for cards using Ollama and enables hybrid semantic search with ChromaDB. <img src="https://samanklesaria.github.io/posts/ankivec/screenshot.png" class="img-fluid" alt="screenshot"></p>
<section id="features" class="level2">
<h2 class="anchored" data-anchor-id="features">Features</h2>
<ul>
<li><strong>Vector Embeddings</strong>: Generate embeddings for all cards using local Ollama models</li>
<li><strong>Semantic Search</strong>: Find cards by meaning, not just keywords</li>
<li><strong>Fast Local Processing</strong>: Uses lightweight embedding models (nomic-embed-text by default)</li>
<li><strong>Persistent Storage</strong>: ChromaDB stores embeddings for quick retrieval</li>
</ul>
</section>
<section id="how-to-use-it" class="level2">
<h2 class="anchored" data-anchor-id="how-to-use-it">How to Use It</h2>
<p>When you restart Anki after installing the add-on, a vector-database will be initialized for your deck. This process may take a few minute- you should see a loading dialog with a progress bar. From this point on, any changes to your deck will be automatically indexed.</p>
<p>To search the vector database, use the form “vec: [your query here]” in Anki’s usual search bar. You can combine keyword searches with vector searches by putting the “vec” section at the end of the query: e.g.&nbsp;“keyword1 keyword2 vec: [natural language description]”.</p>
</section>
<section id="why-chromadb" class="level2">
<h2 class="anchored" data-anchor-id="why-chromadb">Why ChromaDB?</h2>
<p>I started trying to use <a href="https://alexgarcia.xyz/sqlite-vec/installation.html">sqlite-vec</a>, modifying Anki’s internal sqlite database. Unfortunately, Anki doesn’t like other processes modifying its database, and frequently warns mistakenly about corruption issues. Eventually, I figured it was easiest to keep the embedding database separate, and switched to ChromaDB.</p>
</section>
<section id="why-ollama" class="level2">
<h2 class="anchored" data-anchor-id="why-ollama">Why Ollama?</h2>
<p>If I’m already using ChromaDB, why use Ollama? ChromaDB has its own embedding models built in! Unfortunately, they’re super slow compared to Ollama’s. For the <code>all-minilm</code> model that ChromaDB uses by default, Ollama’s version is about 2.72x faster on my Mac. Even if you jump through the necessary hoops to get MPS acceleration for ChromaDB, Ollama is still over twice as fast. Yes, this makes installation a bit more complicated, but it’s worth it, and makes it easier to swap in other embedding choices. You can run the benchmarks yourself from the <a href="https://github.com/samanklesaria/ankivec">repository</a>.</p>
</section>
<section id="how-do-dependencies-get-installed" class="level2">
<h2 class="anchored" data-anchor-id="how-do-dependencies-get-installed">How do dependencies get installed?</h2>
<p>Anki’s launcher uses a bundled version of <code>uv</code> to download its dependencies. I piggybacked on this to install my own dependencies (ollama and chromadb).</p>
<ul>
<li>When the addon is initialized, it checks where Anki’s copy of <code>uv</code> is located. On a Mac, this is within the application bundle itself.</li>
<li>Next, it <code>uv sync</code>s its own directory using this bundled <code>uv</code> instance.</li>
<li>Finally, it adds the addon directory to the Python path before importing any modules.</li>
</ul>
<p>This avoids the usual headaches of vendoring in all the transitive dependencies of an Anki addon. Just let <code>uv</code> handle it for you!</p>


</section>

 ]]></description>
  <category>tools</category>
  <guid>https://samanklesaria.github.io/posts/ankivec/ankivec.html</guid>
  <pubDate>Thu, 20 Nov 2025 06:00:00 GMT</pubDate>
</item>
<item>
  <title>Classifying Ships with Gaussian Process Mixtures</title>
  <link>https://samanklesaria.github.io/posts/ships/ships.html</link>
  <description><![CDATA[ 





<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">DataFrames</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PythonCall</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CSV</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Dates</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">DataFramesMeta</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">RecursiveArrayTools</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">StatsBase</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CairoMakie</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">SpecialFunctions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PDMats</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">SizeCheck</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">KernelFunctions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">AbstractGPs</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LogExpFunctions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Random</span></span></code></pre></div></div>
</div>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1">CairoMakie.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enable_only_mime!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span>)</span></code></pre></div></div>
</div>
<p>I recently came across a dataset of container ship movement between Tallinn and Helsinki on Kaggle. In this notebook, we’ll try to classify whether a given ship’s trajectory seems similar to those of the container ships, or whether we’re looking at something else (perhaps a pirate).</p>
<p>I’ll start by loading the ship tracking data, taking zscores of the latitude and longitude, and normalizing timing information for each trajectory. We can identify rows belonging to the same ship’s trajectory by the ship’s International Maritime Organization code (IMO) and its actual arrival time (ATA). For simplicity, we’ll just consider 2k samples of trajectories leaving Helsinki for the time being.</p>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_ship_data</span>()</span>
<span id="cb3-2">    kagglehub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pyimport</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kagglehub"</span>)</span>
<span id="cb3-3">    ships_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pyconvert</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span>, kagglehub.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dataset_download</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bobaaayoung/container-ship-data-collection"</span>))</span>
<span id="cb3-4">    raw_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dropmissing</span>(</span>
<span id="cb3-5">        CSV.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">joinpath</span>(ships_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tracking_db.csv"</span>), DataFrame,</span>
<span id="cb3-6">            dateformat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mm/dd/yyyy HH:MM"</span>,</span>
<span id="cb3-7">            types<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dict</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>updated <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DateTime</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DateTime</span>), silencewarnings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>))</span>
<span id="cb3-8"></span>
<span id="cb3-9">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@chain</span> raw_df <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb3-10">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@subset</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>long <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>)</span>
<span id="cb3-11">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@subset</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>arrPort <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FIHEL"</span>)</span>
<span id="cb3-12">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@select</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>updated, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ata, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>long, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>lat, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>imo)</span>
<span id="cb3-13">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@transform</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Minute</span>.(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>updated), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>long <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zscore</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>long), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>lat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zscore</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>lat))</span>
<span id="cb3-14">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@groupby</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>imo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ata</span>
<span id="cb3-15">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@transform</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">minimum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>t)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">./</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">minimum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>t)))</span>
<span id="cb3-16">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@subset</span>((<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&amp;</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb3-18"></span>
<span id="cb3-19">    df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">groupby</span>(df, [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>imo, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ata])</span>
<span id="cb3-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>load_ship_data (generic function with 1 method)</code></pre>
</div>
</div>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1">df, groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_ship_data</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>(<span class="ansi-bold">94944×7 DataFrame</span>
<span class="ansi-bold">   Row </span>│<span class="ansi-bold"> updated             </span><span class="ansi-bold"> ata                 </span><span class="ansi-bold"> long      </span><span class="ansi-bold"> lat      </span><span class="ansi-bold"> imo   </span> ⋯
<span class="ansi-bold">       </span>│<span class="ansi-bright-black-fg"> DateTime            </span><span class="ansi-bright-black-fg"> DateTime            </span><span class="ansi-bright-black-fg"> Float64   </span><span class="ansi-bright-black-fg"> Float64  </span><span class="ansi-bright-black-fg"> Int64 </span> ⋯
───────┼────────────────────────────────────────────────────────────────────────
     1 │ 2018-05-04T19:26:00  2018-04-05T21:26:00  -0.545055  -1.52547  936472 ⋯
     2 │ 2018-05-04T19:29:00  2018-04-05T21:24:00  -0.615397  -1.47017  936472
     3 │ 2018-05-04T19:33:00  2018-04-05T21:28:00  -0.806885  -1.34498  936472
     4 │ 2018-05-04T19:36:00  2018-04-05T21:26:00  -0.918912  -1.28835  936472
     5 │ 2018-05-04T19:37:00  2018-04-05T21:31:00  -0.974925  -1.25871  936472 ⋯
     6 │ 2018-05-04T19:39:00  2018-04-05T21:30:00  -1.09086   -1.20032  936472
     7 │ 2018-05-04T19:39:00  2018-04-05T21:26:00  -1.10128   -1.19501  936472
     8 │ 2018-05-04T19:41:00  2018-04-05T21:26:00  -1.22112   -1.13661  936472
   ⋮   │          ⋮                    ⋮               ⋮         ⋮         ⋮   ⋱
 94938 │ 2019-12-03T20:06:00  2019-03-12T20:35:00   1.06891    1.07842  936472 ⋯
 94939 │ 2019-12-03T20:07:00  2019-03-12T20:29:00   1.03374    1.1054   936472
 94940 │ 2019-12-03T20:12:00  2019-03-12T20:28:00   1.05458    1.24564  936472
 94941 │ 2019-12-03T20:14:00  2019-03-12T20:26:00   1.09106    1.29386  936472
 94942 │ 2019-12-03T20:16:00  2019-03-12T20:26:00   1.14447    1.33854  936472 ⋯
 94943 │ 2019-12-03T20:19:00  2019-03-12T20:24:00   1.1627     1.3965   936472
 94944 │ 2019-12-03T20:23:00  2019-03-12T20:22:00   1.15358    1.48011  936472
<span class="ansi-cyan-fg">                                                3 columns and 94929 rows omitted</span>, GroupedDataFrame with 18432 groups based on keys: imo, ata
First Group (14 rows): imo = 9364722, ata = 2018-04-05T21:26:00
<span class="ansi-bold"> Row </span>│<span class="ansi-bold"> updated             </span><span class="ansi-bold"> ata                 </span><span class="ansi-bold"> long      </span><span class="ansi-bold"> lat       </span><span class="ansi-bold"> imo    </span> ⋯
<span class="ansi-bold">     </span>│<span class="ansi-bright-black-fg"> DateTime            </span><span class="ansi-bright-black-fg"> DateTime            </span><span class="ansi-bright-black-fg"> Float64   </span><span class="ansi-bright-black-fg"> Float64   </span><span class="ansi-bright-black-fg"> Int64  </span> ⋯
─────┼──────────────────────────────────────────────────────────────────────────
   1 │ 2018-05-04T19:26:00  2018-04-05T21:26:00  -0.545055  -1.52547   9364722 ⋯
   2 │ 2018-05-04T19:36:00  2018-04-05T21:26:00  -0.918912  -1.28835   9364722
   3 │ 2018-05-04T19:39:00  2018-04-05T21:26:00  -1.10128   -1.19501   9364722
   4 │ 2018-05-04T19:41:00  2018-04-05T21:26:00  -1.22112   -1.13661   9364722
  ⋮  │          ⋮                    ⋮               ⋮          ⋮         ⋮    ⋱
  11 │ 2018-05-04T20:40:00  2018-04-05T21:26:00   0.945162   0.413511  9364722 ⋯
  12 │ 2018-05-04T20:47:00  2018-04-05T21:26:00   0.955583   0.609489  9364722
  13 │ 2018-05-04T20:49:00  2018-04-05T21:26:00   0.984241   0.669211  9364722
  14 │ 2018-05-04T20:55:00  2018-04-05T21:26:00   1.10539    0.856341  9364722
<span class="ansi-cyan-fg">                                                    2 columns and 6 rows omitted</span>
⋮
Last Group (1 row): imo = 9364722, ata = 2019-03-12T20:22:00
<span class="ansi-bold"> Row </span>│<span class="ansi-bold"> updated             </span><span class="ansi-bold"> ata                 </span><span class="ansi-bold"> long    </span><span class="ansi-bold"> lat     </span><span class="ansi-bold"> imo     </span><span class="ansi-bold"> t </span> ⋯
<span class="ansi-bold">     </span>│<span class="ansi-bright-black-fg"> DateTime            </span><span class="ansi-bright-black-fg"> DateTime            </span><span class="ansi-bright-black-fg"> Float64 </span><span class="ansi-bright-black-fg"> Float64 </span><span class="ansi-bright-black-fg"> Int64   </span><span class="ansi-bright-black-fg"> Mi</span> ⋯
─────┼──────────────────────────────────────────────────────────────────────────
   1 │ 2019-12-03T20:23:00  2019-03-12T20:22:00  1.15358  1.48011  9364722  -3 ⋯
<span class="ansi-cyan-fg">                                                               2 columns omitted</span>)</pre>
</div>
</div>
</div>
<p>Below, I’ve plotted the trajectories with color marking the passage of time.</p>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scatter</span>(df[!, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>long], df[!, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>lat], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df[!, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nt], markersize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/ships/ships_files/figure-html/cell-6-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The Model</h2>
<p>It seems like there’s more than one standard way of moving between these ports. I make out three different routes; trajectories seem to be scattered around a central curve for each route.</p>
<p>We can model this behavior with a mixture of Gaussian processes. For each of the three different routes above (<img src="https://latex.codecogs.com/png.latex?i=1,2,3">), we’ll assume a function <img src="https://latex.codecogs.com/png.latex?f_i"> mapping time to lattitude and longitude values was sampled from a Gaussian Process prior. Container ships will trajectories will always be close to one of these routes- we just don’t know which one. We’ll also assume that other (non-container) ships follow trajectories sampled independently from the same Gaussian Process prior. To tell if a given trajectory seems to be that of a container ship, we just need to check whether it more closely resembles the posterior mixture of container routes or prior over all possible ship trajectories.</p>
<p>Specifically, let <img src="https://latex.codecogs.com/png.latex?y"> refer to the observed trajectories and <img src="https://latex.codecogs.com/png.latex?y'"> refer to the new trajectory we’re trying to classify. Say <img src="https://latex.codecogs.com/png.latex?B=0"> if <img src="https://latex.codecogs.com/png.latex?y'"> is a container ship and <img src="https://latex.codecogs.com/png.latex?B=1"> otherwise. We want to learn the posterior odds that <img src="https://latex.codecogs.com/png.latex?B=1"> given <img src="https://latex.codecogs.com/png.latex?y"> and <img src="https://latex.codecogs.com/png.latex?y'">, which is just <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BP(y'%20%7C%20y,%20B=1)P(B=1)%7D%7BP(y'%20%7C%20y,%20B=O)P(B=O)%7D">. When <img src="https://latex.codecogs.com/png.latex?B=1">, we can get the likelihood of <img src="https://latex.codecogs.com/png.latex?y'"> by integrating over samples <img src="https://latex.codecogs.com/png.latex?f"> from the posterior GP mixture <img src="https://latex.codecogs.com/png.latex?%5Cint%20P(y'%20%7C%20f)P(f%20%7C%20y)%20%5C,%20df">. When <img src="https://latex.codecogs.com/png.latex?B=0">, we can get the likelihood by integrating over samples <img src="https://latex.codecogs.com/png.latex?g"> from the prior GP: <img src="https://latex.codecogs.com/png.latex?%5Cint%20P(y'%20%7C%20g)P(g)%20%5C,%20dg">.</p>
<p>We don’t know a priori what fraction of the ships in the region are container ships, but to be conservative, we’ll give equal prior probabiliy to <img src="https://latex.codecogs.com/png.latex?B=0"> and <img src="https://latex.codecogs.com/png.latex?B=1">.</p>
</section>
<section id="modeling-sub-trajectories" class="level2">
<h2 class="anchored" data-anchor-id="modeling-sub-trajectories">Modeling Sub-Trajectories</h2>
<p>Ideally, we’d like to identify out-of-distribution ships without having to observe their full port-to-port trajectories. To do this, we can marginalize the likelihood of a trajectory snippet over possible offsets in time.</p>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_logprob</span>(dist, val, t, σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-2">    starts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinRange</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb7-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logsumexp</span>([<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logpdf</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dist</span>(s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> t, σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), val) for s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> starts])</span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>marginal_logprob (generic function with 1 method)</code></pre>
</div>
</div>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ok_prob</span>(t, gp, y1p, y2p, y1, y2)</span>
<span id="cb9-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Find the posterior probability that a ship with longitude/latitude trajectory pairs (`y1`, `y2`) at times `t` is a container ship (with trajectories coming from posterior GPs `y1p` and `y2p`) rather than some other kind of ship (with trajectories coming from prior `gp`).</span></span>
<span id="cb9-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb9-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logistic</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_logprob</span>(y1p, y1, t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_logprob</span>(y2p, y2, t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span></span>
<span id="cb9-5">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_logprob</span>(gp, y1, t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marginal_logprob</span>(gp, y2, t))</span>
<span id="cb9-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>ok_prob (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="approximating-posterior-gp-mixtures" class="level2">
<h2 class="anchored" data-anchor-id="approximating-posterior-gp-mixtures">Approximating Posterior GP Mixtures</h2>
<p>We can’t compute the posterior of a mixture of Gaussian processes analytically. But we can approximate it with mean field variational inference.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?z_i"> be a 1-hot vector giving the route chosen in trajetory <img src="https://latex.codecogs.com/png.latex?i">. I assume <img src="https://latex.codecogs.com/png.latex?z_i%20%5Csim%20%5Ctext%7BCategorical%7D(%5Cpi)">, and <img src="https://latex.codecogs.com/png.latex?%5Cpi%20%5Csim%20%5Ctext%7BDirichlet%7D(%5Calpha_0)">. The variational posterior for <img src="https://latex.codecogs.com/png.latex?%5Cpi"> will be Dirichlet with parameters <img src="https://latex.codecogs.com/png.latex?%5Calpha">.</p>
<p>For the likelihood, I’ll introduce inducing inputs <img src="https://latex.codecogs.com/png.latex?c"> and outputs <img src="https://latex.codecogs.com/png.latex?u_k"> for each route and assume that <img src="https://latex.codecogs.com/png.latex?u_k%20=%20f_k(c)"> and <img src="https://latex.codecogs.com/png.latex?p(y_i%20%7C%20u_k,%20z_%7Bik%7D)%20%20=%20%5Cmathcal%7BN%7D(K_%7Byu%7D%20K_%7Buu%7D%5E%7B-1%7Du,%20Q_%7Byy%7D)"> where <img src="https://latex.codecogs.com/png.latex?Q_%7Byy%7D%20=%20%5Ctext%7Bdiag%7D(K_%7Byy%7D%20-%20K_%7Byu%7DK_%7Buu%7D%5E%7B-1%7DK_%7Buy%7D)%20+%20%5Csigma%5E2I"> (the Fully Indepenent Training Conditional assumption). Let <img src="https://latex.codecogs.com/png.latex?A%20=%20K_%7Byu%7DK_%7Buu%7D%5E%7B-1%7D"> and <img src="https://latex.codecogs.com/png.latex?Q%20=%20%5CLambda%5E%7B-1%7D">. We can pre-calculate the kernel matrices and store them in a separate <code>KernelMats</code> struct for each trajectory. If we were more concered with performance, we would avoid finding <img src="https://latex.codecogs.com/png.latex?K_%7Buu%7D%5E%7B-1%7D"> explicitly, but this is good enough for a blog post.</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1">σ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>0.03</code></pre>
</div>
</div>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> KernelMats</span>
<span id="cb13-2">    Λ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PDiagMat{Float64,Vector{Float64}}</span></span>
<span id="cb13-3">    A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Matrix{Float64}</span></span>
<span id="cb13-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@sizecheck</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernel_mats</span>(kern, x_N, c_U)</span>
<span id="cb14-2">    K_UU_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PDMat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>.(c_U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>, c_U)))</span>
<span id="cb14-3">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assuming stationarity</span></span>
<span id="cb14-4">    K_N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>.(c_U, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reshape</span>(x, (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>))) for x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x_N]</span>
<span id="cb14-5">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> KernelMats[</span>
<span id="cb14-6">        let</span>
<span id="cb14-7">            K_UT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> K_N[n]</span>
<span id="cb14-8">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">KernelMats</span>(</span>
<span id="cb14-9">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PDiagMat</span>(k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(K_UT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (K_UU_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K_UT)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> σ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb14-10">                K_UT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> K_UU_inv)</span>
<span id="cb14-11">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span> for n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N</span>
<span id="cb14-12">    ]</span>
<span id="cb14-13">    (K_UU_inv, c)</span>
<span id="cb14-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>kernel_mats (generic function with 1 method)</code></pre>
</div>
</div>
<p>The variational posterior for inducing points <img src="https://latex.codecogs.com/png.latex?u_k"> will be normal with mean <img src="https://latex.codecogs.com/png.latex?m_k"> and covariance matrix <img src="https://latex.codecogs.com/png.latex?S_k">.</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> VComp</span>
<span id="cb16-2">    S_inv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PDMat{Float64,Matrix{Float64}}</span></span>
<span id="cb16-3">    m1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Float64}</span></span>
<span id="cb16-4">    m2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Float64}</span></span>
<span id="cb16-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<p>Now to figure out the variational updates. We’ll start by deriving the component update for <img src="https://latex.codecogs.com/png.latex?q(z_i)">. From the mean field assumption, we know the ELBO is maximized when <img src="https://latex.codecogs.com/png.latex?%5Clog%20q(z_%7Bik%7D)%20=%20E_q%20%5Clog%20p(y_i%20%7C%20u_k)%20+%20E_q%20%5Clog%20p(z_%7Bik%7D)%20+%20%5Ctext%7Bconst%7D">. As the approximate posterior over <img src="https://latex.codecogs.com/png.latex?%5Cpi"> is Dirichlet, <img src="https://latex.codecogs.com/png.latex?E_q%20%5Clog%20p(z_%7Bik%7D)%20=%20E_q%20%5Cpi_k%20=%20%5Cpsi(%5Calpha_k)%20-%20%5Cpsi(%5Csum_j%20%5Calpha_j)">. It remains to find</p>
<p><img src="https://latex.codecogs.com/png.latex?E_q%20%5Clog%20p(y_i%20%7C%20u_k)%20=-%5Cfrac%7B1%7D%7B2%7D%20E_q%20(y-Au_k)%5CLambda%20(y-Au_k)%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Clog%20%7C%5CLambda%7C"></p>
<p>Expanding the quadratic term lets us compute the expectation:</p>
<p><img src="https://latex.codecogs.com/png.latex?-2%20y%5ET%5CLambda%20A%20m_k%20+%20y%5ET%5CLambda%20y%20+%20%5Ctext%7BTr%7D(E%5Bu_ku_k%5ET%5D)A%5ET%20%5CLambda%20A"> <img src="https://latex.codecogs.com/png.latex?=%20-2%20y%5ET%5CLambda%20A%20m_k%20+%20y%5ET%5CLambda%20y%20+%20%5Ctext%7BTr%7D(m_km_k%5ET%20+%20S_k)A%5ET%20%5CLambda%20A"> <img src="https://latex.codecogs.com/png.latex?=%20-2%20y%5ET%5CLambda%20A%20m_k%20+%20y%5ET%5CLambda%20y%20+%20%5Ctext%7BTr%7D(S_kA%5ET%20%5CLambda%20A)%20+%20m_k%5ETA%5ET%5CLambda%20A%20m_k"> <img src="https://latex.codecogs.com/png.latex?=%20(y%20-%20Am_k)%5ET%5CLambda%20(y%20-%20A%20m_k)%20+%20%5Ctext%7BTr%7D(S_kA%5ET%20%5CLambda%20A)"></p>
<p>We can eliminate terms like <img src="https://latex.codecogs.com/png.latex?%5Cpsi(%5Csum_j%20%5Calpha%20_j)"> and <img src="https://latex.codecogs.com/png.latex?%5Clog%20%7C%20%5CLambda%20%7C"> which are the same for all components. The result is an expression for <img src="https://latex.codecogs.com/png.latex?q(z_i%20=%20k)">, which I’ll write as <img src="https://latex.codecogs.com/png.latex?r_%7Bik%7D">.</p>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">responsibilities</span>(y1, y2, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{KernelMats}</span>, o, alpha)</span>
<span id="cb17-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Calculate r_ik for seeing `(y1, y2)` for each component in `o`"</span></span>
<span id="cb17-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector</span>{<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>}[</span>
<span id="cb17-4">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">softmax</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">isnothing</span>(og) ? <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf64</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> let</span>
<span id="cb17-5">            μ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> og.m1</span>
<span id="cb17-6">            μ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> og.m2</span>
<span id="cb17-7">            V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> og.S_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> (cn.A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cn.Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cn.A)</span>
<span id="cb17-8">            q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quad</span>(cn.Λ, y1n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> μ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quad</span>(cn.Λ, y2n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> μ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb17-9">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span>(V) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">digamma</span>(alpha_g)</span>
<span id="cb17-10">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span> for (og, alpha_g) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(o, alpha)])</span>
<span id="cb17-11">        for (cn, y1n, y2n) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(c, y1, y2)]</span>
<span id="cb17-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>responsibilities (generic function with 1 method)</code></pre>
</div>
</div>
<p>Next, let’s calculate the inducing point variational parameters. From the mean field assumption, the ELBO is maximized when</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Clog%20q(u_k)%20=%20%5Csum_i%20E_q%201_%7Bz_i%20=%20k%7D%20%5Clog%20%20p(y_i%20%7C%20u_k,%20z_i%20=%20k)%20+%20%5Clog%20p(u_k)%20+%20%5Ctext%7Bconst%7D"> <img src="https://latex.codecogs.com/png.latex?=%20%5Csum_i%20r_%7Bik%7D%20(%5Clangle%20u_ku_k%5ET,%20A%5ET%5CLambda%20A%20%5Crangle%20+%20%5Clangle%20%5CLambda%20A%20u_k,%20y_i%20%5Crangle)%20+%20%5Clangle%20u_ku_k%5ET,%20K_%7Buu%7D%5E%7B-1%7D%20%5Crangle%20+%20%5Ctext%7Bconst%7D"></p>
<p>By combining like terms, we can see that <img src="https://latex.codecogs.com/png.latex?S_k%5E%7B-1%7D%20=%20K_%7Buu%7D%5E%7B-1%7D%20+%20%5Csum_i%20r_%7Bik%7D%20A%5ET%20%5CLambda%20A"> and <img src="https://latex.codecogs.com/png.latex?S_k%5E%7B-1%7Dm_k%20=%20%5Csum_i%20r_%7Bik%7D%20A%5ET%20%5CLambda%20y_i">.</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_gp</span>(g, K_UU_inv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PDMat{Float64,Matrix{Float64}}</span>, r, y1, y2, c)</span>
<span id="cb19-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(rn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> rn[g], r) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-8</span></span>
<span id="cb19-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb19-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb19-5">    S_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> K_UU_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PDMat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(rn[g] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Xt_A_X</span>(cn.Λ, cn.A) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (rn, cn) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(r, c) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> rn[g] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb19-6">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(rn[g] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cn.A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (cn.Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> yn) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (rn, cn, yn) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(r, c, y1))</span>
<span id="cb19-7">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(rn[g] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cn.A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (cn.Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> yn) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (rn, cn, yn) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(r, c, y2))</span>
<span id="cb19-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VComp</span>(S_inv, m1, m2)</span>
<span id="cb19-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>fit_gp (generic function with 1 method)</code></pre>
</div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_gps</span>(K_UU_inv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PDMat{Float64,Matrix{Float64}}</span>, r, y1, y2, c)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Union{Nothing,VComp}}</span></span>
<span id="cb21-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Union</span>{VComp,<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Nothing</span>}[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_gp</span>(g, K_UU_inv, r, y1, y2, c) for g <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(r[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])]</span>
<span id="cb21-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>fit_gps (generic function with 1 method)</code></pre>
</div>
</div>
<p>Finally, we get to the mixture weight paramers. As before,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Clog%20q(%5Cpi)%20=%20%5Clog%20p(%5Cpi)%20+%20E%20%5Clog%20p(z_i%20%7C%20%5Cpi)%20+%20%5Ctext%7Bconst%7D"> <img src="https://latex.codecogs.com/png.latex?=%20%5Clangle%20%5Calpha_0%20-%201,%20%5Cpi%20%5Crangle%20+%20%5Csum_i%20%5Clangle%20r_i,%20%5Cpi%20%5Crangle"></p>
<p>This gives <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%20%5Calpha_0%20+%20%5Csum_i%20r_i">.</p>
<p>Putting everything together gives the following variational inference algorithm.</p>
<p>This uses an auxiliary function to compute fixed points.</p>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fixedpoint</span>(f, arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">T</span>; iters<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {T}</span>
<span id="cb23-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>iters</span>
<span id="cb23-3">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(arg)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">T</span></span>
<span id="cb23-4">        max_diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximum</span>(abs, result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> arg)</span>
<span id="cb23-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> max_diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span></span>
<span id="cb23-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span>
<span id="cb23-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb23-8">        arg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result</span>
<span id="cb23-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb23-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">println</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DID NOT CONVERGE"</span>)</span>
<span id="cb23-11">    arg</span>
<span id="cb23-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>fixedpoint (generic function with 1 method)</code></pre>
</div>
</div>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@sizecheck</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_mixture</span>(kern, alpha0, x_N, y1_N, y2_N, z_M, o; iters<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb25-2">    K_MM_inv, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernel_mats</span>(kern, x_N, z_M)</span>
<span id="cb25-3">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fixedpoint</span>(alpha0; iters) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> alpha</span>
<span id="cb25-4">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">responsibilities</span>(y1_N, y2_N, c, o, alpha)</span>
<span id="cb25-5">        o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_gps</span>(K_MM_inv, r, y1_N, y2_N, c)</span>
<span id="cb25-6">        alpha0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(r)</span>
<span id="cb25-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb25-8">    alpha, c, o</span>
<span id="cb25-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>fit_mixture (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="example-on-synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="example-on-synthetic-data">Example on Synthetic Data</h2>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1">kern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_lengthscale</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Matern52Kernel</span>(), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Matern 5/2 Kernel (metric = Distances.Euclidean(0.0))
    - Scale Transform (s = 10.0)</code></pre>
</div>
</div>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1">T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>100</code></pre>
</div>
</div>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>100</code></pre>
</div>
</div>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1">π_prior <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dirichlet</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Distributions.Dirichlet{Float64, Vector{Float64}, Float64}(alpha=[5.0, 5.0, 5.0])</code></pre>
</div>
</div>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1">gp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(kern)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>GP{ZeroMean{Float64}, TransformedKernel{Matern52Kernel{Distances.Euclidean}, ScaleTransform{Float64}}}(ZeroMean{Float64}(), Matern 5/2 Kernel (metric = Distances.Euclidean(0.0))
    - Scale Transform (s = 10.0))</code></pre>
</div>
</div>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Xoshiro</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Xoshiro(0x31c0fdb77e6b079f, 0xf8bbbedb8c20d31c, 0x1c19355ea0d34d01, 0x402b368a357b9496, 0x69a0c2eabd4f1212)</code></pre>
</div>
</div>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">pi</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(π_prior)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3-element Vector{Float64}:
 0.36892846174002913
 0.38153355876999534
 0.24953797948997547</code></pre>
</div>
</div>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1">(true_f, y1_N, y2_N, x_N) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span></span>
<span id="cb41-2">    x_T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinRange</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, T)</span>
<span id="cb41-3">    true_f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(rng, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gp</span>(x_T), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) for _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb41-4">    noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [σ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(T, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) for _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N]</span>
<span id="cb41-5">    z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(rng, Distributions.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Categorical</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">pi</span>), N)</span>
<span id="cb41-6">    y_T2N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stack</span>(true_f[z] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> noise)</span>
<span id="cb41-7">    y1_N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(y_T2N[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>])</span>
<span id="cb41-8">    y2_N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(y_T2N[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>])</span>
<span id="cb41-9">    x_N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x_T for _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N]</span>
<span id="cb41-10">    (true_f, y1_N, y2_N, x_N)</span>
<span id="cb41-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([[0.39940744485764307 0.781570857858878; 0.512664898939086 0.9316931016687168; … ; 1.5971325077761558 0.384910967509904; 1.582860813305773 0.3279274081244852], [-0.472291406780798 -0.31707101959464334; -0.5771870148169773 -0.151971382440848; … ; 0.956562978197726 -0.04504026546424312; 0.8338497795432375 -0.07039399921429594], [1.7847815717824167 0.2774961462911457; 1.884786093600304 0.24311245888699062; … ; 0.4102229023901559 0.45159679562935084; 0.49950707039911835 0.5780682109962041]], SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}[[0.3700879617376666, 0.47788108272999624, 0.5525052930328936, 0.5676365000476474, 0.600580781383119, 0.656945621953472, 0.6775837278595784, 0.6881661800554684, 0.5653046086360503, 0.4880848580064354  …  1.7852554741039721, 1.7631940807466238, 1.7866280687546399, 1.6855743542791397, 1.633295886410844, 1.5593140529511285, 1.5809315473099828, 1.5850692917905742, 1.5749665860994762, 1.5334497225603498], [-0.4211210630553008, -0.6285051132552908, -0.6227617039329616, -0.8708783039278554, -0.9826350021129571, -1.1425221312002887, -1.2456052275455118, -1.339157460801622, -1.3290334978511795, -1.2908546745738376  …  1.7440585177057981, 1.642796584537638, 1.5471585069379599, 1.4042550243933754, 1.273922733201116, 1.2097211725456494, 1.1401774243829077, 1.0330166219774146, 0.9774660463719848, 0.8694560989261199], [-0.44252855724920725, -0.5767173309396507, -0.7518329940704416, -0.8264096060580315, -0.9813279633871161, -1.0735124841508843, -1.2444212804907984, -1.3061050624555488, -1.3969219450012467, -1.303032688942919  …  1.7683495188197973, 1.6419402128662237, 1.5761334309833228, 1.3606435788261928, 1.224679012415514, 1.1808031839489388, 1.1440982686727479, 1.038392382871553, 0.9647433487335163, 0.8530716930658208], [-0.47473269079831315, -0.5615750444633624, -0.7183606354693861, -0.8867156543723269, -0.9749576028015003, -1.1542788066262792, -1.189686860068581, -1.2503907540431287, -1.3637508843511998, -1.2417064682862893  …  1.7444528889141617, 1.6338139567309706, 1.5221667857459085, 1.3851123960074552, 1.2918327829204133, 1.1962757171128644, 1.1486952037078746, 1.034241253576947, 0.9431906285244502, 0.8771208457572213], [0.36494672244837023, 0.505601088156253, 0.5419318915414362, 0.6390307602149727, 0.6699930478719739, 0.6380325617871504, 0.7000116125595375, 0.619618434365539, 0.6466087167325566, 0.4645811083735421  …  1.7772023639080774, 1.7879075341332262, 1.8234619091398676, 1.624647272462175, 1.595123486550642, 1.5823015283466466, 1.6018578158912113, 1.5445446904908762, 1.5804156908057965, 1.5874978731660736], [-0.45829387216263934, -0.5845683157765975, -0.7693263706843804, -0.8577174415492629, -0.8834134626113572, -1.0496103351531525, -1.2095788920673365, -1.3298190726797585, -1.3324800229270173, -1.2100700907652808  …  1.8267688543625462, 1.6884903757111873, 1.4990146493192344, 1.3954822052838494, 1.2625187306115169, 1.2072624049503318, 1.1245814546757065, 1.0427897663355867, 0.9501295786797349, 0.8557545395659737], [0.3911978212505599, 0.47390431099975877, 0.5172472721731246, 0.6005713954613187, 0.6564877516019645, 0.7428362817154499, 0.6849315350068836, 0.6893463560608264, 0.6005205136139856, 0.516664551994273  …  1.742633293786382, 1.783338177103919, 1.7520259940736869, 1.6961588834929628, 1.6145302208050327, 1.5889162342065626, 1.5491919318064642, 1.6088224008108758, 1.6238059225322634, 1.6468580894377165], [-0.4991119968068169, -0.6049268868041415, -0.7045121931024152, -0.8772407092667843, -1.0096857469337286, -1.125173412712578, -1.2041341694080048, -1.3813047339822273, -1.3517693973120835, -1.2406432132068899  …  1.7890062258542998, 1.688037354400058, 1.55065835081178, 1.373678310091426, 1.2882506966993172, 1.1985096174552177, 1.170421838865118, 1.073173545610662, 0.9302561089260525, 0.8343017204831965], [1.7786400304805892, 1.932975938351668, 2.027516057090291, 2.0033981296517247, 2.0128784398831536, 1.9631861753128486, 1.88461564254782, 1.6353303715807372, 1.4095268547439055, 1.1729328342054135  …  0.07080188064212697, 0.012460862800967806, -0.003860472673403812, -0.027792527897081892, 0.041006054523241325, 0.07233487412832193, 0.13337486155989425, 0.2976129483379553, 0.38809138003591453, 0.4717183474687341], [-0.44791149133422614, -0.5810326796431938, -0.7487286401181614, -0.7742755300049207, -0.9809947843833565, -1.0816424737325367, -1.2030786640396176, -1.3559847041836666, -1.3741457632277978, -1.2648118142953142  …  1.7811394294186476, 1.631426421683647, 1.5579500986578252, 1.4672048846444257, 1.2712351531963988, 1.1810396356652466, 1.1468560415074445, 1.0999079643321066, 0.9236696931355612, 0.7942863307502518]  …  [-0.44594578234679483, -0.5964229389200998, -0.7157235648306179, -0.8420088977395895, -0.9939481689585593, -1.0712170449386966, -1.1831352801992991, -1.3793831458908126, -1.3668583344846437, -1.2624021712766755  …  1.7030451330999403, 1.6588017752536302, 1.512757674357593, 1.4013957525922651, 1.250702904939713, 1.2121393136416265, 1.0744324286427764, 1.0620879318473355, 0.9283018855601111, 0.8801629156596172], [-0.5047967910591429, -0.5466362008552932, -0.6642314745302432, -0.8665718388130023, -0.9770433234279923, -1.082748196037504, -1.2445321491565609, -1.3428682755147545, -1.37176085369222, -1.2222335484676774  …  1.7362298140257617, 1.6248308007159942, 1.5876133909496646, 1.3805173346437243, 1.2983694600460338, 1.1636778226273061, 1.1590428012588874, 1.0828843878659404, 0.9812034152139966, 0.8281145968431958], [0.3864372145405262, 0.47506544453546246, 0.5790311319771552, 0.605001195666856, 0.6642869684695955, 0.6572596859911383, 0.6458185110626002, 0.6932787719655424, 0.5834768194374723, 0.4210018183812101  …  1.825359709436106, 1.7637870052307099, 1.7882698835578315, 1.6336417412945545, 1.5968288216523252, 1.5397504369174955, 1.5972296799671601, 1.5732473167653882, 1.5750034773116124, 1.6086170561222364], [1.7652791784827582, 1.8992601889650986, 1.952025741075971, 1.975228312896439, 2.0285127685927513, 1.9170691010660572, 1.7523626215932344, 1.588547282576697, 1.4568152531165184, 1.11160332392917  …  0.05493937081390281, 0.049141727865529075, 0.00161747946027661, -0.04965613318054553, -0.03803713447194219, 0.10903602769992818, 0.1927704678808896, 0.2850016776623056, 0.4188130112268084, 0.4810023570547357], [0.4568436560110791, 0.48120454594583395, 0.571062776775225, 0.5952367679609637, 0.67959854911344, 0.6639152098144613, 0.6926944303221002, 0.6707664681350729, 0.624327313587915, 0.49367900246722796  …  1.7248769135622033, 1.7988909358878185, 1.7055663411581536, 1.7091054868956446, 1.5445615111365127, 1.6105424278886316, 1.6073818339426091, 1.558477019335945, 1.6083236847122333, 1.6061616139075827], [-0.4835813560919496, -0.5942356617704319, -0.6934005695853287, -0.8737173243718228, -0.9896088391321894, -1.1117975171234642, -1.1945413835901322, -1.319212417107135, -1.3414057714347458, -1.2392607356840089  …  1.7528161969646778, 1.6924694705607917, 1.5367129548531426, 1.3953555090582246, 1.2449245129761877, 1.2448055522759653, 1.1313157873096107, 1.0911204298246533, 0.9820455857015086, 0.8369014421300336], [-0.47315145964374994, -0.6072952347887302, -0.701880445688005, -0.8913588489475074, -0.9723306840541012, -1.1048488413578572, -1.2281168567356953, -1.3370998069464055, -1.345697912763073, -1.2529732938260187  …  1.8102388083417889, 1.6157632299169338, 1.5118503776166272, 1.4049830864638395, 1.2451653591009686, 1.2040886523321568, 1.1649931662817816, 1.1058982705777327, 0.9798737421629538, 0.8557887184426698], [1.7816870699107052, 1.8537112521580037, 1.976950190984634, 1.986261857263395, 2.021509615944646, 2.005696075937408, 1.8123978064589177, 1.6048856037735737, 1.41076537382959, 1.1644426850695577  …  0.057427651456858686, 0.028476859108208852, 0.0058752637035537035, -0.019816606578055063, -0.05569232459204474, 0.14836624405061954, 0.18946405785437778, 0.3061126113781384, 0.4227092896828641, 0.49661083058849514], [-0.5233359997666176, -0.5645079977227427, -0.6811099898375295, -0.8130532288194817, -0.9635666569689258, -1.1034908626409008, -1.2013648271891462, -1.3153184932607274, -1.3492353730582967, -1.325160707906475  …  1.7799405339485965, 1.6420547516008175, 1.5807903035712507, 1.4081405505375408, 1.2825112685705002, 1.244780947058204, 1.0927230918227466, 1.148161555289747, 0.9339069566655267, 0.8397286373318037], [-0.480714146455318, -0.5902724390160647, -0.6741421716500787, -0.8094161433217102, -0.9780975130073811, -1.0542478765511951, -1.213235664986352, -1.3681628231299032, -1.267384648323656, -1.2456436388976502  …  1.762646039608105, 1.6014173787887998, 1.563066220405517, 1.3719650753744121, 1.2539148216557845, 1.1904511189212659, 1.1052689281117576, 1.124542482409055, 0.9413495117813608, 0.8523346180358521]], SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}[[0.8026667343773839, 0.9272374973895329, 1.1127739414618427, 1.1850772393095752, 1.3755161827643632, 1.5145110873441292, 1.5451907301923051, 1.6238314911980516, 1.7107084933276706, 1.6891266615139446  …  0.37705151045419133, 0.3970301134461245, 0.5406376063300915, 0.571561218068671, 0.6800069366790182, 0.6246300248434518, 0.5549571657924839, 0.4845750398315211, 0.4444632386688463, 0.3065966944421674], [-0.3511202590582168, -0.1394202595527906, -0.01592128257509561, 0.11456141792709228, 0.20546059628586333, 0.22156494914935, 0.22615040939683548, 0.09025338096872909, 0.182187630160484, -0.005985131923862824  …  0.9453481027904888, 0.840024046255369, 0.7933974937600053, 0.6098280496150628, 0.45261882673612297, 0.28363201452859776, 0.1761962510005486, 0.044366780231433076, -0.042824779486057486, -0.07321518270210282], [-0.3316590172562221, -0.12882551009709525, 0.014541497404227253, 0.07032042159061222, 0.2176387514998076, 0.1811778304305366, 0.16815037466155341, 0.1407701910457701, 0.0996079066868828, -0.02930677781917293  …  0.9493178932539263, 0.8902953306505575, 0.7558815763551197, 0.6232956457134926, 0.4624333195116825, 0.27285330599692004, 0.13070915954548842, 0.06284622293823146, -0.044645324121477765, -0.08316048793996679], [-0.3061132070781288, -0.18746915091063898, -0.0037156318009084863, 0.11477712248293126, 0.14178840135194523, 0.19457909414717062, 0.1955899805257978, 0.11467999852483013, 0.11595901240894115, 0.022845111590977667  …  0.9469114758188042, 0.833763050840117, 0.7458581706309779, 0.5551756175360192, 0.4739637556591287, 0.29179344911648075, 0.16481176509486664, 0.06225125282634908, -0.04991623542449028, -0.05926327822357183], [0.7542643532313039, 0.9381647159092591, 1.0572712378171865, 1.230254771632905, 1.4011319305296153, 1.450573926965493, 1.52631013974342, 1.5834123511215288, 1.6286189371679543, 1.6881582903149  …  0.42886155919053387, 0.43128489920801094, 0.4842915816963676, 0.5582992436597269, 0.6702241932135719, 0.6383303005842197, 0.6041011943044065, 0.45254403753246025, 0.40008280432257515, 0.3345193631040302], [-0.33971839622565775, -0.18497161908851448, 0.012290318908119165, 0.03893645767118309, 0.1462335973747323, 0.2486427659633012, 0.18025218264555226, 0.15180563377655565, 0.129006648407872, 0.04482222095069195  …  0.9809957348161344, 0.8749881080800541, 0.746274443026718, 0.5541425643246481, 0.4625891124459483, 0.32162274339713603, 0.1872853342094712, 0.06036664390304627, -0.03680231544771183, -0.049510137247818095], [0.8070002191587647, 0.9442913066249085, 1.1302769386697824, 1.2081967521746397, 1.3356914974758014, 1.5223766554137672, 1.5909753470138102, 1.627331547618399, 1.6511501976480922, 1.6689231102993827  …  0.40538984256155297, 0.42861193633673994, 0.5015969281072589, 0.5311856631469392, 0.6674954615231076, 0.5965903598553703, 0.5566369513333743, 0.48324093467948537, 0.4311549502042953, 0.39076973414700705], [-0.28480705916843696, -0.10625315182533043, 0.024785261879050544, 0.07641654517612127, 0.1552347330393129, 0.21467197524252887, 0.214388936776746, 0.17167367047308044, 0.08858284863844713, -0.003576561190596985  …  1.0149570354303759, 0.9116976342059242, 0.8239318219863443, 0.6096597989327066, 0.48176526860875346, 0.32314738554439126, 0.16730003837914675, 0.08077671698648625, -0.07390351923490435, -0.05204669294629327], [0.28648197660419655, 0.20155607654827692, 0.26083569673153795, 0.36486042972579297, 0.47696577741860846, 0.5728627677913581, 0.7118394193366427, 0.8165500345643881, 0.8503989847697979, 0.8896777697420456  …  -1.4056923559021057, -1.3446808615941683, -1.1687235246679424, -0.8896726010400444, -0.5328105301816746, -0.21166465673454016, 0.032554311108303965, 0.2512420002094242, 0.40613003452988733, 0.5554062118802982], [-0.31588359240943087, -0.17187403815816005, -0.02484289353469079, 0.08707994300917316, 0.18861032983524167, 0.23601727846431259, 0.1828979770636666, 0.1949405573686691, 0.0929478161486642, 0.020004547787449693  …  0.9620080749546955, 0.8869241610481053, 0.7259735088196013, 0.5693908342304073, 0.4573272244950232, 0.29148148550445485, 0.1222081972384219, 0.02596855804006122, -0.04126537469085773, -0.08653472746798775]  …  [-0.35705120321208633, -0.20901635372498298, 0.02321892186912369, 0.11576829504557906, 0.14650371450550775, 0.20303895815636624, 0.24571110676730512, 0.11440248690470649, 0.07691455144487752, -0.010704949465951612  …  1.0079343494149848, 0.8639592791616786, 0.6989091242862185, 0.5875322078162816, 0.4186520837850273, 0.2654176591290303, 0.1682257940773366, 0.06676302288135211, -0.044769623955030355, -0.0788874095146267], [-0.279904108877613, -0.12295700233805448, 0.0071024562964638795, 0.08351957396009985, 0.1917727970633079, 0.1922179072599698, 0.19007885524486368, 0.11830436120149257, 0.11410074376829943, 0.01998378576031322  …  0.9492839117247923, 0.8589391035144648, 0.7319842854719563, 0.6128710414693419, 0.4817199565533437, 0.3135326814014038, 0.16696709064644785, 0.09259594733545032, -0.059887950660281526, -0.06310514982217307], [0.7485885481532815, 0.9496278327723022, 1.1355736085922767, 1.1970508579770986, 1.3664900305228709, 1.4789190585922352, 1.5562589096163317, 1.6778939629468463, 1.6972443353143774, 1.6889220543113057  …  0.37479976199667936, 0.47511857681857794, 0.5105806160436273, 0.5383790314420341, 0.6217977166256058, 0.6870037921444523, 0.5882077526873921, 0.4640753689514396, 0.3691364274267584, 0.32346671203108546], [0.28218547921788467, 0.25852326560035777, 0.24804168349375058, 0.34035215679584213, 0.48332091491032664, 0.6810745307736549, 0.7397047752201192, 0.8227716054680719, 0.9051939537338954, 0.9101865057623911  …  -1.412996682530946, -1.3325410232299726, -1.182947548555859, -0.8412079171641019, -0.5041422949557393, -0.16769397982582562, 0.10509389309414877, 0.33998724966109944, 0.5023973081720233, 0.5688581438571654], [0.7101443419242278, 0.92537579827458, 1.0610646275627824, 1.208902483146923, 1.4000777462059244, 1.4894610567046778, 1.5644128089198555, 1.621089004697623, 1.6888913837865571, 1.6464733511232061  …  0.3456885315155104, 0.4596129940542724, 0.491276304574797, 0.5198203237315869, 0.655724814227794, 0.693713107801062, 0.5775682053959397, 0.5010802378190798, 0.35285324550080654, 0.3119044310686243], [-0.36306238962978576, -0.12389784539665918, -0.03267561160049834, 0.07582850937766375, 0.19309351607550818, 0.22632673439955503, 0.22787902916734107, 0.18175550402040694, 0.06540796199682547, 0.04787935917086694  …  0.9164575597690792, 0.8931848866429338, 0.7148653413134657, 0.6040060300793832, 0.5191080406576657, 0.30390468880288385, 0.16387312554123587, 0.06095543112877319, -0.07994270150037766, -0.05720146267407376], [-0.32410490682718823, -0.1417689843419464, 0.04179619775600474, 0.16226839463733644, 0.21713888548744123, 0.2649215807550171, 0.20120446679707107, 0.17468738952420917, 0.10792588917593836, -0.01579405559071982  …  0.9321369006252102, 0.8769783256543988, 0.7465564760762197, 0.6192597526582085, 0.49699952114827506, 0.3324812875687691, 0.1674177074005299, 0.08781208984408945, -0.09395454139673826, -0.12054932874179738], [0.29020548407997343, 0.24367041136655856, 0.3140377175581981, 0.326030813256892, 0.4922290250390344, 0.69727486316066, 0.6715321969219319, 0.8220146448200999, 0.8571048995855263, 0.9569098957853442  …  -1.4085410061936572, -1.3139630581712771, -1.144940546367433, -0.8649584777180653, -0.5340106625375828, -0.15799823192358955, 0.10376369727576212, 0.3235305289744173, 0.4729629138433807, 0.6080658146372319], [-0.31922898415091433, -0.1277049942711259, -0.03651236916001316, 0.13697856902367483, 0.17011585663299533, 0.21585601992290315, 0.23131615828652724, 0.18219613085112296, 0.06861156243141214, 0.03269045900839065  …  0.9650255147908333, 0.9013952849286737, 0.7903142815081935, 0.602727673045968, 0.4284457361412203, 0.2691222965999577, 0.17383127894830167, 0.02768397406416313, -0.0550293602895119, -0.06250077994127747], [-0.30763151538794775, -0.11112087217424535, -0.04011655123221196, 0.1299296495772406, 0.15642780439202808, 0.20332251240533103, 0.23625236030045538, 0.14377374782200086, 0.06136200192502247, 0.009558288951302969  …  0.9637535656666396, 0.895903950309292, 0.7115397197932328, 0.6059992603639028, 0.40487763604619487, 0.29276415532274447, 0.17868614362400462, 0.07885875761328787, -0.044904922656329685, -0.07785071961322676]], LinRange{Float64, Int64}[LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100)  …  LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100), LinRange{Float64}(0.0, 1.0, 100)])</code></pre>
</div>
</div>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1">c_U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinRange</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>25-element LinRange{Float64, Int64}:
 0.0, 0.0416667, 0.0833333, 0.125, …, 0.875, 0.916667, 0.958333, 1.0</code></pre>
</div>
</div>
<p>To kick off variational inference, we’ll need to guess starting parameters for <img src="https://latex.codecogs.com/png.latex?S_k"> and <img src="https://latex.codecogs.com/png.latex?m_k">.</p>
<div id="52" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1">o_guess <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span></span>
<span id="cb45-2">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gp</span>(c_U, σ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb45-3">    K_UU_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PDMat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>.(c_U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>, c_U)))</span>
<span id="cb45-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Union</span>{<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Nothing</span>,VComp}[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VComp</span>(K_UU_inv, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(rng, f), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(rng, f)) for _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb45-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3-element Vector{Union{Nothing, VComp}}:
 VComp([7.454870343138737 -12.085564351326695 … -4.395025867196253e-8 1.0695053577639308e-8; -12.085564351326695 27.047547206323763 … 1.8060921559003263e-7 -4.395025867240513e-8; … ; -4.395025867196253e-8 1.8060921559003263e-7 … 27.04754720632348 -12.085564351326603; 1.0695053577639308e-8 -4.395025867240513e-8 … -12.085564351326603 7.454870343138712], [-0.32979921047879956, -0.5897305605112932, 0.11447706895399364, 1.029017128451943, 1.0599601362252413, 0.5111666085710849, 0.07907917386581927, 0.2877821470816543, 0.6470354741278084, 1.4784262694762869  …  -0.5740153604150344, -0.5371827926948518, -0.7993928322576462, -0.5568548810814099, -1.1369227588787811, -1.798383746675905, -1.2631768279691984, -0.7743985404177847, -0.5390795325431714, 0.46438075009635527], [0.43883495716887116, 0.9848746247385155, 0.9515814521504622, 0.7643492693358623, 0.5271321278211968, 0.4894869429738167, 0.8325602734008992, 1.3088984166300248, 1.8516330253814923, 1.8097893768525444  …  -1.2254495200013993, -0.9601158375877539, -0.46840313165530256, -0.46897044443131936, -0.48417534075567253, -0.5578469644611623, -1.0491654256770087, -1.4257330683614824, -0.8617948360702556, 0.017421172919114353])
 VComp([7.454870343138737 -12.085564351326695 … -4.395025867196253e-8 1.0695053577639308e-8; -12.085564351326695 27.047547206323763 … 1.8060921559003263e-7 -4.395025867240513e-8; … ; -4.395025867196253e-8 1.8060921559003263e-7 … 27.04754720632348 -12.085564351326603; 1.0695053577639308e-8 -4.395025867240513e-8 … -12.085564351326603 7.454870343138712], [-0.7744159166454945, -1.2601807812167034, -0.9958548872815728, -0.17653467402440767, 0.9430594849897121, 2.0105500724949295, 2.033124578960417, 1.8565564339339036, 1.8221137639819547, 1.1363083966179663  …  0.15448540477257527, 0.41259110078244066, -0.0027348811068554422, 0.19620549642147278, 0.8763233073663659, 1.3773182347415502, 1.2869812975779953, 0.7746707958819704, -0.022812002763165848, -0.5813990084339119], [0.7846997214502921, 0.9282255890427066, 0.9645535603585261, 0.6532360444039843, 0.3532747775171625, -0.06511150394942444, 0.38443523877237284, 0.9039526689577165, 0.8965788941631468, 0.3359702471738463  …  -0.34629481463918804, -0.8349062772444377, -0.5182156620975424, -0.044966742684170016, 0.5312907147853932, 0.5535393563291215, 0.9294317565413944, 1.479226205158952, 1.5475181642383982, 0.8477215849890636])
 VComp([7.454870343138737 -12.085564351326695 … -4.395025867196253e-8 1.0695053577639308e-8; -12.085564351326695 27.047547206323763 … 1.8060921559003263e-7 -4.395025867240513e-8; … ; -4.395025867196253e-8 1.8060921559003263e-7 … 27.04754720632348 -12.085564351326603; 1.0695053577639308e-8 -4.395025867240513e-8 … -12.085564351326603 7.454870343138712], [1.7486689273216505, 2.4259674782795706, 2.23590574897882, 1.3197002380068752, 0.15255298167106107, -0.13640229167983647, -0.2978069479132432, -0.2357749372929084, -0.480667401701669, -0.3200016176917847  …  0.30610173054220047, 0.7773459629412118, 0.6983570030055796, 0.3619794114301518, 0.23999594112184505, -0.1174427074074989, -0.750398403767938, -1.5117006503169192, -1.4472670583060792, -1.0947027562950333], [0.6884887829721742, 1.0012706667133673, 1.4795170415409875, 1.1715523761660434, 1.059851802972681, 0.47428421889003575, 0.5799475934607595, 1.2958003220887966, 1.4223610253305643, 1.4728308154550735  …  -0.37139044454526404, 0.48014979684391895, 0.39591942033965993, -0.49328143269907426, -0.18136582469922452, 0.2431903591430569, 0.4586852603345645, -0.24386642954148235, -0.6263680839326332, -0.6205153515060421])</code></pre>
</div>
</div>
<div id="54" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1">_, c, o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_mixture</span>(kern, π_prior.alpha, x_N, y1_N, y2_N, c_U, o_guess; iters<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([33.0, 42.0, 40.0], KernelMats[KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964])  …  KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964]), KernelMats([1111.111111111111 0.0 … 0.0 0.0; 0.0 338.3030875290355 … 0.0 0.0; … ; 0.0 0.0 … 338.30308752883224 0.0; 0.0 0.0 … 0.0 1111.1111111071364], [0.9999999999999987 -5.1769817281390405e-15 … -2.0285485224130183e-19 5.1985138724645184e-20; 0.7242230000833083 0.38463921309029714 … 5.850640797546697e-10 -1.4237212403844214e-10; … ; -1.423721240887343e-10 5.850640799372934e-10 … 0.38463921309030774 0.7242230000833062; 6.253485430900889e-22 -1.036291871406433e-20 … 3.552713678800501e-15 0.9999999999999964])], Union{Nothing, VComp}[VComp([38046.26445509075 5325.464176322597 … 8.006537288460481e-5 -2.1740008405797687e-5; 5325.464176322597 62727.21482930112 … -0.00029091409508395566 8.006537289784688e-5; … ; 8.006537288460481e-5 -0.00029091409508395566 … 62727.214828988595 5325.464176318087; -2.1740008405797687e-5 8.006537289784688e-5 … 5325.464176318087 38046.264454973796], [1.7884384433739497, 2.0078691637258808, 1.3336730045136205, 0.27314880593905083, 0.11717217357332622, 0.7608730047237832, 1.418507139298858, 1.5047548465666285, 1.2232513340114586, 0.5870425288598827  …  -0.5090363917647711, 0.4159266785825978, 1.142011701120123, 0.3991566630081422, -0.03828048002571067, 0.45909901400871095, 0.30936063082589194, 0.003078292861633498, 0.07752886898789478, 0.4972970076652429], [0.251311327227621, 0.4888737351135423, 0.8867746410121203, 1.086589015474623, 1.359889255567608, 1.1663408298950968, 0.6742235065052071, 0.43683503392133255, 0.50347745629217, 0.28420664577352606  …  -1.3913449608047943, -1.4820787109705316, -1.0020681941677192, 0.015795349003787432, 0.354779181378556, -0.12879054552524927, -1.0416735978677272, -1.3667321599783797, -0.24280530297126435, 0.585944704826394]), VComp([50273.02467875962 7041.105164396358 … 0.00010581479818065806 -2.8731305946311186e-5; 7041.105164396358 82880.84002711735 … -0.0003844802500373811 0.0001058147981981566; … ; 0.00010581479818065806 -0.0003844802500373811 … 82880.84002670436 7041.105164390399; -2.8731305946311186e-5 0.0001058147981981566 … 7041.105164390399 50273.02467860508], [-0.4836135038178731, -0.988678978737391, -1.3229272605434894, -0.32482102645182676, 0.7706544694426579, 0.8325822141583343, 0.5987229795637262, -0.5241990119238615, -1.9107531261540993, -2.4820153872991875  …  -0.6464292997148956, -0.5574036888828474, -0.3351650246270802, 0.1112275857600006, 0.32323019350882154, 0.8085350087723989, 1.5858869985684616, 1.6837522737163038, 1.20160003294185, 0.8592494110733625], [-0.31784821189198365, 0.1986421274795545, 0.07395072617986106, -0.16580134440202543, -0.22344252696654085, 0.1827130996591008, 1.0423472580033715, 1.6508726669189218, 1.8051465608388193, 1.3977140239824084  …  0.12167854454672755, -0.11185061677671573, -0.10965042590176122, 0.19013484987004253, 0.8374248207113852, 1.2895245916656173, 1.2016737602722332, 0.9172989551111528, 0.31352000354086257, -0.07552767910043261]), VComp([47555.96685127765 6659.851611491078 … 0.000100092703670424 -2.717768427064152e-5; 6659.851611491078 78402.25664982485 … -0.0003636877711588421 0.00010009270368697667; … ; 0.000100092703670424 -0.0003636877711588421 … 78402.25664943419 6659.851611485441; -2.717768427064152e-5 0.00010009270368697667 … 6659.851611485441 47555.96685113146], [0.4066548669398225, 0.6527573699038731, 0.5816931561575486, 0.39017907478916863, 0.9103386003926413, 0.8994363236523513, 0.40972139186328504, -0.26309126872025157, -1.0235610420699035, -1.2045025137506382  …  2.3605910456886523, 1.6760297054286803, 0.8655616471928317, -0.3470911540061117, -0.7543098221945449, 0.12175262357027786, 1.4032123448577127, 1.7844745477706296, 1.5926862118501055, 1.5854845568338483], [0.776847463305056, 1.38569216887199, 1.6662121732024364, 1.641756303077532, 1.5222001502924467, 0.9846669635716546, 0.8003230315970344, 0.39959120493513467, 0.302546033373993, 0.6610598848670328  …  -1.9937429281585854, -2.5432907386447496, -2.606678025607028, -1.921237570472245, -1.0458519688106935, -0.4689228809106339, 0.07851774467505346, 0.4218121455453776, 0.6476437583638489, 0.3185399115368512])])</code></pre>
</div>
</div>
<p>We can visualize how well the mixtures were recovered during inference by plotting a circle at our GP predictions over time. The radius of each circle will be the standard deviation of our posterior uncertainty at that point. I will draw the true synthetically generated functions as well for comparison.</p>
<div id="56" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_example</span>(o, kern, c_U, true_f)</span>
<span id="cb49-2">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb49-3">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb49-4">    x_N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinRange</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)]</span>
<span id="cb49-5">    _, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernel_mats</span>(kern, x_N, c_U)</span>
<span id="cb49-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> on <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(!isnothing, o)</span>
<span id="cb49-7">        μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Point2d</span>.(c[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> on.m1, c[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> on.m2)</span>
<span id="cb49-8">        σ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(c[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].Λ)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">invquad</span>(on.S_inv, c[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>))</span>
<span id="cb49-9">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">poly!</span>(ax, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Circle</span>.(μ, σ), alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb49-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb49-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb49-12">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines!</span>(ax, true_f[i][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], true_f[i][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb49-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb49-14">    f</span>
<span id="cb49-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>plot_example (generic function with 1 method)</code></pre>
</div>
</div>
<div id="58" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_example</span>(o, kern, c_U, true_f)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/ships/ships_files/figure-html/cell-30-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/ships/ships.html</guid>
  <pubDate>Wed, 19 Nov 2025 06:00:00 GMT</pubDate>
</item>
<item>
  <title>Analyzing Coffee Yields</title>
  <link>https://samanklesaria.github.io/posts/coffee/coffee.html</link>
  <description><![CDATA[ 





<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   4.0.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lme4)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix

Attaching package: 'Matrix'

The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstanarm)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Rcpp
This is rstanarm version 2.32.2
- See https://mc-stan.org/rstanarm/articles/priors for changes to default priors!
- Default priors may change, so it's safest to specify priors, even if equivalent to the defaults.
- For execution on a local, multicore CPU with excess RAM we recommend calling
  options(mc.cores = parallel::detectCores())</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div></div>
</div>
<p>This post demonstrates working with generalized linear mixed models in the context of coffee bean yield data. Each row in the following dataset is an observation of coffee bean yield from a single farm over the past year. Note that this dataset comes from cluster sampling. First, a random sample of supply units were chosen. Then, within each supply unit, a random sample of farms in the same cluster is taken. The number of farms sampled from each sampling unit is proportional to the size of the sampling unit, making sample means unbiased estimates of population means.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"coffee.csv"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 1168 Columns: 19
── Column specification
──────────────────────────────────────────────────────── Delimiter: "," chr
(7): supply_unit, region, obs_shade, ipm_methods, last_replanted, last_... dbl
(10): ...1, farm_altitude_meters, coffee_farm_size_ha, main_stems_count,... lgl
(2): had_recent_soil_or_leaf_test, used_test_results
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(ipm_methods, region, supply_unit, obs_shade)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,168 × 4
   ipm_methods                                      region supply_unit obs_shade
   &lt;chr&gt;                                            &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;    
 1 replanting maintain_field_hygiene biological_co… sabana sabana_nor… light_sh…
 2 replanting maintain_field_hygiene biological_co… sabana sabana_nor… light_sh…
 3 maintain_field_hygiene                           sabana sabana_nor… medium_s…
 4 replanting maintain_field_hygiene                sabana sabana_nor… medium_s…
 5 maintain_field_hygiene                           sabana sabana_nor… medium_s…
 6 maintain_field_hygiene                           sabana sabana_nor… light_sh…
 7 maintain_field_hygiene                           sabana sabana_nor… medium_s…
 8 maintain_field_hygiene                           sabana sabana_nor… medium_s…
 9 replanting maintain_field_hygiene                sabana sabana_nor… medium_s…
10 maintain_field_hygiene                           sabana sabana_nor… minimal_…
# ℹ 1,158 more rows</code></pre>
</div>
</div>
<p>We’ll need to do a little pre-processing first. The column listing pest management techniques (ipm_methods) can contain multiple treatment names, separated by a space. We’ll expand these into binary categories.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">extract_categories <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(data, s) {</span>
<span id="cb12-2">  data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate_longer_delim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> {{ s }}, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delim=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(</span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> {{ s }},</span>
<span id="cb12-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> value,</span>
<span id="cb12-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_fill =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-7">  )</span>
<span id="cb12-8">}</span></code></pre></div></div>
</div>
<p>We’ll also convert the <em>obs_shade</em> and <em>last_replanted</em> columns to factors.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb13-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs_shade=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strtoi</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_match</span>(obs_shade, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+)_percent"</span>)[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]),</span>
<span id="cb13-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">last_replanted=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(last_replanted,</span>
<span id="cb13-5">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"more_than_5_years_ago"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2_5_years_ago"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"within_the_last_two_years"</span>),</span>
<span id="cb13-6">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ordered=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb13-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs_shade=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(obs_shade, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ordered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_categories</span>(ipm_methods)</span></code></pre></div></div>
</div>
<p>Now, on to the main question: does shade decrease yield? The following plot certainly suggests it does.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(obs_shade, yield_kg_ha_green)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>()</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>But there’s likely confounders here. Higher altitude farms might both get less shade and have soils less amenable to high yields.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(farm_altitude_meters), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(yield_kg_ha_green))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>obs_shade) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s try modeling this more carefully.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lmer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(yield_kg_ha_green) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> obs_shade <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>region<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>supply_unit) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(farm_altitude_meters), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data)</span>
<span id="cb17-2">tdat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resid=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fit))</span>
<span id="cb17-3">tdat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(resid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A log linear model seems a little skewed.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(tdat,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sample=</span>resid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_qq</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_qq_line</span>()</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A GLM with a Gamma family works better here.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glmer</span>(yield_kg_ha_green <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> obs_shade <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(farm_altitude_meters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>region<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>supply_unit), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Gamma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log"</span>))</span>
<span id="cb20-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit2)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resid=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fit2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sample=</span>resid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_qq</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_qq_line</span>()</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit2)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: Gamma  ( log )
Formula: yield_kg_ha_green ~ obs_shade + scale(farm_altitude_meters) +  
    (1 | region/supply_unit)
   Data: data

     AIC      BIC   logLik deviance df.resid 
 17386.2  17431.8  -8684.1  17368.2     1159 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.4288 -0.7563 -0.2222  0.5141  5.3585 

Random effects:
 Groups             Name        Variance Std.Dev.
 supply_unit:region (Intercept) 0.02685  0.1639  
 region             (Intercept) 0.01471  0.1213  
 Residual                       0.45488  0.6744  
Number of obs: 1168, groups:  supply_unit:region, 20; region, 8

Fixed effects:
                             Estimate Std. Error t value Pr(&gt;|z|)    
(Intercept)                  6.485595   0.092593  70.044   &lt;2e-16 ***
obs_shade.L                 -0.233903   0.106632  -2.194   0.0283 *  
obs_shade.Q                  0.020627   0.088579   0.233   0.8159    
obs_shade.C                  0.045673   0.059993   0.761   0.4465    
obs_shade^4                  0.009596   0.039745   0.241   0.8092    
scale(farm_altitude_meters) -0.037419   0.022113  -1.692   0.0906 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) obs_.L obs_.Q obs_.C obs_^4
obs_shade.L  0.135                            
obs_shade.Q  0.289  0.415                     
obs_shade.C  0.122  0.692  0.362              
obs_shade^4  0.143  0.162  0.403  0.230       
scl(frm_l_)  0.002  0.146 -0.033  0.028  0.019</code></pre>
</div>
</div>
<p>We see a pretty clear negative linear relationship between shade coverage and yield. To decrease the variance of our estimate, we can try controlling for other factors. Let’s factor in fertilizer use.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(average_fertilizer_per_hectare), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(yield_kg_ha_green))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">span=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It seems like fertilizer has a highly nonlinear relationship with yield. Let’s just look at quantiles.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fertilizer_quantile =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ntile</span>(average_fertilizer_per_hectare, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(fertilizer_quantile, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(yield_kg_ha_green))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">fit3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glmer</span>(yield_kg_ha_green <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> obs_shade <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(farm_altitude_meters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fertilizer_quantile <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>region<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>supply_unit), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Gamma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log"</span>))</span>
<span id="cb28-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit3)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: Gamma  ( log )
Formula: yield_kg_ha_green ~ obs_shade + scale(farm_altitude_meters) +  
    fertilizer_quantile + (1 | region/supply_unit)
   Data: data

     AIC      BIC   logLik deviance df.resid 
 17220.0  17270.6  -8600.0  17200.0     1158 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.4805 -0.6998 -0.1895  0.4592  6.5325 

Random effects:
 Groups             Name        Variance Std.Dev.
 supply_unit:region (Intercept) 0.023739 0.15408 
 region             (Intercept) 0.006918 0.08318 
 Residual                       0.417381 0.64605 
Number of obs: 1168, groups:  supply_unit:region, 20; region, 8

Fixed effects:
                            Estimate Std. Error t value Pr(&gt;|z|)    
(Intercept)                  5.88611    0.08835  66.625   &lt;2e-16 ***
obs_shade.L                 -0.24805    0.09991  -2.483   0.0130 *  
obs_shade.Q                  0.00149    0.08341   0.018   0.9857    
obs_shade.C                  0.01520    0.05654   0.269   0.7881    
obs_shade^4                  0.02244    0.03741   0.600   0.5485    
scale(farm_altitude_meters) -0.03483    0.02060  -1.691   0.0909 .  
fertilizer_quantile          0.23374    0.01742  13.418   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) obs_.L obs_.Q obs_.C obs_^4 sc(__)
obs_shade.L  0.136                                   
obs_shade.Q  0.293  0.414                            
obs_shade.C  0.140  0.691  0.364                     
obs_shade^4  0.127  0.161  0.402  0.227              
scl(frm_l_) -0.010  0.151 -0.043  0.013  0.019       
frtlzr_qntl -0.483 -0.008 -0.020 -0.039  0.027  0.010</code></pre>
</div>
</div>
<p>The AIC and residual variance decreased, and the standard error for shade’s negative linear effect shrunk even smaller.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit3)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/coffee/coffee_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can add in factors for the pest control efforts we extracted initially.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">fit4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glmer</span>(yield_kg_ha_green <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> obs_shade <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(farm_altitude_meters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fertilizer_quantile <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> use_insect_traps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> biological_control <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>region<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>supply_unit), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Gamma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log"</span>))</span>
<span id="cb31-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit4)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: Gamma  ( log )
Formula: yield_kg_ha_green ~ obs_shade + scale(farm_altitude_meters) +  
    fertilizer_quantile + use_insect_traps + biological_control +  
    (1 | region/supply_unit)
   Data: data

     AIC      BIC   logLik deviance df.resid 
 17217.0  17277.8  -8596.5  17193.0     1156 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.4889 -0.6999 -0.1899  0.4687  6.6757 

Random effects:
 Groups             Name        Variance Std.Dev.
 supply_unit:region (Intercept) 0.022751 0.15084 
 region             (Intercept) 0.007078 0.08413 
 Residual                       0.411851 0.64176 
Number of obs: 1168, groups:  supply_unit:region, 20; region, 8

Fixed effects:
                             Estimate Std. Error t value Pr(&gt;|z|)    
(Intercept)                  5.877484   0.088270  66.585   &lt;2e-16 ***
obs_shade.L                 -0.250834   0.099695  -2.516   0.0119 *  
obs_shade.Q                  0.005447   0.083375   0.065   0.9479    
obs_shade.C                  0.020206   0.056476   0.358   0.7205    
obs_shade^4                  0.021293   0.037376   0.570   0.5689    
scale(farm_altitude_meters) -0.031682   0.020572  -1.540   0.1236    
fertilizer_quantile          0.231400   0.017450  13.260   &lt;2e-16 ***
use_insect_traps             0.186580   0.093333   1.999   0.0456 *  
biological_control           0.121985   0.086255   1.414   0.1573    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) obs_.L obs_.Q obs_.C obs_^4 sc(__) frtlz_ us_ns_
obs_shade.L  0.135                                                 
obs_shade.Q  0.294  0.414                                          
obs_shade.C  0.140  0.690  0.365                                   
obs_shade^4  0.128  0.163  0.404  0.228                            
scl(frm_l_) -0.012  0.151 -0.041  0.015  0.020                     
frtlzr_qntl -0.476 -0.003 -0.016 -0.039  0.032  0.006              
us_nsct_trp -0.012  0.012  0.053  0.045  0.027  0.040  0.003       
blgcl_cntrl -0.039 -0.033 -0.045 -0.009 -0.052  0.035 -0.084 -0.099</code></pre>
</div>
</div>
<p>Interestingly, controlling for pest mitigation methods makes the effect of altitude seem much less significant. An analysis of deviance lets us compare the nested models.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anova</span>(fit2, fit3, fit4)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data
Models:
fit2: yield_kg_ha_green ~ obs_shade + scale(farm_altitude_meters) + (1 | region/supply_unit)
fit3: yield_kg_ha_green ~ obs_shade + scale(farm_altitude_meters) + fertilizer_quantile + (1 | region/supply_unit)
fit4: yield_kg_ha_green ~ obs_shade + scale(farm_altitude_meters) + fertilizer_quantile + use_insect_traps + biological_control + (1 | region/supply_unit)
     npar   AIC   BIC  logLik deviance    Chisq Df Pr(&gt;Chisq)    
fit2    9 17386 17432 -8684.1    17368                           
fit3   10 17220 17271 -8600.0    17200 168.2306  1     &lt;2e-16 ***
fit4   12 17217 17278 -8596.5    17193   6.9538  2     0.0309 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The difference in deviances (likelihood ratio) for model 4 is still significant.</p>



 ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/coffee/coffee.html</guid>
  <pubDate>Sun, 19 Oct 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Sizecheck: Making Tensor Code Self-Documenting with Runtime Shape Validation</title>
  <link>https://samanklesaria.github.io/posts/sizecheck.html</link>
  <description><![CDATA[ 





<p>Writing neural networks often feels like juggling tensors in the dark. You know that <code>attention_weights</code> should be 4-dimensional, but PyTorch won’t tell you until your matrix multiplication explodes at runtime. What if your variable names could automatically validate tensor shapes?</p>
<p>Meet <a href="https://github.com/samanklesaria/sizecheck"><strong>sizecheck</strong></a> – a Python decorator that for automatic runtime validation.</p>
<section id="the-shape-suffix-convention" class="level2">
<h2 class="anchored" data-anchor-id="the-shape-suffix-convention">The Shape Suffix Convention</h2>
<p>When writing PyTorch or NumPy code, it’s common to use naming conventions that indicate tensor shapes, as Noam Shazeer explains in his <a href="https://medium.com/@NoamShazeer/shape-suffixes-good-coding-style-f836e72e24fd">Medium post</a>:</p>
<blockquote class="blockquote">
<p>“When known, the name of a tensor should end in a dimension-suffix composed of those letters, e.g.&nbsp;<code>input_token_id_BL</code> for a two-dimensional tensor with batch and length dimensions.”</p>
</blockquote>
<p>This makes code self-documenting. Looking at <code>query_BLHK</code>, you immediately know it’s a 4D tensor with batch, length, heads, and key dimensions.</p>
</section>
<section id="from-convention-to-validation" class="level2">
<h2 class="anchored" data-anchor-id="from-convention-to-validation">From Convention to Validation</h2>
<p>Sizecheck verifies that your tensors actually have the shapes you expect them to have. By analyzing your function’s syntax tree, it automatically injects shape checks wherever you use suffixed variable names. Just prefix your function with <code>@shapecheck</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> shapecheck <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> shapecheck</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@shapecheck</span></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> attention(query_BLH, key_BLH, value_BLH):</span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Automatic validation: all tensors must be 3D with matching B,L dimensions</span></span>
<span id="cb1-7">    scores_BLL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.matmul(query_BLH, key_BLH.transpose(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb1-8">    weights_BLL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.softmax(scores_BLL, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-9">    output_BLH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.matmul(weights_BLL, value_BLH)</span>
<span id="cb1-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output_BLH</span></code></pre></div></div>
<p>When shapes don’t match, ShapeCheck produces a clear error message describing the discrepency. For example:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb2-2">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb2-3">v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb2-4">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attention(q, k, v)</span></code></pre></div></div>
<pre><code>AssertionError: Shape mismatch for key_BLH dimension L: expected 10 (from query_BLH), got 12</code></pre>
<p>The magic happens through AST transformation. ShapeCheck parses your function, identifies shape-annotated variables, and injects validation code automatically. You write clean, readable code with meaningful names, and get bulletproof shape checking for free.</p>
<p>Additionally, shape dimensions are stored as local variables within each function. If local variable is named <code>score_BLL</code>,&nbsp;for example, then the variables <code>B</code> and <code>L</code> will automatically be assigned its first and second shape indices.</p>
</section>
<section id="available-in-julia-too" class="level2">
<h2 class="anchored" data-anchor-id="available-in-julia-too">Available in Julia too!</h2>
<p>The Julia version is called <code>SizeCheck.jl</code>. It’s available on <a href="https://github.com/samanklesaria/SizeCheck">GitHub</a> and can be installed via <code>Pkg.add("SizeCheck")</code>.</p>


</section>

 ]]></description>
  <category>tools</category>
  <guid>https://samanklesaria.github.io/posts/sizecheck.html</guid>
  <pubDate>Sat, 30 Aug 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Frequentist Sample Size Estimation</title>
  <link>https://samanklesaria.github.io/posts/Frequentist_Sample_Size_Estimation.html</link>
  <description><![CDATA[ 





<p>In the previous post, I showed a Bayesian method of sample size estimation for A/B/n testing. This post goes over the more conventional frequentist method.</p>
<p>As before, here’s the context. Say we’re trying to test which variant of an email message generates the highest response rate. We consider <img src="https://latex.codecogs.com/png.latex?k"> different messages and send out <img src="https://latex.codecogs.com/png.latex?n"> emails for each message. After we wait for responses, we should be able to tell which message yielded the highest response rate as long as we set <img src="https://latex.codecogs.com/png.latex?n"> high enough. But we generally can’t send out too many messages: say we’re capped at <img src="https://latex.codecogs.com/png.latex?N"> total. How do we choose the highest <img src="https://latex.codecogs.com/png.latex?k"> that still allows us to confidently pick which message got the highest response rate?</p>
<section id="frequentist-two-arm-estimation" class="level2">
<h2 class="anchored" data-anchor-id="frequentist-two-arm-estimation">Frequentist Two-Arm Estimation</h2>
<p>If we only have two messages (or ‘arms’ in the standard terminology), we might naively use a t-test to see if the observed difference in mean response rates <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta%7D"> was statistically significant. Let <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Csigma%7D"> be the pooled standard deviation. Then if the true difference in mean response rates <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> is zero (the null hypothesis), <img src="https://latex.codecogs.com/png.latex?t%20=%20%5Cfrac%7B%5Csqrt%7Bn%7D%5Chat%7B%5Cdelta%7D%7D%7B%5Csqrt%7B2%7D%5Chat%7B%5Csigma%7D%7D"> will be T distributed with <img src="https://latex.codecogs.com/png.latex?2n-2"> dof. To get a false positive rate of <img src="https://latex.codecogs.com/png.latex?%5Calpha">, we can reject the null hypothesis when <img src="https://latex.codecogs.com/png.latex?t%20%3E%20t_%7B1-%5Calpha%7D"> where <img src="https://latex.codecogs.com/png.latex?t_%7B1-%5Calpha%7D"> gives the <img src="https://latex.codecogs.com/png.latex?1-%5Calpha"> quantile of the Student’s t distribution. Under the alternative hypothesis that <img src="https://latex.codecogs.com/png.latex?%5Cdelta%20=%20%5Cdelta_0%20%3E%200">, <img src="https://latex.codecogs.com/png.latex?t"> will actually come from a non-central t distribution (ignoring the differences in arm variance). We can see this because <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7Bn%7D(%5Chat%7B%5Cdelta%7D%20-%20%5Cdelta_0)/%5Csqrt%7B2%7D%5Csigma"> comes from a standard normal distribution, so <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7Bn%7D%5Chat%7B%5Cdelta%7D/%5Csqrt%7B2%7D%5Csigma"> is normal with mean <img src="https://latex.codecogs.com/png.latex?%5Cdelta_0%20%5Csqrt%7Bn%7D">. This means that the power of our test will be the survival function of a <img src="https://latex.codecogs.com/png.latex?2n-2"> degree non-central T distribution with noncentrality parameter <img src="https://latex.codecogs.com/png.latex?%5Cdelta_0%20%5Csqrt%7Bn%7D"> evaluated at <img src="https://latex.codecogs.com/png.latex?t_%7B1-%5Calpha%7D">. We can find the number of samples <img src="https://latex.codecogs.com/png.latex?n"> that produces a desired power <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> with a simple binary search. This calculation is implemented within the <code>statsmodels</code> library as follows:</p>
<div id="12debd12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> statsmodels.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> power</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.optimize <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> brentq</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-7">sns.set_theme()</span></code></pre></div></div>
</div>
<div id="242d0b10" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">powers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>]</span></code></pre></div></div>
</div>
<div id="57391aa3" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">freq_df_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([pd.DataFrame({</span>
<span id="cb3-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'samples'</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> power.tt_ind_solve_power(effect_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>delta, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alpha, power<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'larger'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> powers],</span>
<span id="cb3-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'power'</span>: powers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta'</span>: delta, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>: alpha})</span>
<span id="cb3-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> delta <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>]</span>
<span id="cb3-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> alpha <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>]], ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</div>
<div id="0e1d1384" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sns.relplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>freq_df_t, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'power'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'samples'</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta'</span>, col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'line'</span>).axes.ravel():</span>
<span id="cb4-2">    ax.set_xticks(powers)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/Frequentist_Sample_Size_Estimation_files/figure-html/cell-5-output-1.png" width="1518" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This suggests we’d need a truly massive number of samples! Fortunately, things aren’t as bad as they seem. We can use a Z-test instead.</p>
<p>Say response rates are <img src="https://latex.codecogs.com/png.latex?%5Ctheta_0"> and <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1"> with difference <img src="https://latex.codecogs.com/png.latex?%5Cdelta">. The difference of observed arm means <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta%7D"> will be approximately normal around <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> with variance <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Ctheta_0(1-%5Ctheta_0)%20+%20%5Ctheta_1(1-%5Ctheta_1)%7D%7Bn%7D">. Let <img src="https://latex.codecogs.com/png.latex?%5Csigma_0%5E2%20=2%5Ctheta_0(1-%5Ctheta_0)"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma_1%5E2%20=%5Ctheta_0(1-%5Ctheta_0)%20+%20%5Ctheta_1(1-%5Ctheta_1)">. if <img src="https://latex.codecogs.com/png.latex?%5Cdelta%20=%200"> and we reject when <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta%7D%20%3E%20%5Cfrac%7B%5Csigma_0%7D%7B%5Csqrt%7Bn%7D%7D%20z_%7B1%20-%20%5Calpha%7D">, we’ll have a false positive rate of <img src="https://latex.codecogs.com/png.latex?%5Calpha">. If <img src="https://latex.codecogs.com/png.latex?%5Cdelta%20=%20%5Cdelta_0">, on the other hand, then <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta%7D%20-%20%5Cdelta_0"> will be normal with variance <img src="https://latex.codecogs.com/png.latex?%5Csigma_1%5E2/n">, so rejecting if <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta%7D%20%3E%20%5Cdelta_0%20+%20%5Cfrac%7B%5Csigma_1%7D%7B%5Csqrt%7Bn%7D%7D%20z_%7B1%20-%20%5Cbeta%7D"> would give us power <img src="https://latex.codecogs.com/png.latex?%5Cbeta">. We can choose <img src="https://latex.codecogs.com/png.latex?n"> so that these critical values are the same.</p>
<p>A little algebra tells us that <img src="https://latex.codecogs.com/png.latex?n%20=%20%5Cfrac%7B(%5Csigma_0%20z_%7B1%20-%20%5Calpha%7D%20-%20%5Csigma_1%20z_%7B1%20-%20%5Cbeta%7D)%5E2%7D%7B%5Cdelta_0%5E2%7D">. Once again, this is already implemented in <code>statsmodels</code>.</p>
<div id="1a97a4d0" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.04</span></span></code></pre></div></div>
</div>
<div id="4cc7b362" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">freq_df_z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([pd.DataFrame({</span>
<span id="cb6-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'samples'</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> power.normal_sample_size_one_tail(d, p, alpha,</span>
<span id="cb6-3">                        std_null<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t)),</span>
<span id="cb6-4">                        std_alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.sqrt(t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>d)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>d))))</span>
<span id="cb6-5">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> powers],</span>
<span id="cb6-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'power'</span>: powers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta'</span>: d, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>: alpha})</span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>]</span>
<span id="cb6-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> alpha <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>]], ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</div>
<div id="99a03732" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sns.relplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>freq_df_z, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'power'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'samples'</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta'</span>, col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'line'</span>).axes.ravel():</span>
<span id="cb7-2">    ax.set_xticks(powers)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/Frequentist_Sample_Size_Estimation_files/figure-html/cell-8-output-1.png" width="1518" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="frequentist-multi-arm-estimation" class="level2">
<h2 class="anchored" data-anchor-id="frequentist-multi-arm-estimation">Frequentist Multi-Arm Estimation</h2>
<p>With more than two arms, we end up testing more than one null hypothesis. Specifically, we’ll want to test the null hypothesis that arm <img src="https://latex.codecogs.com/png.latex?i"> has a higher mean than arm <img src="https://latex.codecogs.com/png.latex?j"> for every pair arms <img src="https://latex.codecogs.com/png.latex?i,j">. We’ll reject this hypothesis when <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta_%7Bi,j%7D%7D%20%3E%20c"> for a specific value of <img src="https://latex.codecogs.com/png.latex?c">. Our family-wise false positive rate <img src="https://latex.codecogs.com/png.latex?1%20-%20%5Calpha"> must now cover the probability that we mistakenly reject any of these tests. If <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cdelta%7D_%7Bi,j%7D%20%3E%20c"> for any <img src="https://latex.codecogs.com/png.latex?i,j">, it will also be true that <img src="https://latex.codecogs.com/png.latex?%5Cdelta%5E%5Cstar%20%3E%20c"> where <img src="https://latex.codecogs.com/png.latex?%5Cdelta%5E%5Cstar"> is the largest observed difference in means between any pair of arms. We can show that <img src="https://latex.codecogs.com/png.latex?%5Cdelta%5E%5Cstar"> follows a known distribution.</p>
<p>In general, if <img src="https://latex.codecogs.com/png.latex?F"> is a distribution’s cdf, the joint probability that each of <img src="https://latex.codecogs.com/png.latex?k"> independent draws from the distribution are between <img src="https://latex.codecogs.com/png.latex?a"> and <img src="https://latex.codecogs.com/png.latex?a+%5Cdelta"> is given by <img src="https://latex.codecogs.com/png.latex?(F(a%20+%20%5Cdelta)%20-%20F(a))%5Ek">. This makes the density at <img src="https://latex.codecogs.com/png.latex?a"> given by <img src="https://latex.codecogs.com/png.latex?k%20f(a)(F(a%20+%20%5Cdelta)%20-%20F(a))%5E%7Bk-1%7D">. We want to integrate over all <img src="https://latex.codecogs.com/png.latex?a">: <img src="https://latex.codecogs.com/png.latex?%5Cint_%7B-%5Cinfty%7D%5E%5Cinfty%20k%20f(a)(F(a%20+%20%5Cdelta)%20-%20F(a))%5E%7Bk-1%7D%5C,%20da">.</p>
<p>This distribution over the largest difference within <img src="https://latex.codecogs.com/png.latex?k"> samples is known as the <em>Studentized range distribution</em> when <img src="https://latex.codecogs.com/png.latex?F"> is the cdf of a Student’s t distribution. This is built into <code>scipy</code>! And because a normal distribution is just a Student’s t distribution with infinite degrees of freedom, this covers a largest difference between normal samples as well, which I’ll refer to as a <em>range distribution</em>.</p>
<p>Say each of the per-arm differences are normal with approximately the same variance <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2">. We can reject the null hypothesis that all the inter-arm differences are zero when <img src="https://latex.codecogs.com/png.latex?%5Cdelta%5E%5Cstar%20%3E%20%5Cfrac%7B%5Csigma%7D%7B%5Csqrt%7Bn%7D%7D%20q_%7B1-%5Calpha%7D"> to get a family-wise false positive rate of <img src="https://latex.codecogs.com/png.latex?%5Calpha">, where <img src="https://latex.codecogs.com/png.latex?q_%7B1-%5Calpha%7D"> gives the <img src="https://latex.codecogs.com/png.latex?1-%5Calpha"> quantile of the range distribution. If we also reject when <img src="https://latex.codecogs.com/png.latex?%5Cdelta%5E%5Cstar%20%3E%20%5Cdelta_0%20+%20%20%5Cfrac%7B%5Csigma%7D%7B%5Csqrt%7Bn%7D%7D%20q_%7B1-%5Cbeta%7D">, we’d have power <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> when the true maximum difference is <img src="https://latex.codecogs.com/png.latex?%5Cdelta_0">. Once again, we can solve for when these critical values are equal to find the necessary number of samples; unfortunately the algebra here isn’t built into <code>statsmodels</code>, so we’ll have to do it ourselves.</p>
<div id="b14890b1" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> range_sample_size(k, theta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span>, delta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span>, beta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>):</span>
<span id="cb8-2">    q0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.studentized_range.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha, k, np.inf)</span>
<span id="cb8-3">    q1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.studentized_range.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> beta, k, np.inf)</span>
<span id="cb8-4">    theta1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> theta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delta</span>
<span id="cb8-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> theta1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> theta1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((q1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> q0) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> delta)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div></div>
</div>
<div id="1ddeccf6" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">ks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</div>
<div id="cda3ddd3" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">freq_df_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([pd.DataFrame({</span>
<span id="cb10-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'samples'</span>: [range_sample_size(k, delta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>delta, theta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>theta, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alpha) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ks],</span>
<span id="cb10-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>: ks, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta'</span>: delta, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>: theta, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>: alpha})</span>
<span id="cb10-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> delta <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>]</span>
<span id="cb10-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> theta <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.04</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>]</span>
<span id="cb10-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> alpha <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>]], ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</div>
<div id="91d08bc3" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sns.relplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>freq_df_q, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'samples'</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta'</span>, col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>, row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'line'</span>).axes.ravel():</span>
<span id="cb11-2">    ax.set_xticks(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(ks))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/Frequentist_Sample_Size_Estimation_files/figure-html/cell-12-output-1.png" width="1036" height="1424" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/Frequentist_Sample_Size_Estimation.html</guid>
  <pubDate>Fri, 15 Aug 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Bayesian Power Analysis for A/B/n Tests</title>
  <link>https://samanklesaria.github.io/posts/bayesian_logistic_regression/bayesian_logistic_regression.html</link>
  <description><![CDATA[ 





<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LogExpFunctions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">QuasiMonteCarlo</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CairoMakie</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">StatsModels</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PythonCall</span></span>
<span id="cb1-2">CairoMakie.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enable_only_mime!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span>)</span></code></pre></div></div>
</div>
<p>This post highlights a Bayesian approach to sample size estimation in A/B/n testing. Say we’re trying to test which variant of an email message generates the highest response rate from a population. We consider <img src="https://latex.codecogs.com/png.latex?k"> different messages and send out <img src="https://latex.codecogs.com/png.latex?n"> emails for each message. After we wait for responses, we should be able to tell which message yielded the highest response rate as long as we set <img src="https://latex.codecogs.com/png.latex?n"> high enough. But we generally can’t send out too many messages: say we’re capped at <img src="https://latex.codecogs.com/png.latex?N"> total. How do we choose the highest <img src="https://latex.codecogs.com/png.latex?k"> that still allows us to confidently pick which message got the highest response rate?</p>
<p>We’ll start with a prior over the response rates of each message. Choosing an independent prior over the rates for each message would be overly naive: all the messages will likely give very similar response rates, so if we know the rate for one message, we’ll have a good guess about the rates for other messages too. Instead, we’ll choose one message to be a baseline, giving it a response rate prior centered at 7%. We’ll sample independent multiples of this baseline to give the response rates for the other messages.</p>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1">priors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Normal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.07</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Normal</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>))]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Normal{Float64}}:
 Distributions.Normal{Float64}(μ=-2.5866893440979424, σ=0.5)
 Distributions.Normal{Float64}(μ=0.0, σ=0.26236426446749106)</code></pre>
</div>
</div>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_prior</span>(p, transform, title)</span>
<span id="cb4-2">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb4-3">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>title)</span>
<span id="cb4-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist!</span>(ax, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transform</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(p, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)))</span>
<span id="cb4-5">    qs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transform</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>.(p, [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>]))</span>
<span id="cb4-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vlines!</span>(ax, qs, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=:</span>orange, linestyle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>dash)</span>
<span id="cb4-7">    f</span>
<span id="cb4-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>plot_prior (generic function with 1 method)</code></pre>
</div>
</div>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_prior</span>(priors[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], logistic, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Control success probability"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/bayesian_logistic_regression/bayesian_logistic_regression_files/figure-html/cell-5-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_prior</span>(priors[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], exp, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Odds ratio"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/bayesian_logistic_regression/bayesian_logistic_regression_files/figure-html/cell-6-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If the posterior odds ratios of the non-baseline messages all have 95% of their mass below 1.1, we’ll stick with the baseline message. If, instead, any of the messages has 95% of its posterior odds ratio mass above 1.1, we’ll choose one of those. If neither of these conditions occur, our experiment will have been a failure: we’ll remain too uncertain to make a decision of whether or not to switch from the baseline message. Our task is to choose the number of messages to ensure that we have high probability of running a successful experiment.</p>
<p>To find the posterior odds ratio for each message, we’ll use the Laplace approximation for Bayesian logistic regression. We’ll use Newton’s method to find the MAP.</p>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">newton</span>(f, x; maxiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb8-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>maxiter</span>
<span id="cb8-3">        g, H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(x)</span>
<span id="cb8-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">norm</span>(g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span></span>
<span id="cb8-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (x, H)</span>
<span id="cb8-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb8-7">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-=</span> H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> g</span>
<span id="cb8-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb8-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb8-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">error</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Maximum iterations reached"</span>)</span>
<span id="cb8-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>newton (generic function with 1 method)</code></pre>
</div>
</div>
<p>The following code averages the decision probability over quasi Monte Carlo samples of possible datasets we might observe if the true parameters are given by θ.</p>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">decision_prob</span>(θ, n, k, prior_means, prior_precs; m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)</span>
<span id="cb10-2">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(k,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) StatsModels.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ContrastsMatrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DummyCoding</span>(), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>k).matrix]</span>
<span id="cb10-3">    dists <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Binomial</span>.(n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logistic</span>.(X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> θ))</span>
<span id="cb10-4">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> QuasiMonteCarlo.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(m, k, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SobolSample</span>())</span>
<span id="cb10-5">    succs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stack</span>([<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>.(d, s) for (d,s) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(dists, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(samples))])</span>
<span id="cb10-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(succs)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> succs</span>
<span id="cb10-7">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gh</span>(t)</span>
<span id="cb10-8">            y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logistic</span>.(X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t)</span>
<span id="cb10-9">            vals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> succs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> (y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> (n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> succs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> y</span>
<span id="cb10-10">            g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(vals); vals[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> (t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> prior_means) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> prior_precs</span>
<span id="cb10-11">            H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(prior_precs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(y, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(X))) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> (yi, r)</span>
<span id="cb10-12">                n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> yi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yi) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Symmetric</span>(r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb10-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb10-14">            g, H</span>
<span id="cb10-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb10-16">        mode, H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">newton</span>(gh, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Vector</span>(θ))</span>
<span id="cb10-17">        covar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(H)</span>
<span id="cb10-18">        c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cdf</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Normal</span>.(mode[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(covar)[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>]), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>))</span>
<span id="cb10-19">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Float32</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>))</span>
<span id="cb10-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb10-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>decision_prob (generic function with 1 method)</code></pre>
</div>
</div>
<p>We also need to average the decision probability over our prior for θ.</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_decision_prob</span>(total_n, k, m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)</span>
<span id="cb12-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">div</span>(total_n, k)</span>
<span id="cb12-3">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> QuasiMonteCarlo.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(m, k, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SobolSample</span>())</span>
<span id="cb12-4">    full_priors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [priors; <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(priors[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)]</span>
<span id="cb12-5">    prior_means <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>.(full_priors)</span>
<span id="cb12-6">    prior_precs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">./</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>.(full_priors)</span>
<span id="cb12-7">    prior_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stack</span>([<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>.(p, c) for (p,c) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span></span>
<span id="cb12-8">                                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(full_priors, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(samples))])</span>
<span id="cb12-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(prior_samples)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> θ</span>
<span id="cb12-10">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">decision_prob</span>(θ, n, k, prior_means, prior_precs)</span>
<span id="cb12-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb12-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>avg_decision_prob (generic function with 2 methods)</code></pre>
</div>
</div>
<p>Now, we can use these quasi Monte Carlo estimates to approximate how many messages we’ll be able to test for a given sample size.</p>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span></span>
<span id="cb14-2">f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb14-3">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb14-4">          yminorgridvisible<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>,</span>
<span id="cb14-5">          yminorticks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">IntervalsBetween</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb14-6">          title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sample Size Requirements for Correlated Priors"</span>,</span>
<span id="cb14-7">          xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"samples"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"decision probability"</span>)</span>
<span id="cb14-8">ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span></span>
<span id="cb14-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb14-10">    probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_decision_prob</span>.(ns, k)</span>
<span id="cb14-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines!</span>(ax, ns, probs, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>k<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> arms"</span>)</span>
<span id="cb14-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb14-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Legend</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], ax)</span>
<span id="cb14-14">f</span>
<span id="cb14-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/bayesian_logistic_regression/bayesian_logistic_regression_files/figure-html/cell-10-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="estimates-from-independent-priors" class="level2">
<h2 class="anchored" data-anchor-id="estimates-from-independent-priors">Estimates From Independent Priors</h2>
<p>If we had used a simple Beta-Bernoulli model assuming the each of the message rate priors were independent, our estimates of required sample size would be slightly inflated.</p>
<p>Previously, we used a Normal prior over the log odds of getting a response. But with a Beta distribution, we’ll want to model the probability of getting a response directly. Applying the logistic transformation to samples from a Normal distribution produces samples from a logit-normal distribution, which gives us the response probabilities we had in the first section.</p>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1">qs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LogitNormal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">params</span>(priors[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>), [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>])</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Float64}:
 0.032011773807213074
 0.1462572912990306</code></pre>
</div>
</div>
<p>We’ll use the <code>preliz</code> python package to find a similar Beta distribution to use for our independent Beta prior.</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1">pz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pyimport</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"preliz"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>/Users/sam/myblog/posts/bayesian_logistic_regression/.venv/lib/python3.13/site-packages/preliz/ppls/pymc_io.py:16: UserWarning: PyMC not installed. PyMC related functions will not work.
  warnings.warn("PyMC not installed. PyMC related functions will not work.")
/Users/sam/myblog/posts/bayesian_logistic_regression/.venv/lib/python3.13/site-packages/preliz/ppls/agnostic.py:33: UserWarning: PyMC not installed. PyMC related functions will not work.
  warnings.warn("PyMC not installed. PyMC related functions will not work.")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Python: &lt;module 'preliz' from '/Users/sam/myblog/posts/bayesian_logistic_regression/.venv/lib/python3.13/site-packages/preliz/__init__.py'&gt;</code></pre>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span></span>
<span id="cb20-2">    dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Beta</span>()</span>
<span id="cb20-3">    pz.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maxent</span>(dist, lower<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>qs[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], upper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>qs[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], mass<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)</span>
<span id="cb20-4">    dist</span>
<span id="cb20-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Python: <span class="ansi-bold">Beta</span>(alpha=5.49, beta=55.4)</pre>
</div>
</div>
</div>
<p>It seems like the Beta distribution parameters must comparable to our original setting are <code>5.49</code> and <code>55.4</code>.</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1">beta_prior <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Beta</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.49</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">55.4</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Distributions.Beta{Float64}(α=5.49, β=55.4)</code></pre>
</div>
</div>
<p>Once again, we can simulate the decision probability for different numbers of samples. The curve looks similar to what we observed above, but while 4k samples got us to 95% previously, it now gets us below 80%.</p>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">indep_decision_prob</span>(p, n, k, prior_a, prior_b; m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)</span>
<span id="cb23-2">    dists <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Binomial</span>.(n, p)</span>
<span id="cb23-3">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> QuasiMonteCarlo.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(m, k, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SobolSample</span>())</span>
<span id="cb23-4">    succs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stack</span>([<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>.(d, s) for (d,s) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zip</span>(dists, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(samples))])</span>
<span id="cb23-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(succs)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> succs</span>
<span id="cb23-6">        posts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Beta</span>.(prior_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> succs, prior_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> (n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> succs))</span>
<span id="cb23-7">        ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stack</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>.(posts, m))</span>
<span id="cb23-8">        c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Float64</span>.((ps[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">./</span> ps[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>); dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb23-9">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Float64</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>))</span>
<span id="cb23-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb23-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>indep_decision_prob (generic function with 1 method)</code></pre>
</div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_indep_decision_prob</span>(total_n, k, m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)</span>
<span id="cb25-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">div</span>(total_n, k)</span>
<span id="cb25-3">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> QuasiMonteCarlo.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(m, k, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SobolSample</span>())</span>
<span id="cb25-4">    prior_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">params</span>(beta_prior)</span>
<span id="cb25-5">    prior_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stack</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>.(beta_prior, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(samples)))</span>
<span id="cb25-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachrow</span>(prior_samples)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> θ</span>
<span id="cb25-7">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">indep_decision_prob</span>(θ, n, k, prior_params[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], prior_params[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb25-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb25-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>avg_indep_decision_prob (generic function with 2 methods)</code></pre>
</div>
</div>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span></span>
<span id="cb27-2">f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb27-3">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb27-4">          yminorgridvisible<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>,</span>
<span id="cb27-5">          yminorticks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">IntervalsBetween</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb27-6">          title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sample Size Requirements For Independent Beta Priors"</span>,</span>
<span id="cb27-7">          xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"samples"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"decision probability"</span>)</span>
<span id="cb27-8">ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span></span>
<span id="cb27-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb27-10">    probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_indep_decision_prob</span>.(ns, k)</span>
<span id="cb27-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines!</span>(ax, ns, probs, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>k<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> arms"</span>)</span>
<span id="cb27-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb27-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Legend</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], ax)</span>
<span id="cb27-14">f</span>
<span id="cb27-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/bayesian_logistic_regression/bayesian_logistic_regression_files/figure-html/cell-17-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/bayesian_logistic_regression/bayesian_logistic_regression.html</guid>
  <pubDate>Thu, 31 Jul 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Finding Common Topics</title>
  <link>https://samanklesaria.github.io/posts/clustering/Clustering.html</link>
  <description><![CDATA[ 





<p>How do you find thematic clusters in a large corpus of text documents? The techniques baked into <code>sklearn</code> (e.g.&nbsp;nonnegative matrix factorization, LDA) give you some intuition about common themes. But contemporary NLP has largely moved on from bag-of-words representations. We can do better with some transformer models!</p>
<p>For demonstration purposes, I’ll use a few categories from the standard 20-newsgroups dataset. Ideally, we should be able to recover the four categories in the dataset (atheism, computer graphics, space and religion).</p>
<div id="02697785" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.datasets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fetch_20newsgroups</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.cluster <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> KMeans</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoTokenizer, AutoModel</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_ollama <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOllama</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.utils.data <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DataLoader</span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Markdown</span></code></pre></div></div>
</div>
<div id="e172ea11" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">categories <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb2-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alt.atheism"</span>,</span>
<span id="cb2-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"talk.religion.misc"</span>,</span>
<span id="cb2-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"comp.graphics"</span>,</span>
<span id="cb2-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sci.space"</span>,</span>
<span id="cb2-6">]</span>
<span id="cb2-7"></span>
<span id="cb2-8">dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_20newsgroups(</span>
<span id="cb2-9">    remove<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"footers"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quotes"</span>),</span>
<span id="cb2-10">    subset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all"</span>,</span>
<span id="cb2-11">    categories<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>categories,</span>
<span id="cb2-12">    shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb2-13">    random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb2-14">)</span></code></pre></div></div>
</div>
<p>Some of the documents in the dataset are only a few words; I only want to deal with documents that are least a couple hundred characters.</p>
<div id="4f16f6f3" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, (d.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset.data))))</span></code></pre></div></div>
</div>
<p>First, I’ll map each document to its embedding using the <em>all-MiniLM</em> BERT variant.</p>
<div id="36f1ff0d" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">minilm_tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoTokenizer.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sentence-transformers/all-MiniLM-L6-v2'</span>)</span>
<span id="cb4-2">minilm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoModel.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sentence-transformers/all-MiniLM-L6-v2'</span>).to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mps'</span>)</span></code></pre></div></div>
</div>
<div id="f69999c2" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mean_pooling(model_output, attention_mask):</span>
<span id="cb5-2">    token_embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_output[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#First element contains all embeddings</span></span>
<span id="cb5-3">    input_mask_expanded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attention_mask.unsqueeze(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).expand(</span>
<span id="cb5-4">        token_embeddings.size()).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb5-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(token_embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> input_mask_expanded,</span>
<span id="cb5-6">                     <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.clamp(input_mask_expanded.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-9</span>)</span></code></pre></div></div>
</div>
<div id="2c15c97b" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_embeddings(X):</span>
<span id="cb6-2">    loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(X, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb6-3">    embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb6-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> batch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> loader:</span>
<span id="cb6-5">        toks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> minilm_tokenizer(batch, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, truncation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb6-6">                                return_tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pt'</span>)</span>
<span id="cb6-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb6-8">            model_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> minilm(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>toks.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mps'</span>))</span>
<span id="cb6-9">            result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.normalize(mean_pooling(model_output,</span>
<span id="cb6-10">                                              toks[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'attention_mask'</span>]), p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-11">            embeddings.append(result.cpu())</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.cat(embeddings)</span></code></pre></div></div>
</div>
<p>Next, I’ll cluster the embeddings with the standard k-means algorithm. There’s far more sophisticated clustering techniques in <code>sklearn</code>, but this should be sufficient for the toy problem.</p>
<div id="bb6bc56d" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_clusters(embeddings):</span>
<span id="cb7-2">    neural_kmeans <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> KMeans(n_clusters<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, n_init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb7-3">    neural_kmeans.fit(embeddings)</span>
<span id="cb7-4">    docs_per_label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'labels'</span>: neural_kmeans.labels_}).value_counts()</span>
<span id="cb7-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> neural_kmeans, docs_per_label</span></code></pre></div></div>
</div>
<p>Finally, I’ll take a random set of documents closest to the center of each cluster and ask Qwen to find a title for the collection.</p>
<div id="76ecabe8" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> top_per_cluster(X, embeddings, kmeans, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb8-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [np.random.choice(</span>
<span id="cb8-3">        X[kmeans.labels_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i][np.argsort(((embeddings[kmeans.labels_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i]</span>
<span id="cb8-4">                                                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> c)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))[:k]], m)</span>
<span id="cb8-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(kmeans.cluster_centers_)]</span></code></pre></div></div>
</div>
<div id="d6ed759a" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">llama <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOllama(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mistral:7b"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div></div>
</div>
<p>I’ll let the LLM contemplate common themes to itself before deciding on a title. We can require that the results get packaged together in a structured output format.</p>
<div id="114845a9" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> SampleAnalysis(BaseModel):</span>
<span id="cb10-2">    analysis: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Analysis of the texts.'</span>)</span>
<span id="cb10-3">    category: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Category of the cluster.'</span>)</span></code></pre></div></div>
</div>
<div id="ca5960f1" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> llama_summarize(strs):</span>
<span id="cb11-2">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [SystemMessage(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Your task is to understand why the given documents were assigned to the same cluster.</span></span>
<span id="cb11-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- First analyze the documents in the cluster for common topics.</span></span>
<span id="cb11-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Then, propose a short category name for the cluster containing these documents based on the analysis."""</span>)]</span>
<span id="cb11-6">    prompt.extend(strs)</span>
<span id="cb11-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> llama.with_structured_output(SampleAnalysis).invoke(prompt)</span></code></pre></div></div>
</div>
<p>Let’s try it out!</p>
<div id="3d954608" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_topics(X):</span>
<span id="cb12-2">    embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_embeddings(X)</span>
<span id="cb12-3">    neural_kmeans, docs_per_label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_clusters(embeddings)</span>
<span id="cb12-4">    top_embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> top_per_cluster(X, embeddings, neural_kmeans)</span>
<span id="cb12-5">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [llama_summarize([a <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> t]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> top_embeddings]</span>
<span id="cb12-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.DataFrame({</span>
<span id="cb12-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'category'</span>: [r.category <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results],</span>
<span id="cb12-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_docs'</span>: [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(docs_per_label[a]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(docs_per_label))]</span>
<span id="cb12-9">    }).sort_values(by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_docs'</span>, ascending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div></div>
</div>
<div id="623c39ab" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">Markdown(get_topics(X).to_markdown())</span></code></pre></div></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="40">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;"></th>
<th style="text-align: left;">category</th>
<th style="text-align: right;">n_docs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Space Industry News</td>
<td style="text-align: right;">710</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">Software Development &amp; Graphics</td>
<td style="text-align: right;">707</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Atheism and Religion Debate</td>
<td style="text-align: right;">631</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Social Transformation and Ethics</td>
<td style="text-align: right;">609</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Sounds about right!</p>



 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/clustering/Clustering.html</guid>
  <pubDate>Mon, 10 Feb 2025 06:00:00 GMT</pubDate>
</item>
<item>
  <title>Synthetic Controls for Texas Prison Data</title>
  <link>https://samanklesaria.github.io/posts/synth_control/SyntheticControl.html</link>
  <description><![CDATA[ 





<p>This post uses a synthetic control design to study whether Texas’s prison building boom in 1993 resulted in them incarcerating more prisoners than they would have if their rate of prison building had continued as normal. The analysis will build off the one in the book <a href="https://mixtape.scunning.com/">Causal Inference: The Mixtable</a>, but will make use of techniques from Gelman’s <a href="https://arxiv.org/pdf/2011.01808">Bayesian workflow</a>.</p>
<p>As in the <em>Mixtape</em> book, we’ll express Texas’s incarceration rates over time as a mixture of those of other states with comparable poverty, alcoholiosm and incarceration rates in ’93. Then, we’ll use this mixture of other states to construct a “synthetic” counterfactual Texas which, like the states in the mixture, didn’t have a prison building boom after ’93. We can compare the difference between the true and synthetic Texas over time.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nn</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gpytorch.means <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ConstantMean</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gpytorch.kernels <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ScaleKernel, RBFKernel</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gpytorch.distributions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultivariateNormal</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.distributions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Normal</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> gpytorch.likelihoods.noise_models <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HomoskedasticNoise</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zscore</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_stata(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/scunning1975/mixtape/raw/master/texas.dta"</span>)</span>
<span id="cb2-2">texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> texas[texas.state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'District of Columbia'</span>]</span></code></pre></div></div>
</div>
<p>Our endogenous variable <img src="https://latex.codecogs.com/png.latex?y"> will be the black male incarceration rate. I’ll use a zscore for ease of training hyperparameters.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">texas[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'incarceration_rate'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> texas.bmprison <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> texas.bmpop</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">texas[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'incarceration_z'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> texas.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'year'</span>).incarceration_rate.transform(zscore)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">texas[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'poverty'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> texas[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'poverty'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> texas.sort_values([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>])</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.reshape(texas[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"incarceration_z"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"poverty"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alcohol"</span>]].values, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div></div>
</div>
<p>Looking at the data shows a pretty sizeable increase in Texas’s incarceration rate after ’93 compared to other states, which lends credence to the hypothesis.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">years <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.unique(texas.year)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">states <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.unique(texas.state)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">texix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(states).index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Texas"</span>)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ix, r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(data):</span>
<span id="cb11-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> texix:</span>
<span id="cb11-3">        plt.plot(years, r[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C0"</span>)</span>
<span id="cb11-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb11-5">        plt.plot(years, r[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1"</span> , alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/SyntheticControl_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/{attach}SyntheticControl_files/SyntheticControl_13_0.png" class="img-fluid figure-img"></p>
<figcaption>png</figcaption>
</figure>
</div>
<p>To construct our synthetic version of Texas, we’ll fit a Gaussian process model relating state characteristics in 1993 (incarceration rate, poverty and alcoholism levels) to incarceration rates for other years. Then we’ll apply the fitted model to Texas’s characeristics to predict the counterfactual incarceration rate.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.from_numpy(data[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,:]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.from_numpy(data[:,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> SynthControlModel(nn.Module):</span>
<span id="cb14-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb14-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb14-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.covar_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ScaleKernel(RBFKernel(ard_num_dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb14-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HomoskedasticNoise()</span>
<span id="cb14-6"></span>
<span id="cb14-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb14-8">        covar_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.noise(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.covar_module(x)</span>
<span id="cb14-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> MultivariateNormal(torch.zeros(covar_x.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), covar_x)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SynthControlModel()</span></code></pre></div></div>
</div>
<p>The following code fits the noise and lengthscale parameters by maximum likelihood estimation.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.optim.Adam(model.parameters(), lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>):</span>
<span id="cb17-2">    opt.zero_grad()</span>
<span id="cb17-3">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>model(X).log_prob(Y.T).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb17-4">    loss.backward()</span>
<span id="cb17-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss.item())</span>
<span id="cb17-7">    opt.step()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>390.9499206542969
221.37319946289062
212.59107971191406
211.1005401611328
210.900634765625
210.87908935546875
210.87689208984375
210.87579345703125
210.87570190429688
210.87567138671875</code></pre>
</div>
</div>
<pre><code>390.9499206542969
221.37319946289062
212.59107971191406
211.1005401611328
210.900634765625
210.87908935546875
210.87689208984375
210.87579345703125
210.87570190429688
210.87567138671875</code></pre>
<p>The fitted noise and lengthscales seem reasonable.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">model.noise.noise.detach()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([0.0906])</code></pre>
</div>
</div>
<pre><code>tensor([0.0906])</code></pre>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">model.covar_module.base_kernel.lengthscale.detach()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[1.6206, 0.9185, 1.6307]])</code></pre>
</div>
</div>
<pre><code>tensor([[1.6206, 0.9185, 1.6307]])</code></pre>
<p>Prediction with a Gaussian process is just a matter of cranking through the Gaussian conditioning equations. I’m avoiding gpytorch’s high level interface here, as we’ll need the additional flexibility that comes from doing this manually.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> predict(X, test_X, Y):</span>
<span id="cb26-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb26-3">        prior_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(X)</span>
<span id="cb26-4">        prior_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(test_X)</span>
<span id="cb26-5">        X_tk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.covar_module.forward(test_X, X)</span>
<span id="cb26-6">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_tk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.linalg.solve(prior_x.covariance_matrix, Y)</span>
<span id="cb26-7">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prior_t.covariance_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X_tk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.linalg.solve(prior_x.covariance_matrix, X_tk.T)</span>
<span id="cb26-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> MultivariateNormal(mu.T, S)</span></code></pre></div></div>
</div>
<p>Here, then, is our counterfactual prediction for Texas’s incarceration rate based on the training data from all the other states. There’s a lot of uncertainty shown by the blue shading, but we can guess the general trend.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">non_texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.delete(np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>), texix)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">X_no_texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.from_numpy(data[non_texas, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">y_no_texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.from_numpy(data[non_texas,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">X_texas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.from_numpy(data[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,texix, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predict(X_no_texas, X_texas, y_no_texas)</span>
<span id="cb31-2">lower, upper <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predictions.confidence_region()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">plt.fill_between(years, lower[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].numpy(), upper[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].numpy(), alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb32-2">plt.plot(years, data[texix,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb32-3">plt.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1993</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/SyntheticControl_files/figure-html/unnamed-chunk-26-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/{attach}SyntheticControl_files/SyntheticControl_33_0.png" class="img-fluid figure-img"></p>
<figcaption>png</figcaption>
</figure>
</div>
<p>Texas fits the model just fine pre-1993, but quickly deviates after its building boom. We can show just how atypical this lack of fit is using a randomization test. We’ll collect the log likelihoods of each state’s post ’93 observations in the posterior predictive we obtained from fitting on the other states. The fraction of states with likelihoods below that of Texas gives us a p-value: the probability of seeing a fit as bad as Texas’s if the treatment effect were zero.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">post_93 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.from_numpy(data[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">state_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb34-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>):</span>
<span id="cb34-3">    ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.delete(np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>), i)</span>
<span id="cb34-4">    post_prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predict(X[ixs], X[i:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], post_93[ixs]).log_prob(post_93[i:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].T)</span>
<span id="cb34-5">    state_probs.append(post_prob.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>())</span>
<span id="cb34-6">state_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(state_probs, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(torch.argsort(state_probs)).index(texix) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(state_probs)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.02</code></pre>
</div>
</div>
<pre><code>0.02</code></pre>
<p>If we’re okay with a 2% false positive rate, we can reject the null hypothesis that the treatment effect is zero.</p>
<p>We can examine the contribution of top states towards our synthetic version of texas as follows:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> state_contrib(model):</span>
<span id="cb38-2">    X_kk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.covar_module.forward(X_no_texas, X_no_texas)</span>
<span id="cb38-3">    X_kt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.covar_module.forward(X_no_texas, X_texas)</span>
<span id="cb38-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.linalg.solve(X_kk, X_kt)[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">cs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state_contrib(model)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.argsort(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>cs)[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(states[non_texas][ixs], cs[ixs].detach()))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[('South Dakota', tensor(2.1369)), ('Virginia', tensor(1.6360)), ('Missouri', tensor(1.5237))]</code></pre>
</div>
</div>
<pre><code>[('South Dakota', tensor(2.1369)),
 ('Virginia', tensor(1.6360)),
 ('Missouri', tensor(1.5237))]</code></pre>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">similar_states <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[non_texas][ixs,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div></div>
</div>
<p>We can overlay the trajectory of the similar states themselves below:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> similar_states:</span>
<span id="cb45-2">    plt.plot(years, r, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb45-3">plt.fill_between(years, lower[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].numpy(), upper[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].numpy(), alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb45-4">plt.plot(years, data[texix,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb45-5">plt.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1993</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/SyntheticControl_files/figure-html/unnamed-chunk-35-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/{attach}SyntheticControl_files/SyntheticControl_46_0.png" class="img-fluid figure-img"></p>
<figcaption>png</figcaption>
</figure>
</div>
<p>Just because the Gaussian process model fits Texas worse than any other state, however, doesn’t mean it’s actually fitting the other states all that well.</p>
<p>To see how well the model fits the other states, we can do some leave-one-out cross validation. Specifically, we can check that the observed incarceration distribution for past and future years is similar to that of samples from the leave-one-out posterior predictive distribution. Below, the orange line shows the observed distribution of incarceration rate z scores, while the blue lines are leave-one-out posterior predictive samples.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb46-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">49</span>):</span>
<span id="cb46-3">    ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.delete(np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">49</span>), i)</span>
<span id="cb46-4">    post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predict(X_no_texas[ixs], X_no_texas[i:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], y_no_texas[ixs]).sample(torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>]))</span>
<span id="cb46-5">    results.append(post)</span>
<span id="cb46-6">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.concat(results, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb47-2">    sns.kdeplot(results[i].ravel(), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C0'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb47-3">sns.kdeplot(y_no_texas.ravel(), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/SyntheticControl_files/figure-html/unnamed-chunk-37-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/{attach}SyntheticControl_files/SyntheticControl_50_0.png" class="img-fluid figure-img"></p>
<figcaption>png</figcaption>
</figure>
</div>
<p>The fit is pretty good, but the wiggle on the right side of the orange plot indicates that our data gives somewhat higher incarceration rates than the predictive posterior would suggest. Let’s break this down by year.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb48-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (dist, obs, ax) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(results.permute((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)), y_no_texas[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>:].T, axs.ravel()):</span>
<span id="cb48-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb48-4">        sns.kdeplot(dist[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C0'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb48-5">    sns.kdeplot(obs, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb48-6">plt.tight_layout()</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/SyntheticControl_files/figure-html/unnamed-chunk-38-9.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/{attach}SyntheticControl_files/SyntheticControl_52_0.png" class="img-fluid figure-img"></p>
<figcaption>png</figcaption>
</figure>
</div>
<p>In earlier years, everything seems okay. But by ’98, that extra little hump starts appearing on the right. While other states weren’t increasing their rates as fast as Texas was, it does seem like the model isn’t quite describing them correctly.</p>
<p>We can validate this lack of fit further by checking probability-integral-transform values. The fraction of the leave-one-out posterior predictive distribution below each observation would be uniform under perfect caliration.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> to_univariate(post):</span>
<span id="cb49-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> Normal(post.mean, post.covariance_matrix.ravel())</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb50-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">49</span>):</span>
<span id="cb50-3">    ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.delete(np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">49</span>), i)</span>
<span id="cb50-4">    post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predict(X_no_texas[ixs], X_no_texas[i:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], y_no_texas[ixs])</span>
<span id="cb50-5">    results.append(to_univariate(post).cdf(y_no_texas[i:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]))</span>
<span id="cb50-6">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.concat(results, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">sns.displot(results.ravel())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/SyntheticControl_files/figure-html/unnamed-chunk-41-11.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/synth_control/{attach}SyntheticControl_files/SyntheticControl_57_0.png" class="img-fluid figure-img"></p>
<figcaption>png</figcaption>
</figure>
</div>
<p>The posterior predictive distributions seem to be quite under-dispersed relative to the observations. We need a better model! But I’ll leave that to a future post.</p>



 ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/synth_control/SyntheticControl.html</guid>
  <pubDate>Sat, 25 Jan 2025 06:00:00 GMT</pubDate>
</item>
<item>
  <title>Hop Lists</title>
  <link>https://samanklesaria.github.io/posts/hoplists/HopLists.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p><em>Hop Lists</em> are a novel retroactive set data-structure that allow for a branching timeline. Each hop list node <img src="https://latex.codecogs.com/png.latex?h_t"> is associated with a specific time <img src="https://latex.codecogs.com/png.latex?t"> and a randomly chosen height <img src="https://latex.codecogs.com/png.latex?L_t">. The interface consists of three methods:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bcurrent%7D(h_t)"> gets the set of elements we would see at time <img src="https://latex.codecogs.com/png.latex?t">.</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Badvance%7D(h_t)"> creates a new node <img src="https://latex.codecogs.com/png.latex?h_%7Bt+1%7D"> allowing queries about the set at time <img src="https://latex.codecogs.com/png.latex?t+1">.</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bpush%7D(h_t,%20v)"> pushes the value <img src="https://latex.codecogs.com/png.latex?v"> into the set at time <img src="https://latex.codecogs.com/png.latex?t">. This value will now appear in the sets associated with all future times <img src="https://latex.codecogs.com/png.latex?t'%20%3Et">.</li>
</ul>
<p>Hop lists nodes store four fields: a set of underlying type <img src="https://latex.codecogs.com/png.latex?S">, a pointer to a predecessor node with heigh at least <img src="https://latex.codecogs.com/png.latex?L_t">, a list of the most recent nodes at each height, and a list of pointers to specific future nodes.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@kwdef</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> HopNode{S}</span>
<span id="cb1-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The new elements since `pred`."</span></span>
<span id="cb1-3">    set<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">S </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">S</span>()</span>
<span id="cb1-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The most recent node at the same height as this one or higher"</span></span>
<span id="cb1-5">    pred<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Union{Nothing,HopNode{S}} </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb1-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(Node, height) pairs sorted by height giving the most recent node at that height"</span></span>
<span id="cb1-7">    levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">LinkedList{Pair{HopNode{S}, Int}} </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nil</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Pair</span>{HopNode{S}, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>})</span>
<span id="cb1-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nodes to update when this node gets updated"</span></span>
<span id="cb1-9">    succs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{HopNode{S}} </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HopNode{S}[]</span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<p>Hop lists maintain the <strong>Predecessor Property</strong>: <em>If hop node <img src="https://latex.codecogs.com/png.latex?h_t"> has predecessor <img src="https://latex.codecogs.com/png.latex?h_s">, then <img src="https://latex.codecogs.com/png.latex?h_t">’s set must store all the elements pushed at times in the interval <img src="https://latex.codecogs.com/png.latex?(s,%20t%5D"></em>.</p>
<p>This means we can find <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bcurrent%7D(h_t)"> by taking the union of <img src="https://latex.codecogs.com/png.latex?h_t">’s ancestors.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Iteration jumps back through `pred` edges</span></span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Base</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iterate</span>(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode</span>=h) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (s, s.pred)</span>
<span id="cb2-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Base</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iterate</span>(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Nothing</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb2-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Base</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">IteratorSize</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Type{HopNode{S}}</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {S} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Base</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SizeUnknown</span>()</span>
<span id="cb2-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Base</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eltype</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Type{HopNode{S}}</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {S} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HopNode{S}</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">current</span>(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapreduce</span>(a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> a.set, union, h)</span></code></pre></div></div>
<p>When we create a new hop node <img src="https://latex.codecogs.com/png.latex?h_%7Bt'%7D%20=%20%5Ctext%7Badvance%7D(h_t)">, we will set the predecessor to be <code>h_t.levels[l]</code> where <img src="https://latex.codecogs.com/png.latex?l%20=%20L_%7Bt'%7D%20%5Csim%20%5Ctext%7BGeom%7D(0.5)">. To ensure that we maintain the <em>predecessor property</em>, we must take the the union of all the predecessor sets we find this way and store them in the new node’s set. The new <code>levels</code> list should remove all entries below <img src="https://latex.codecogs.com/png.latex?L_t"> and add <img src="https://latex.codecogs.com/png.latex?h_t">.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">advance</span>(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode</span>)</span>
<span id="cb3-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Geometric</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb3-3">    pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getpred</span>(h.levels, n)</span>
<span id="cb3-4">    itr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">takewhile</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span>pred, h)</span>
<span id="cb3-5">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HopNode</span>(;pred, set<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapreduce</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>a.set, union, itr))</span>
<span id="cb3-6">    result.levels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cons</span>(result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span>n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">listdrop</span>(h.levels, n))</span>
<span id="cb3-7">    result</span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<p>This uses the utility functions <code>listdrop</code> and <code>getpred</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">listdrop</span>(l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">LinkedList{Pair{A,Int}}</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {A}</span>
<span id="cb4-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> !<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">isempty</span>(l)</span>
<span id="cb4-3">        (_,a) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> l.head</span>
<span id="cb4-4">        a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> l</span>
<span id="cb4-5">        l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> l.tail</span>
<span id="cb4-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb4-7">    l</span>
<span id="cb4-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getpred</span>(l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">LinkedList{Pair{A,Int}}</span>, n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {A}</span>
<span id="cb4-11">    pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb4-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (p, height) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> l</span>
<span id="cb4-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> n</span>
<span id="cb4-14">            pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p</span>
<span id="cb4-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb4-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb4-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb4-18">    pred</span>
<span id="cb4-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<p>For example, if we inserted 1 at time 1, 2 at time 2, and so on up to 6, we might get a HopNode structure that looks like this The black arrows here correspond to <code>pred</code> pointers, the x axis corresponds to time, and the <img src="https://latex.codecogs.com/png.latex?y"> axis gives the height <img src="https://latex.codecogs.com/png.latex?L_t"> of each node <img src="https://latex.codecogs.com/png.latex?h_t">.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/hoplists/hoplist_example.png" class="img-fluid figure-img"></p>
<figcaption>example</figcaption>
</figure>
</div>
<p>The tricky part is handling <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bpush%7D">. We need to give each node <img src="https://latex.codecogs.com/png.latex?h_s"> pointers to all future nodes <img src="https://latex.codecogs.com/png.latex?h_t"> for which <code>h_s.set</code> <img src="https://latex.codecogs.com/png.latex?%5Csubseteq"> <code>h_t.set</code> That way, when we push into <img src="https://latex.codecogs.com/png.latex?h_s">, we know to push into <img src="https://latex.codecogs.com/png.latex?h_t"> as well. This list of pointers will be our <code>succs</code> vector. The idea results in the following code.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Base</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode{S}</span>, v) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {S}</span>
<span id="cb5-2">    q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HopNode{S}[t]</span>
<span id="cb5-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> !<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">isempty</span>(q)</span>
<span id="cb5-4">        t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pop!</span>(q)</span>
<span id="cb5-5">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(t.set, v)</span>
<span id="cb5-6">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append!</span>(q, t.succs)</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb5-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<p>We still need to create these <code>succs</code> pointers in the first place. Each node should have an element of <code>succs</code> pointing to the closest future node with a higher height if one exists.</p>
<p>To fit these requirements, we can modify the <code>advance</code> method as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">advance</span>(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopNode</span>)</span>
<span id="cb6-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Geometric</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb6-3">    pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getpred</span>(h.levels, n)</span>
<span id="cb6-4">    itr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">takewhile</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span>pred, h)</span>
<span id="cb6-5">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HopNode</span>(set<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapreduce</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>a.set, union, itr))</span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> itr</span>
<span id="cb6-7">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(t.succs, result)</span>
<span id="cb6-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb6-9">    result.levels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cons</span>(result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span>n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">listdrop</span>(h.levels, n))</span>
<span id="cb6-10">    result</span>
<span id="cb6-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<p>With the <code>succs</code> pointers visualized in red, the previous example looks as follows:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/hoplists/hoplist_example_2.png" class="img-fluid figure-img"></p>
<figcaption>example2</figcaption>
</figure>
</div>
<p>Note that <code>advance</code> can be called twice on the same node <img src="https://latex.codecogs.com/png.latex?h_t">, producing a branching timeline. Updates to <img src="https://latex.codecogs.com/png.latex?h_t"> will be propagated to both possible futures. This is why we need <code>succs</code> to be a vector rather than simply an optional pointer.</p>
</section>
<section id="average-time-and-space-complexity" class="level3">
<h3 class="anchored" data-anchor-id="average-time-and-space-complexity">Average Time and Space Complexity</h3>
<p>If the size of our timeline is <img src="https://latex.codecogs.com/png.latex?n">, we’ll have on average <img src="https://latex.codecogs.com/png.latex?n"> nodes with height <img src="https://latex.codecogs.com/png.latex?%5Cgeq%201">, <img src="https://latex.codecogs.com/png.latex?n/2"> nodes with height <img src="https://latex.codecogs.com/png.latex?%5Cgeq%202">, and so on up to <img src="https://latex.codecogs.com/png.latex?1"> node with height <img src="https://latex.codecogs.com/png.latex?%5Clog%20n">. If we perform a <code>current</code> query from a node at height <img src="https://latex.codecogs.com/png.latex?1">, it takes on average <img src="https://latex.codecogs.com/png.latex?2"> hops through predecessor nodes to get to a node with height <img src="https://latex.codecogs.com/png.latex?%5Cgeq%202">. This means that after at most <img src="https://latex.codecogs.com/png.latex?2%20%5Clog%20n"> hops on average we should be at the node with height <img src="https://latex.codecogs.com/png.latex?%5Clog%20n"> which has no predecessors. Therefore, the average number of sets we must union to answer a <code>current</code> query is <img src="https://latex.codecogs.com/png.latex?O(%5Clog%20n)"> in expectation.</p>
<p>The average time complexity for <code>push</code> can be found analogously. The <code>push</code> operation follows <code>succ</code> pointers, where the successor to a node is the closest future node with a higher height, if one exists. As traversing each <code>succ</code> pointer takes us to a higher height, the time complexity of <code>push</code> is just the largest height of any node in our timeline, which on average is also <img src="https://latex.codecogs.com/png.latex?O(%5Clog%20n)">.</p>
<p>The same logic allows us to find space complexity. Say we store at most <img src="https://latex.codecogs.com/png.latex?c"> elements in each time-slot. We know that the set associated with any time <img src="https://latex.codecogs.com/png.latex?t"> will be replicated at most <img src="https://latex.codecogs.com/png.latex?%5Clog%20n"> times. So we use at most <img src="https://latex.codecogs.com/png.latex?cn%20%5Clog%20n%20=%20O(n%20%5Clog%20n)"> space for the <code>set</code> fields. For the <code>levels</code> field, each HopNode creates a single linked list node for its <code>levels</code> list, so this contributes <img src="https://latex.codecogs.com/png.latex?O(n)"> space. Each node’s <code>succs</code> field will contain at most one element if the timeline does not branch, so once again we get a linear space contribution. This gives total space complexity <img src="https://latex.codecogs.com/png.latex?O(n%20%5Clog%20n)">.</p>
</section>
<section id="concentration-bounds" class="level3">
<h3 class="anchored" data-anchor-id="concentration-bounds">Concentration Bounds</h3>
<p>We know from the previous section that the time it takes to insert an element is at most the maximum height of any node in the timeline. The probability that the maximum height of any node in a timeline is above <img src="https://latex.codecogs.com/png.latex?k"> is <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;1%20-%20%5Cprod_%7Bi=1%7D%5En%20P(h_i%20%5Ctext%7B%20has%20height%20below%20$k$%7D)%20%5C%5C%0A&amp;=%201%20-%20(1%20-%202%5E%7B-k%7D)%5En%0A%5Cend%7Balign*%7D%0A"> For <img src="https://latex.codecogs.com/png.latex?k=2%5Clog_2%20n">, we get <img src="https://latex.codecogs.com/png.latex?%0A1%20-%20%5Cleft(1%20-%20%5Cfrac%7B1%7D%7Bn%5E2%7D%5Cright)%5En%0A"> But <img src="https://latex.codecogs.com/png.latex?%5Clim_%7Bn%20%5Cto%20%5Cinfty%7D%20%5Cleft(1%20-%20%5Cfrac%7B1%7D%7Bn%5E2%7D%5Cright)%5En%20=%201">. So the probability of insertion being any worse than <img src="https://latex.codecogs.com/png.latex?2%5Clog_2%20n"> goes to zero.</p>
<p>To bound the number of backward hops taken by <code>current</code> queries, we can find the probability it takes <img src="https://latex.codecogs.com/png.latex?%5Cleq%20k"> hops to iterate backwards from a node <img src="https://latex.codecogs.com/png.latex?h_n"> with height <img src="https://latex.codecogs.com/png.latex?1">. We can lower bound this by the probability that it takes <img src="https://latex.codecogs.com/png.latex?%5Cleq%20k/L"> hops to get to a node with height 2, times the probability it takes <img src="https://latex.codecogs.com/png.latex?%5Cleq%20k/L"> hops to get to a node with height 3, and so on up to the maximum height <img src="https://latex.codecogs.com/png.latex?L">. This is <img src="https://latex.codecogs.com/png.latex?%0A(1%20-%202%5E%7B-k/L%7D)%5EL%0A"> For <img src="https://latex.codecogs.com/png.latex?k%20=%202L%5Clog_2%20L">, we get the probability <img src="https://latex.codecogs.com/png.latex?%0A%5Cleft(1%20-%20%5Cfrac%7B1%7D%7BL%5E2%7D%5Cright)%5EL%0A"> As <img src="https://latex.codecogs.com/png.latex?L%20%5Cto%20%5Cinfty"> this converges to <img src="https://latex.codecogs.com/png.latex?1">, meaning that the probability a <code>current</code> query takes more than <img src="https://latex.codecogs.com/png.latex?2%20L%20%5Clog_2L"> time falls to zero.</p>
</section>
<section id="height-free-variant" class="level3">
<h3 class="anchored" data-anchor-id="height-free-variant">Height-Free Variant</h3>
<p>We can construct a variant of the data structure described that does not use a <code>levels</code> list. Instead, when we create a new hop node <img src="https://latex.codecogs.com/png.latex?h_%7Bt'%7D%20=%20%5Ctext%7Badvance%7D(h_t)">, we will set the predecessor by sampling <img src="https://latex.codecogs.com/png.latex?n%20%5Csim%20%5Ctext%7BGeom%7D(0.5)"> and then taking <img src="https://latex.codecogs.com/png.latex?n"> predecessor hops back from <img src="https://latex.codecogs.com/png.latex?h_t">. Specifically, we would have</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">advance</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">HopList2</span>)</span>
<span id="cb7-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Geometric</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb7-3">    itr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Iterators</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Iterators</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">take</span>(t, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-4">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HopList2</span>()</span>
<span id="cb7-5">    set, pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(itr; init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>, t)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span> (s, p), a</span>
<span id="cb7-6">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(p.succs, result)</span>
<span id="cb7-7">        (s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">∪</span> p.set, a)</span>
<span id="cb7-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb7-9">    result.set <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> set</span>
<span id="cb7-10">    result.pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pred</span>
<span id="cb7-11">    result</span>
<span id="cb7-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<p>Analysis of this variant is more difficult. Let the number of hops back to the start of time from node <img src="https://latex.codecogs.com/png.latex?h_t"> be given by <img src="https://latex.codecogs.com/png.latex?X_t">. It’s easy to see that <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AX_0%20&amp;=%200%20%5C%5C%0AX_t%20&amp;=%20%5Cmax(0,%20X_%7Bt-1%7D%20+%201%20-%20G_t)%0A%5Cend%7Balign*%7D%0A"> where <img src="https://latex.codecogs.com/png.latex?G_t%20%5Csim%20%5Ctext%7BGeom%7D(0.5)">. Simulating samples from this stochastic process seems to indicate that <img src="https://latex.codecogs.com/png.latex?X_t"> scales as <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7Bt%7D"> rather than <img src="https://latex.codecogs.com/png.latex?%5Clog%20t"> as in the original structure. But insertions into the height-free variant seem to be much faster than those into the original structure in practice. Thorough analysis of why this is the case remains to be done.</p>
</section>
<section id="extensions" class="level3">
<h3 class="anchored" data-anchor-id="extensions">Extensions</h3>
<p>While I have introduced these datastructures as retroactive set, they can compute partial sums of arbitrary monoids. For example, you can use them to compute prefix sums of a changing list of numbers.</p>


</section>

 ]]></description>
  <category>algorithms</category>
  <guid>https://samanklesaria.github.io/posts/hoplists/HopLists.html</guid>
  <pubDate>Sat, 05 Oct 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Graph SLAM</title>
  <link>https://samanklesaria.github.io/posts/graphslam/graphslam.html</link>
  <description><![CDATA[ 





<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">SparseArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">RecursiveArrayTools</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Unzip</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ExtendableSparse</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ForwardDiff</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">DiffResults</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">AppleAccelerate</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CairoMakie</span></span></code></pre></div></div>
</div>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1">CairoMakie.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enable_only_mime!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svg"</span>)</span></code></pre></div></div>
</div>
<p>For a robot to navigate autonomously, it needs to learn both its own location, as well as the locations of any potential obsticles around it, given its sensors’ observations of the world. We’ll create a probabilistic model of our environment and get a MAP estimate of these unknown quantities.</p>
<ul>
<li>Let <img src="https://latex.codecogs.com/png.latex?x_t%20%5Cin%20%5Cmathbb%7BR%7D%5E2"> be the robot’s location at time <img src="https://latex.codecogs.com/png.latex?t">.</li>
<li>Let <img src="https://latex.codecogs.com/png.latex?%CE%B8_t%20%5Cin%20%5Cmathbb%7BR%7D"> be the robot’s heading angle at time <img src="https://latex.codecogs.com/png.latex?t">.</li>
<li>Let <img src="https://latex.codecogs.com/png.latex?m_i%20%5Cin%20%5Cmathbb%7BR%7D%5E2"> be the position of the <img src="https://latex.codecogs.com/png.latex?i">th obstacle.</li>
<li>Let <img src="https://latex.codecogs.com/png.latex?o_%7Bt,%20i%7D%20%5Cin%20%5Cmathbb%7BR%7D%5E2"> be our robot’s noisy observation of its distance at time <img src="https://latex.codecogs.com/png.latex?t"> to obstacle <img src="https://latex.codecogs.com/png.latex?i">.</li>
</ul>
<section id="motion-model" class="level1">
<h1>Motion Model</h1>
<p>We will assume that the robot advances approximately one step forward (in its local coordiante system) at each timestep. Let <img src="https://latex.codecogs.com/png.latex?R(%5Ctheta)"> be a rotation matrix that converts coordinates in the <img src="https://latex.codecogs.com/png.latex?%5Ctheta">-rotated coordinate frame to global coordinates</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(x_t%20%7C%20x_%7Bt-1%7D)%20=%20%5Cmathcal%7BN%7D%5Cleft(x_%7Bt-1%7D%20+%20R(%5Ctheta_%7Bt-1%7D)%20%5Cbegin%7Bbmatrix%7D%201%20%201%20%5Cend%7Bbmatrix%7D,%20%5Csigma%5E2_x%20I%5Cright)%0A"></p>
<p>We also assume that the heading angle increases by approximately <img src="https://latex.codecogs.com/png.latex?2%5Cpi/100"> radians each step, so that <img src="https://latex.codecogs.com/png.latex?p(%5Ctheta_t%20%7C%20%5Ctheta_%7Bt-1%7D)%20=%20%5Cmathcal%7BN%7D(%5Ctheta_%7Bt-1%7D%20+%20%5Cfrac%7B2%5Cpi%7D%7B100%7D,%20%5Csigma%5E2_%CE%B8)">. Let</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ay_t%20=%20%5Cbegin%7Bbmatrix%7D%20x_t%20%20%5Ctheta_t%20%5Cend%7Bbmatrix%7D%0A"></p>
<p>combine the location and heading parameters, and <img src="https://latex.codecogs.com/png.latex?y"> be the vector of all the <img src="https://latex.codecogs.com/png.latex?y_t">. In the code that follows, Gaussian distributions will be represented by their mean and covariance parameters. For reasons we’ll see later on, it will be easiest to express the mean at time <img src="https://latex.codecogs.com/png.latex?t"> by indexing into <img src="https://latex.codecogs.com/png.latex?y_%7Bt-1%7D">.</p>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1">Σ_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×2 Diagonal{Float64, Vector{Float64}}:
 0.05   ⋅ 
  ⋅    0.05</code></pre>
</div>
</div>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_θ</span>(y, θ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y[θ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>θ] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>π<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>μ_θ (generic function with 1 method)</code></pre>
</div>
</div>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1">Σ_θ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.008</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>0.008</code></pre>
</div>
</div>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rot</span>(t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(t) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-sin</span>(t); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(t) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(t)]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>rot (generic function with 1 method)</code></pre>
</div>
</div>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_x</span>(y, x, θ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y[x] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rot</span>(y[θ]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>μ_x (generic function with 1 method)</code></pre>
</div>
</div>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1">start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3-element Vector{Float64}:
 0.0
 0.0
 0.0</code></pre>
</div>
</div>
</section>
<section id="simulating-the-model" class="level1">
<h1>Simulating the Model</h1>
<p>Let’s simulate a robot trajectory that obeys this motion model for <img src="https://latex.codecogs.com/png.latex?T"> timesteps. We’ll try to reconstruct this trajectory with a maximum likelihood approach in the next section.</p>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1">T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>100</code></pre>
</div>
</div>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_step</span>(y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_x</span>(y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_θ</span>(y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>mean_step (generic function with 1 method)</code></pre>
</div>
</div>
<p>Without noise, the robot’s trajectory would look like this, with the color changing from black to yellow over time.</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1">yhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VectorOfArray</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">accumulate</span>((y,_)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_step</span>(y), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T; init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>VectorOfArray{Float64,2}:
100-element Vector{Vector{Float64}}:
 [1.0, 0.0, 0.06283185307179587]
 [1.9980267284282716, 0.06279051952931337, 0.12566370614359174]
 [2.9901414297427493, 0.18812375309361762, 0.1884955592153876]
 [3.972428680471438, 0.3755050676793422, 0.25132741228718347]
 [4.941011841600069, 0.624194954844197, 0.3141592653589793]
 [5.892068357895223, 0.9332119492191444, 0.37699111843077515]
 [6.821844843783475, 1.3013365019038223, 0.439822971502571]
 [7.726671896249494, 1.727115793468895, 0.5026548245743668]
 [8.602978576293358, 2.20886946757061, 0.5654866776461627]
 [9.447306501795373, 2.7446962625496067, 0.6283185307179585]
 ⋮
 [-7.602978576293377, 2.208869467570511, 5.780530482605213]
 [-6.726671896249516, 1.7271157934687904, 5.843362335677009]
 [-5.8218448437834995, 1.3013365019037118, 5.906194188748804]
 [-4.89206835789525, 0.9332119492190273, 5.9690260418206]
 [-3.941011841600099, 0.6241949548440728, 6.031857894892395]
 [-2.9724286804714697, 0.3755050676792106, 6.094689747964191]
 [-1.9901414297427826, 0.18812375309347806, 6.157521601035986]
 [-0.9980267284283059, 0.06279051952916548, 6.220353454107782]
 [-3.4861002973229915e-14, -1.566524687746096e-13, 6.283185307179577]</code></pre>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb21-2">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f1)</span>
<span id="cb21-3">    p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(yhat[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], yhat[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T)</span>
<span id="cb21-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Colorbar</span>(f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], p1)</span>
<span id="cb21-5">    f1</span>
<span id="cb21-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/graphslam/graphslam_files/figure-html/cell-13-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>But as we’ve assumed some noise at each step, the true trajectory is a little more wiggly.</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>(y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MultivariateNormal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_x</span>(y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), Σ_x)); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Normal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_θ</span>(y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], Σ_θ))]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>step (generic function with 1 method)</code></pre>
</div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1">true_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VectorOfArray</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">accumulate</span>((y,_)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>(y), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T; init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>VectorOfArray{Float64,2}:
100-element Vector{Vector{Float64}}:
 [0.9948369008080734, -0.17881455800404114, 0.06813995060080176]
 [2.2627930974742254, 0.17186151904112557, 0.12975149463685665]
 [3.2577831373702573, -0.10985759933358524, 0.1829090984073673]
 [4.400490027838276, 0.025835244482602535, 0.2454353075657262]
 [5.287719367549745, 0.33742069041111256, 0.33541549600906045]
 [6.189569042596519, 0.3940744827551949, 0.4010285171119553]
 [6.9437488500664895, 0.4715841172952981, 0.45651471287207906]
 [7.972843771064869, 1.3090087381507867, 0.5219706310461045]
 [8.80959728633984, 1.6739948567368281, 0.6084779835161396]
 [10.08790868778338, 2.3364002859826782, 0.6766190544277169]
 ⋮
 [-8.286488651409167, 4.725160020949448, 5.858871709439354]
 [-7.462292377502831, 4.310271190958247, 5.92407834074762]
 [-6.299206837132079, 3.9592901447036657, 5.989198227579204]
 [-5.0048292897616315, 3.031484767839803, 6.051276214969418]
 [-4.101678423979381, 2.951706786370477, 6.115026977729722]
 [-3.174101632699504, 2.518573445277533, 6.184476993977584]
 [-2.2918628875042364, 2.3265372408595124, 6.242626128695027]
 [-1.1511843642951767, 2.8874967492862282, 6.313806498956315]
 [0.26107996338269074, 2.8672711545305583, 6.374629526124709]</code></pre>
</div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb26-2">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f1)</span>
<span id="cb26-3">    p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T)</span>
<span id="cb26-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Colorbar</span>(f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], p1)</span>
<span id="cb26-5">    f1</span>
<span id="cb26-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/graphslam/graphslam_files/figure-html/cell-16-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="obstacle-location-prior" class="level1">
<h1>Obstacle Location Prior</h1>
<p>We will assume an uninformative prior over the locations of our <img src="https://latex.codecogs.com/png.latex?k"> potential obstacles <img src="https://latex.codecogs.com/png.latex?m">: <img src="https://latex.codecogs.com/png.latex?m_i%20%5Csim%20%5Cmathcal%7BN%7D(0,%20%5CSigma_m)">. For consistency with the earlier mean method defined for positions <img src="https://latex.codecogs.com/png.latex?x">, the mean function for obstacles will take a dummy argument.</p>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>10</code></pre>
</div>
</div>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_m</span>(_) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>μ_m (generic function with 1 method)</code></pre>
</div>
</div>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1">Σ_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×2 Diagonal{Int64, Vector{Int64}}:
 100    ⋅
   ⋅  100</code></pre>
</div>
</div>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1">true_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MultivariateNormal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_m</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>), Σ_m), k)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×10 Matrix{Float64}:
 6.55633  25.9119   10.7696  -3.08722  …  19.4976    3.42704  -6.70656
 8.74785   4.83715  20.3582  19.8423       4.63834  -3.50851   7.83388</code></pre>
</div>
</div>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb35-2">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f1)</span>
<span id="cb35-3">    p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"robot trajectory"</span>)</span>
<span id="cb35-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_m[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_m[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=:</span>red, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"map points"</span>)</span>
<span id="cb35-5">    f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Legend</span>(f1, ax1)</span>
<span id="cb35-6">    f1</span>
<span id="cb35-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/graphslam/graphslam_files/figure-html/cell-21-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let <img src="https://latex.codecogs.com/png.latex?%0Az%20=%20%5Cbegin%7Bbmatrix%7D%20y%20%20m%20%5Cend%7Bbmatrix%7D%0A"> combine the ego and obstacle parameters.</p>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1">true_z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec</span>(true_y); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec</span>(true_m)]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>320-element Vector{Float64}:
  0.9948369008080734
 -0.17881455800404114
  0.06813995060080176
  2.2627930974742254
  0.17186151904112557
  0.12975149463685665
  3.2577831373702573
 -0.10985759933358524
  0.1829090984073673
  4.400490027838276
  ⋮
 20.087161874125705
 16.98673666207452
 26.761324025474323
 19.497590609511285
  4.638343755581045
  3.427042183951291
 -3.5085063520697517
 -6.706558668864389
  7.833875387182863</code></pre>
</div>
</div>
</section>
<section id="observation-model" class="level1">
<h1>Observation Model</h1>
<p>Let <img src="https://latex.codecogs.com/png.latex?p(o_%7Bt,%20i%7D%20%7C%20x_t,%20%CE%B8_t,%20m_i)%20=%20%5Cmathcal%7BN%7D(R(-%CE%B8_t)(m_i%20-%20x_t),%20%CE%A3_o)">, so that the robot’s sensor tells it approximately how close each map point is in its local coordinate frame.</p>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_obs</span>(z, x, θ, m) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rot</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>z[θ]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (z[m] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> z[x])</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>μ_obs (generic function with 1 method)</code></pre>
</div>
</div>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1">Σ_obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×2 Diagonal{Float64, Vector{Float64}}:
 0.1   ⋅ 
  ⋅   0.1</code></pre>
</div>
</div>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1">obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VectorOfArray</span>([<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VectorOfArray</span>([</span>
<span id="cb42-2">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MultivariateNormal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_obs</span>(true_z, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)), Σ_obs)) for m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]) for t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)])</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>VectorOfArray{Float64,3}:
100-element Vector{VectorOfArray{Float64, 2, Vector{Vector{Float64}}}}:
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[6.013700145086878, 8.368164266295134], [24.568021744453933, 3.6157091049669656], [11.23778228240714, 19.222792500273055], [-2.7040300052210795, 19.792162726658354], [11.250628280481457, -1.6887668931377868], [16.027211901569483, 19.032850002087653], [17.778324286305484, 25.8465606216527], [19.441293019621643, 3.8879295067523945], [1.8809069271553998, -3.251827387382284], [-7.432381353009933, 8.645019960045108]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[5.641985228875032, 7.924150333390872], [24.474762791025697, 1.5399668441475096], [10.896505350585308, 19.14184066164264], [-2.8898071407213397, 19.79983657318185], [9.749145325474837, -3.2938891127184835], [15.803316027431402, 18.16650234550198], [17.878814119398438, 24.86620332021086], [17.671848850537003, 2.078932762216099], [0.5769536724566005, -4.355619037474067], [-8.207967964723636, 8.985428046601001]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[4.851631808665426, 8.188085448607072], [22.948895587595022, 0.43775846135747726], [11.005179454038947, 18.59536299257642], [-2.805042873203761, 20.84842826750874], [8.505294699591524, -2.6997322648621034], [15.70012657408447, 17.572421151893366], [18.128916953436377, 23.834553381464215], [16.780208160819445, 2.1368667977760416], [-0.7400891037317023, -3.417356665861245], [-7.912720993040339, 9.534565325810163]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[4.048231394317695, 7.721987916874405], [21.71834476032371, -0.5659096212098226], [10.88881162981954, 17.926602832838835], [-2.042645731965736, 21.06910413938711], [7.006996582086496, -2.8700125188555052], [16.18457477434436, 16.97570115207072], [18.80072063154177, 23.462534798530292], [16.021686390387767, 0.5784537452527012], [-1.6102837184467977, -3.530878884865166], [-8.539929896505848, 10.424353745640826]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[3.63090613235886, 7.550792587951964], [21.19886142760244, -2.899881179137308], [11.445282614446857, 16.829170336602218], [-1.5711220247939073, 21.216618198260317], [5.9946431651363925, -4.22151707487656], [16.84201289628381, 15.135162281477065], [19.897419903902616, 21.509982311505958], [14.812395117449746, -0.30171320319528583], [-2.9705849900207686, -3.0753253031980003], [-9.351472933012097, 11.256286706657121]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[4.1567292874234045, 7.217876989269879], [20.031530259147335, -3.805016511339554], [11.805343841699973, 17.15847024793535], [-0.9494894059627843, 21.411926277598948], [5.269723616963123, -4.028733124369017], [16.758682983305825, 14.14696720211139], [19.959509571468296, 19.99039322133718], [13.224448152122887, -1.0309267036091796], [-3.5222001411460484, -2.6497070522637056], [-8.954298046447112, 11.774280435000888]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[3.1741880442516948, 7.278860356736828], [18.87521422440231, -4.472497094503896], [11.800325404846303, 16.295369409287265], [-0.7171437115541555, 21.53254662271214], [3.2856046187068175, -3.370560611170286], [16.310533683090117, 13.617389923037623], [20.89472387664705, 18.705680477004066], [13.365791953957965, -1.495587523708471], [-4.7323986077301425, -2.4427779029098704], [-8.882759283217794, 12.533620977684915]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[2.0425556099387574, 7.066129125669452], [17.598079572324643, -5.502543567288933], [12.075143487583459, 15.85152134744959], [-0.5393243431996848, 21.469407020903695], [2.561477443413501, -4.446991446491485], [16.082759754634296, 11.83419562578087], [20.822299827955526, 17.644956151132828], [11.718433710022705, -3.14677933192268], [-6.66235093454659, -1.8072160990252237], [-9.750416360283822, 12.359686401888242]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[2.2816570565727656, 7.383041195033532], [15.808228099440342, -7.550027191654502], [11.507667669820282, 13.967166455229231], [0.5884347133759719, 20.86134703635186], [0.6756153569732424, -4.340809047211794], [16.47356421296756, 11.108958142749307], [20.95613108347853, 15.883372806979661], [10.563130717995497, -3.468325849068952], [-7.146941348087052, -0.4041440353753609], [-9.24822537609671, 13.702260824489597]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[1.6793343967549705, 7.036795779767694], [13.360779749114423, -7.9647506399299255], [11.236228718586213, 13.969091821537623], [1.0391408118453676, 21.900876838648326], [-0.10684530555668281, -4.395463121679125], [15.140171375134607, 9.934715867253184], [20.712718472833604, 15.052217576577188], [9.145744140662826, -4.081860230417136], [-8.923938796838996, -0.11272085563531176], [-9.413796486221301, 14.94540366680314]])
 ⋮
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[11.895435519097228, 10.096250080587007], [30.975050523300183, 14.45443709898133], [11.135232297052879, 22.64729705590045], [-1.71080986823068, 15.406779695838383], [20.658265969190452, 3.838088694804081], [15.233762630418745, 23.734209497280688], [13.698979348814278, 30.149769005198372], [24.84130959192779, 11.402516186176626], [13.913990328907596, -3.308575062072246], [0.2700971701232535, 3.3249075529248797]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[11.544045405312193, 9.06021770042106], [31.029513316602163, 13.163344230056122], [11.58933285912982, 21.653482692182195], [-1.3537117605130766, 16.097935654330694], [20.358796399141443, 1.6629414343363025], [15.91514387742586, 23.2570196053237], [14.649109298607984, 29.916763958813313], [25.45425630262209, 10.045359892816323], [13.294676732727366, -2.963936492473572], [-0.25029973900567865, 3.1924000111842177]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[11.045652254232264, 8.619982301082722], [30.477238913040956, 10.674471999285572], [11.291262593919816, 20.782892126283105], [-1.9471137886124064, 15.816602347816609], [19.128166048454982, 0.45362865668916885], [16.40449799707704, 21.75446187297804], [15.68190718601276, 28.832763883748935], [23.68335834622055, 8.045926400443612], [11.841980930405585, -4.5323125356999405], [-1.4837503894146615, 4.237739513970863]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[9.864512396788715, 8.174355969610168], [29.64109550471643, 8.94464529078981], [11.74909722916652, 21.083713859941614], [-2.1196222870955834, 17.16313205691649], [17.584766293952026, -0.26954654517960586], [16.328243760948826, 21.16344789096051], [16.16578259093745, 27.811516254603013], [23.541726969840862, 6.837205505173892], [9.827960898326841, -4.52230863369103], [-3.685379588831624, 4.64562622457701]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[9.335691826213935, 7.607209026495554], [29.45240430760495, 6.21606512830997], [11.90890616348594, 19.66088439355682], [-2.0329608490032243, 16.705853074573707], [17.288944713096615, -1.16570411797972], [16.891583909028103, 20.100892575353356], [17.403731679617888, 27.02663611787579], [23.672802301167607, 5.45259331883669], [8.604313192351126, -5.224359270684223], [-3.247508519731462, 4.092589703568361]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[8.919742708155354, 7.245067771309988], [28.36992146744046, 5.723139469478966], [12.390020064954982, 18.64410819705427], [-1.151716565306933, 17.289944341814728], [15.000327482057703, -1.7008403954528681], [16.959186573295256, 19.620865492493625], [17.7002432735754, 26.018009499617758], [22.862309288611925, 4.881388901683297], [7.233238624850517, -5.320660824135512], [-3.636429232574335, 5.438673018619582]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[8.279106326855326, 7.149463899354719], [28.091268735912287, 3.6646525160383265], [12.207777477591296, 18.55169023921717], [-1.0393831156839681, 17.730881363829212], [14.462496539724393, -2.9068150158810058], [17.29448503387057, 18.55333657403531], [18.116942128466697, 25.877334959834457], [21.801692311606093, 2.6985815160041837], [5.865153526042226, -5.294348183788221], [-4.383202346059136, 5.140777560712807]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[7.871969763556479, 5.693281179819593], [27.079311433478527, 1.0222543664256254], [12.829613327905994, 17.009600131285378], [-0.9388450513507693, 16.854425667022767], [13.432432475396185, -4.764050539289802], [17.64484260642448, 16.789186893496602], [18.992102332827866, 23.22148939098534], [21.136826483389267, 0.9763542938789962], [4.451279536187137, -6.384753657386503], [-5.609142471465136, 4.931707956247374]])
 VectorOfArray{Float64, 2, Vector{Vector{Float64}}}([[6.739357850166455, 5.314592282275178], [25.824003013561565, -0.44346792418659314], [12.613184509356499, 16.829002244521998], [-1.9804481682466397, 17.148558489846486], [11.331549703798766, -5.239902906708373], [16.671274647209334, 15.523578816652083], [18.808836993675946, 21.73238749095739], [18.961881301347855, 0.29836699013508333], [2.304305953590278, -6.099487027629671], [-6.608484484768158, 5.967973441682578]])</code></pre>
</div>
</div>
<p>The following plots our observations over time, from black at the start to yellow at time <img src="https://latex.codecogs.com/png.latex?T">. The swirling shape comes from the fact that the robot spins as it moves.</p>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb44-2">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f)</span>
<span id="cb44-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>k</span>
<span id="cb44-4">        p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(obs[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,i,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], obs[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, i,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T)</span>
<span id="cb44-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb44-6">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Colorbar</span>(f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], p1)</span>
<span id="cb44-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb44-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb44-9">    f</span>
<span id="cb44-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/graphslam/graphslam_files/figure-html/cell-26-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="guessing-an-initial-trajectory" class="level1">
<h1>Guessing an Initial Trajectory</h1>
<p>We’ll start out with our guess <img src="https://latex.codecogs.com/png.latex?%5Chat%7By%7D"> as the mean of the motion model. We’ll guess <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bm%7D"> by just sampling from the prior.</p>
<div id="52" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1">mhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MultivariateNormal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_m</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>), Σ_m), k)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×10 Matrix{Float64}:
  9.77342   3.92698  14.6207    …  27.3042  -4.2041   8.7704   10.2939
 -0.432306  3.51201  -0.757796      4.7226   8.80291  1.73778  25.5637</code></pre>
</div>
</div>
<div id="54" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1">zhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec</span>(yhat); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec</span>(mhat)]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>320-element Vector{Float64}:
  1.0
  0.0
  0.06283185307179587
  1.9980267284282716
  0.06279051952931337
  0.12566370614359174
  2.9901414297427493
  0.18812375309361762
  0.1884955592153876
  3.972428680471438
  ⋮
  4.6246080767284585
 27.30417657249438
  4.722597230875135
 -4.204101557016603
  8.80290626371208
  8.770396239663455
  1.7377838203908151
 10.293861660079147
 25.5637364438413</code></pre>
</div>
</div>
</section>
<section id="assembling-trajectory-probability" class="level1">
<h1>Assembling Trajectory Probability</h1>
<p>The negative joint log density of our guess and observations <img src="https://latex.codecogs.com/png.latex?L(y,%20m)"> is a sum of factors <img src="https://latex.codecogs.com/png.latex?L_i%20=%20(v_i%20-%20%CE%BC_i(z))%5ET%CE%9B_i(v_i%20-%20%CE%BC_i(z))"> for different variables <img src="https://latex.codecogs.com/png.latex?v_i"> with means <img src="https://latex.codecogs.com/png.latex?%5Cmu_i"> and precisions <img src="https://latex.codecogs.com/png.latex?%5CLambda_i">. The following code assembles these factors for the observation model above.</p>
<div id="56" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">start_x</span>(_) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>., <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>start_x (generic function with 1 method)</code></pre>
</div>
</div>
<div id="58" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">start_θ</span>(_) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>π<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>start_θ (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="maximizing-trajectory-probability" class="level1">
<h1>Maximizing Trajectory Probability</h1>
<p>We know <img src="https://latex.codecogs.com/png.latex?L_i(z)%20=%20-f_i(z)%5ET%5CLambda_i%20f(z)"> where <img src="https://latex.codecogs.com/png.latex?f_i"> is a potentially nonlinear transformation of <img src="https://latex.codecogs.com/png.latex?z">. Taylor expand <img src="https://latex.codecogs.com/png.latex?f_i(z)%20%5Capprox%20f_i(%5Chat%7Bz%7D)%20+%20J_i%5CDelta"> where <img src="https://latex.codecogs.com/png.latex?%5CDelta%20=%20z%20-%20%5Chat%7Bz%7D"> and <img src="https://latex.codecogs.com/png.latex?J_i%20=%20%5Cnabla_z%20f_i(%5Chat%7Bz%7D)">. Substitute this expression in definition of <img src="https://latex.codecogs.com/png.latex?L_i"> giving <img src="https://latex.codecogs.com/png.latex?L_i(z)%20%5Capprox%20%5CDelta%5ET%20H_i%5CDelta%20+%202%20b_i%5ET%5CDelta%20+%20c">, where <img src="https://latex.codecogs.com/png.latex?H_i%20=%20J_i%5ET%5CLambda_i%20J_i"> and <img src="https://latex.codecogs.com/png.latex?b_i%20=%20J_i%5ET%5CLambda_i%20f_i(%5Chat%7Bz%7D)">. When add up all these factors to get the full log probability, we get <img src="https://latex.codecogs.com/png.latex?%5CDelta%5ET%20H%20%5CDelta%20+%202%20b%5ET%20%5CDelta%20+%20c"> where <img src="https://latex.codecogs.com/png.latex?b"> is the sum of the <img src="https://latex.codecogs.com/png.latex?b_i"> and <img src="https://latex.codecogs.com/png.latex?H"> is the sum of the <img src="https://latex.codecogs.com/png.latex?H_i">.</p>
<p>To minimize this quantity, take the derivative. We find that <img src="https://latex.codecogs.com/png.latex?L"> will be approximately minimized when <img src="https://latex.codecogs.com/png.latex?H%5CDelta%20=%20-b"> or <img src="https://latex.codecogs.com/png.latex?%5CDelta%20=%20-H%5E%7B-1%7Db">. It remains to solve for <img src="https://latex.codecogs.com/png.latex?%5CDelta"> and modify <img src="https://latex.codecogs.com/png.latex?z"> appropriately. Repeating this gives the Gauss Newton algorithm.</p>
<p>When <img src="https://latex.codecogs.com/png.latex?f"> is not well approximated by its first order Taylor expansion, instead of solving <img src="https://latex.codecogs.com/png.latex?H%5E%7B-1%7Db">, it works better to solve the smoothed version <img src="https://latex.codecogs.com/png.latex?(H%20+%20%5Clambda%20%5Ctext%7BDiag%7D(H))%5E%7B-1%7Db">, where <img src="https://latex.codecogs.com/png.latex?%5Clambda"> is a factor that gets slowly lowered to zero as <img src="https://latex.codecogs.com/png.latex?z"> nears its optimal value. This is the <a href="https://en.wikipedia.org/wiki/Levenberg–Marquardt_algorithm">Levenberg-Marquardt</a> algorithm.</p>
<section id="understanding-log_prob_builder" class="level3">
<h3 class="anchored" data-anchor-id="understanding-log_prob_builder">Understanding <code>log_prob_builder</code></h3>
<p>The <code>log_prob_builder</code> function above has two forms, depending on its <code>jac</code> argument. If <code>jac=true</code>, the function builds a vector of terms <img src="https://latex.codecogs.com/png.latex?H_i"> and <img src="https://latex.codecogs.com/png.latex?b_i"> described above. Othewise, it builds a vector of the negative log probabilities <img src="https://latex.codecogs.com/png.latex?L_i">.</p>
<div id="60" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> QuadformBuilder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector</span>{<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Tuple</span>{<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;:</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;"> ExtendableSparseMatrix</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector</span>}}</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Vector{Tuple{ExtendableSparseMatrixCSC, Vector}}<span class="ansi-bright-black-fg"> (alias for </span><span class="ansi-bright-black-fg">Array{Tuple{ExtendableSparseMatrixCSC, Array{T, 1} where T}, 1}</span><span class="ansi-bright-black-fg">)</span></pre>
</div>
</div>
</div>
<p>These terms are computed by the <code>factor</code> function, which assembles <img src="https://latex.codecogs.com/png.latex?H"> and <img src="https://latex.codecogs.com/png.latex?b"> out of <img src="https://latex.codecogs.com/png.latex?f_i(z)"> and its jacobian <img src="https://latex.codecogs.com/png.latex?J">.</p>
<div id="62" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(Λ, (fval,_)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Tuple{&lt;:Any, Nothing}</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> fval)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>factor (generic function with 1 method)</code></pre>
</div>
</div>
<div id="64" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(Λ, (fval, J))</span>
<span id="cb56-2">    ΛJ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> J</span>
<span id="cb56-3">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (ΛJ)<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' * fval</span></span>
<span id="cb56-4">    H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> J<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ΛJ</span>
<span id="cb56-5">    (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ExtendableSparseMatrix</span>(H), b)</span>
<span id="cb56-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>factor (generic function with 2 methods)</code></pre>
</div>
</div>
<p>Finally, we compute <img src="https://latex.codecogs.com/png.latex?f_i(z)"> and its Jacobian using the following wrappers around the <code>sparse_jac</code> function, which computes a function and its sparse Jacobian.</p>
</section>
</section>
<section id="handling-sparsity" class="level1">
<h1>Handling Sparsity</h1>
<p>To define the <code>sparse_jac</code> function, we’ll wrap the <code>jacobian</code> function from the <code>ForwardDiff</code> library.</p>
<div id="66" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_jac</span>(f, z, support, outs; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb58-2">    jac <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(z), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb58-3">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb58-4">    fz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span></span>
<span id="cb58-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_wrapper</span>(z_sup)</span>
<span id="cb58-6">        newz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eltype</span>(z_sup), z)</span>
<span id="cb58-7">        newz[support] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.=</span> z_sup</span>
<span id="cb58-8">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(newz)</span>
<span id="cb58-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb58-10">    z_sup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> z[support]</span>
<span id="cb58-11">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffResults.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">JacobianResult</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(outs), z_sup)</span>
<span id="cb58-12">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ForwardDiff.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jacobian!</span>(res, f_wrapper, z_sup)</span>
<span id="cb58-13">    J <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffResults.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jacobian</span>(res)</span>
<span id="cb58-14">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ExtendableSparseMatrix</span>(outs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(z))</span>
<span id="cb58-15">    M[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, support] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.=</span> J</span>
<span id="cb58-16">    DiffResults.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(res), M</span>
<span id="cb58-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>sparse_jac (generic function with 1 method)</code></pre>
</div>
</div>
<div id="68" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">term</span>(z, target, μ, outs, ixs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb60-2">    support <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [target; <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(vcat, ixs; init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>[])]</span>
<span id="cb60-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(z) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> z[target] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ</span>(z, ixs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>)</span>
<span id="cb60-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_jac</span>(f, z, support, outs; jac)</span>
<span id="cb60-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>term (generic function with 1 method)</code></pre>
</div>
</div>
<div id="70" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb62-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_term</span>(z, obs, ixs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb62-2">    support <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(vcat, ixs; init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>[])</span>
<span id="cb62-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(z) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">μ_obs</span>(z, ixs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>)</span>
<span id="cb62-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_jac</span>(f, z, support, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; jac)</span>
<span id="cb62-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>obs_term (generic function with 1 method)</code></pre>
</div>
</div>
<div id="72" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb64-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(z; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb64-2">    bld <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jac ? <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">QuadformBuilder</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Vector</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">{Float64}</span>()</span>
<span id="cb64-3"></span>
<span id="cb64-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We know the location distribution at time 1</span></span>
<span id="cb64-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(bld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ_x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">term</span>(z, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, start_x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; jac)))</span>
<span id="cb64-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(bld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ_θ), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">term</span>(z, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, start_θ, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>; jac)))</span>
<span id="cb64-7"></span>
<span id="cb64-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the Markovian jump probabilities at each step</span></span>
<span id="cb64-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb64-10">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb64-11">        pix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb64-12">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(bld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ_x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">term</span>(z, ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, μ_x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, pix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>pix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, pix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; jac)))</span>
<span id="cb64-13">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(bld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ_θ), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">term</span>(z, ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, μ_θ, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, pix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; jac)))</span>
<span id="cb64-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb64-15"></span>
<span id="cb64-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the prior on map components</span></span>
<span id="cb64-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb64-18">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb64-19">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(bld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ_m), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">term</span>(z, ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), μ_m, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; jac)))</span>
<span id="cb64-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb64-21"></span>
<span id="cb64-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the observations</span></span>
<span id="cb64-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb64-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>k</span>
<span id="cb64-25">            m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">T+2</span>(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb64-26">            ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb64-27">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(bld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ_obs), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_term</span>(z, obs[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, i, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>); jac)))</span>
<span id="cb64-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb64-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb64-30">    jac ? <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(bld)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(bld)</span>
<span id="cb64-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>log_prob_builder (generic function with 1 method)</code></pre>
</div>
</div>
<div id="74" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb66-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximize_logprob</span>(z; λ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, α<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, β<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, maxiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, eps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>)</span>
<span id="cb66-2">    Δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(z))</span>
<span id="cb66-3">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb66-4">    prevL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(z; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb66-5">    L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb66-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>.(Δ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.&gt;</span> eps)  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> maxiter</span>
<span id="cb66-7">        H, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(z; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb66-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb66-9">            Δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(H)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> b</span>
<span id="cb66-10">            L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Δ; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb66-11">            L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> prevL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb66-12">            λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> β</span>
<span id="cb66-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb66-14">        z[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-=</span> Δ</span>
<span id="cb66-15">        λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> α</span>
<span id="cb66-16">        prevL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L</span>
<span id="cb66-17">        i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb66-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb66-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">println</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Concluded after </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> iterations"</span>)</span>
<span id="cb66-20">    z</span>
<span id="cb66-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>maximize_logprob (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="running-the-optimization" class="level1">
<h1>Running the Optimization</h1>
<p>Here’s the negative log probability of the robot’s true trajectory.</p>
<div id="76" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb68-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(true_z; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2082.4291845741</code></pre>
</div>
</div>
<p>Wereas here’s how likely our prior mean would be:</p>
<div id="78" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb70-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(zhat; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>4.293105704799155e6</code></pre>
</div>
</div>
<p>Running Levenberg-Marquardt gives us a solution that isn’t our true trajectory, but is technically more likely under the generative model above.</p>
<div id="80" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb72-1">z_guess <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximize_logprob</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(zhat))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Concluded after 23 iterations</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>320-element Vector{Float64}:
  0.0034378099328569015
  0.9914065354044322
  0.04412767144911623
  1.1616831781275363
  1.2383383769126906
  0.10251482279741249
  2.26578807824746
  1.006135883145371
  0.15915735291351707
  3.2835135446382417
  ⋮
 20.80105806876392
 16.461071406617254
 27.51403449819456
 18.585176469681425
  5.309729223046708
  2.28449550904925
 -2.4762014943557835
 -7.58331169017551
  9.055115769823518</code></pre>
</div>
</div>
<div id="82" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb75-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_prob_builder</span>(z_guess; jac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>1765.1322400328486</code></pre>
</div>
</div>
<p>Below, we plot the guessed trajectory as a line, with the true trajectory represented as a scatter plot.</p>
<div id="84" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb77-1">y_guess <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reshape</span>(z_guess[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>T], (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, T))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×100 Matrix{Float64}:
 0.00343781  1.16168   2.26579   3.28351   …  -3.27478  -2.14573  -0.667408
 0.991407    1.23834   1.00614   1.03379       3.46532   3.84416   3.83187
 0.0441277   0.102515  0.159157  0.223708      6.22054   6.30426   6.36082</code></pre>
</div>
</div>
<div id="86" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb79-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb79-2">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f1)</span>
<span id="cb79-3">    p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T)</span>
<span id="cb79-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines!</span>(y_guess[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], y_guess[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb79-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Colorbar</span>(f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], p1)</span>
<span id="cb79-6">    f1</span>
<span id="cb79-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/graphslam/graphslam_files/figure-html/cell-44-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We ended up with a pretty good estiamte of the map points’ locations as well.</p>
<div id="88" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb80-1">m_guess <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reshape</span>(z_guess[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>], (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, k))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×10 Matrix{Float64}:
 5.74172  24.964    10.1238  -3.69083  …  18.5852    2.2845  -7.58331
 9.74611   5.44817  21.2426  20.9662       5.30973  -2.4762   9.05512</code></pre>
</div>
</div>
<div id="90" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb82-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb82-2">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f1)</span>
<span id="cb82-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_m[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_m[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=:</span>red, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"map points"</span>)</span>
<span id="cb82-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(m_guess[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], m_guess[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=:</span>black, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"guesses"</span>)</span>
<span id="cb82-5">    f1[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Legend</span>(f1, ax1)</span>
<span id="cb82-6">    f1</span>
<span id="cb82-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/graphslam/graphslam_files/figure-html/cell-46-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>SLAM</category>
  <guid>https://samanklesaria.github.io/posts/graphslam/graphslam.html</guid>
  <pubDate>Mon, 22 Jul 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Diagnosing Lack of Independence in Exogenous Variables</title>
  <link>https://samanklesaria.github.io/posts/regression_diagnostics.html</link>
  <description><![CDATA[ 





<p>While performing linear regression with <code>statsmodels</code>, you might occasionally find that your exogenous variables aren’t independent, giving you a error about a singular matrix.</p>
<p>To figure out exactly which variables are colinear, I tend to use the following recipe:</p>
<ol type="1">
<li>Take the SVD of the design matrix <img src="https://latex.codecogs.com/png.latex?X%20=%20QSV%5ET">.</li>
<li>Find a column of <img src="https://latex.codecogs.com/png.latex?V"> that corresponds to a zero singular value.</li>
<li>Check which terms in our original formula correspond to the nonzero elements of <img src="https://latex.codecogs.com/png.latex?V">. Usually there’s only a couple nonzero terms.</li>
</ol>
<p>For posterity, I’ve reproduced the workflow below.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dmatrix(formula, df)</span>
<span id="cb1-2">u, s, vh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.svd(m)</span>
<span id="cb1-3">misfits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(vh[s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-8</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)</span>
<span id="cb1-4">np.array(m.design_info.column_names)[misfits[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]]</span></code></pre></div></div>



 ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/regression_diagnostics.html</guid>
  <pubDate>Mon, 06 May 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Finite Basis Gaussian Processes</title>
  <link>https://samanklesaria.github.io/posts/finite_basis_gps/finite_basis_gps.html</link>
  <description><![CDATA[ 





<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">KernelFunctions</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">AbstractGPs</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Random</span></span></code></pre></div></div>
</div>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">BenchmarkTools</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-green-fg ansi-bold">Precompiling</span> packages...
    705.7 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">JSON</span>
    856.7 ms<span class="ansi-green-fg">  ✓ </span>BenchmarkTools
  2 dependencies successfully precompiled in 2 seconds. 13 already precompiled.
<span class="ansi-green-fg ansi-bold">Precompiling</span> packages...
    557.9 ms<span class="ansi-green-fg">  ✓ </span>QuartoNotebookWorkerJSONExt<span class="ansi-bright-black-fg"> (serial)</span>
  1 dependency successfully precompiled in 1 seconds
</pre>
</div>
</div>
</div>
<p>By Mercer’s theorem, every positive definite kernel <img src="https://latex.codecogs.com/png.latex?k(x,%20y)%20:%20%5Cmathcal%7BX%7D%20%5Cto%20%5Cmathcal%7BX%7D%20%5Cto%20%5Cmathbb%7BR%7D"> that we might want to use in a Gaussian Process corresponds to some inner product <img src="https://latex.codecogs.com/png.latex?%5Clangle%20%5Cphi(x),%20%5Cphi(y)%20%5Crangle">, where <img src="https://latex.codecogs.com/png.latex?%5Cphi%20:%20%5Cmathcal%7BX%7D%20%5Cto%20%5Cmathcal%7BV%7D"> maps our inputs into some other space. For many kernels (like the venerable RBF), this space is infinite dimensional, and we can’t work with it directly. But when it’s finite dimensional (in say <img src="https://latex.codecogs.com/png.latex?d"> dimensions), we can! This lets us avoid the usual <img src="https://latex.codecogs.com/png.latex?O(n%5E3)"> scaling for Gaussian process regression, getting <img src="https://latex.codecogs.com/png.latex?O(nd+d%5E3)"> instead.</p>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">AbstractGPs</span>: AbstractGP, FiniteGP</span></code></pre></div></div>
</div>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span></span></code></pre></div></div>
</div>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> FiniteBasis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;:</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;"> KernelFunctions.SimpleKernel </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<p>We can define a finite dimensional kernel in Julia using the <code>KernelFunctions</code> library. The library assumes our kernel <code>k</code> has the form <code>k(x,y) = kappa(metric(x,y))</code>, and lets us fill in the definitions for <code>kappa</code> and <code>metric</code>.</p>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1">KernelFunctions.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kappa</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">FiniteBasis</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Real</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d</span></code></pre></div></div>
</div>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1">KernelFunctions.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">FiniteBasis</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> KernelFunctions.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DotProduct</span>()</span></code></pre></div></div>
</div>
<p>We will use the <em>weight space</em> view of Gaussian processes, which interprets GP regression as Bayesian linear regression. We assume that there is a weight vector <img src="https://latex.codecogs.com/png.latex?w%20:%20%5Cmathcal%7BV%7D"> with prior <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BN%7D(0,%20I)">, and that <img src="https://latex.codecogs.com/png.latex?y%20%5Csim%20%5Cmathcal%7BN%7D(X%20w,%20I)">, where <img src="https://latex.codecogs.com/png.latex?X"> is the matrix for which row <img src="https://latex.codecogs.com/png.latex?i"> is given by <img src="https://latex.codecogs.com/png.latex?%5Cphi(x_i)">. The posterior over <img src="https://latex.codecogs.com/png.latex?w"> remains Gaussian with precision <img src="https://latex.codecogs.com/png.latex?%5CLambda%20=%20I%20+%20X%5ET%20X"> and mean <img src="https://latex.codecogs.com/png.latex?%5Cmu%20=%20%5CLambda%5E%7B-1%7D%20X%5ET%20y">. To make a prediction at <img src="https://latex.codecogs.com/png.latex?x_*">, we simply find <img src="https://latex.codecogs.com/png.latex?%5Clangle%20%5Cphi(x_*),%20w%20%5Crangle">.</p>
<p>On the face of it, this seems like a very different generative model than the traditional depiction of Gaussian processes in which the observations <img src="https://latex.codecogs.com/png.latex?y"> are noisy versions of the function values <img src="https://latex.codecogs.com/png.latex?f">, which are all jointly Gaussian with a covariance matrix given by the associated kernel. But with a little algebra, one can show that the posterior over <img src="https://latex.codecogs.com/png.latex?f(x_*)%20=%20%5Clangle%20%5Cphi(x_*),%20w%20%5Crangle"> in the weight space view is the same as the posterior over <img src="https://latex.codecogs.com/png.latex?f(x_*)"> is the traditional function-space view.</p>
<p>First, we can marginalize out <img src="https://latex.codecogs.com/png.latex?w"> to find that</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Af(x_*)%20%7C%20y%20%5Csim%20%5Cmathcal%7BN%7D(X_*%20%5Cmu,%20X_*%20%5CLambda%5E%7B-1%7D%20X_*%5ET)%0A"> The mean expands to <img src="https://latex.codecogs.com/png.latex?X_*(I%20+%20X%5ET%20X)%5E%7B-1%7D%20X%5ET%20y"> and the variance expands to <img src="https://latex.codecogs.com/png.latex?X_*(I%20+%20X%5ET%20X)%5E%7B-1%7DX_*%5ET">.</p>
<p>Now, we can use the Woodbury Matrix Identity, which says that <img src="https://latex.codecogs.com/png.latex?%0A(I%20+%20X%5ETX)%5E%7B-1%7D%20=%20I%20-%20X%5ET(I%20+%20XX%5ET)%5E%7B-1%7DX%0A"> This lets the mean simplify to <img src="https://latex.codecogs.com/png.latex?X_*X%5ET%20(XX%5ET%20+%20I)%5E%7B-1%7Dy"> and the variance simplify to <img src="https://latex.codecogs.com/png.latex?X_*X_*%5ET%20-X_*X%5ET(XX%5ET%20+%20I)%5E%7B-1%7DXX_*%5ET">. Letting <img src="https://latex.codecogs.com/png.latex?XX%5ET%20=%20K">, we recover the familiar function space representation of Gaussian process. See the first chapter of the <a href="http://gaussianprocess.org/gpml/">Rasmussen book</a> for a more detailed derivation.</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> DegeneratePosterior{P,T,C} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;:</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;"> AbstractGP</span></span>
<span id="cb8-2">    prior<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">P</span></span>
<span id="cb8-3">    w_mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">T</span></span>
<span id="cb8-4">    w_prec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">C</span></span>
<span id="cb8-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">KernelFunctions.ColVecs</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A.X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>weight_form (generic function with 1 method)</code></pre>
</div>
</div>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">KernelFunctions.RowVecs</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A.X</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>weight_form (generic function with 2 methods)</code></pre>
</div>
</div>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DegeneratePosterior</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb13-2">    w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.w_mean</span>
<span id="cb13-3">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(x)</span>
<span id="cb13-4">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w</span>
<span id="cb13-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(fx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">FiniteGP{GP{M, B}}</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector{&lt;:Real}</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {M, B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;:</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;"> FiniteBasis</span>}</span>
<span id="cb14-2">    kern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fx.f.kernel</span>
<span id="cb14-3">    δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(fx)</span>
<span id="cb14-4">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(fx.x)</span>
<span id="cb14-5">    X_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(fx.Σy)</span>
<span id="cb14-6">    Λμ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y</span>
<span id="cb14-7">    prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cholesky</span>(I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Symmetric</span>(X_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X))</span>
<span id="cb14-8">    w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> Λμ</span>
<span id="cb14-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DegeneratePosterior</span>(fx.f, w, prec)</span>
<span id="cb14-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cov</span>(f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DegeneratePosterior</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb15-2">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(x)</span>
<span id="cb15-3">    AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Xt_invA_X</span>(f.w_prec, X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb15-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cov</span>(f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DegeneratePosterior</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb16-2">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(x)</span>
<span id="cb16-3">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(y)</span>
<span id="cb16-4">    AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Xt_invA_Y</span>(X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>, f.w_prec, Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb16-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DegeneratePosterior</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb17-2">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(x)</span>
<span id="cb17-3">    AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag_Xt_invA_X</span>(f.w_prec, X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb17-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span>.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(rng<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractRNG</span>, f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DegeneratePosterior</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb18-2">    w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.w_mean</span>
<span id="cb18-3">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_form</span>(x)</span>
<span id="cb18-4">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (f.w_prec.U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(rng, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(x)))</span>
<span id="cb18-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<p>We can compare the results of this optimized implementation with the standard posterior implementation to ensure that the two agree on the output.</p>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×2000 Matrix{Float64}:
 0.351496   0.201416  0.437436  0.666158  …  0.0625915  0.731095  0.382785
 0.0576307  0.698233  0.582991  0.465895     0.899785   0.260989  0.554423</code></pre>
</div>
</div>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">norm</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(x)))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2000-element Vector{Float64}:
 0.3487055324991339
 0.6644094915138241
 0.66601590805138
 0.7262912901139835
 0.3997721826491429
 0.8130975274946121
 0.3867715265954484
 0.6915444950745628
 0.7064190858519713
 0.687646536276883
 ⋮
 0.7421488774224382
 0.6884915867547636
 0.8886306385116652
 0.6716576846196286
 0.8250049592784389
 0.5242250412111538
 0.7845434358940825
 0.7006320687866278
 0.6239034098291798</code></pre>
</div>
</div>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1">kern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FiniteBasis</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>FiniteBasis()</code></pre>
</div>
</div>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1">f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(kern)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>GP{ZeroMean{Float64}, FiniteBasis}(ZeroMean{Float64}(), FiniteBasis())</code></pre>
</div>
</div>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1">fx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>AbstractGPs.FiniteGP{AbstractGPs.GP{AbstractGPs.ZeroMean{Float64}, Main.Notebook.FiniteBasis}, KernelFunctions.ColVecs{Float64, Matrix{Float64}, SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}}, LinearAlgebra.Diagonal{Float64, FillArrays.Fill{Float64, 1, Tuple{Base.OneTo{Int64}}}}}(
f: GP{ZeroMean{Float64}, FiniteBasis}(ZeroMean{Float64}(), FiniteBasis())
x: SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}[[0.35149641083221217, 0.05763068729679277], [0.2014163045582935, 0.6982330113172243], [0.43743631452871634, 0.5829913842710026], [0.6661578075039322, 0.465895058162053], [0.29424765897527083, 0.28733242404477044], [0.6455059374287724, 0.6962644211821701], [0.24798696009517884, 0.3101824940598763], [0.6601860876479605, 0.3837676112030852], [0.28756466003278713, 0.7298156296435593], [0.4234423824785205, 0.628989944148036]  …  [0.7721172196470107, 0.3562414055654409], [0.6620141097416459, 0.5109659959662884], [0.5696028513670078, 0.5022467251213828], [0.9082232376802148, 0.6105194028256506], [0.27720475817422985, 0.6822809807126444], [0.9668046822131043, 0.08122834020244951], [0.3188134615509236, 0.4503848915058404], [0.0625915040682905, 0.8997850871147113], [0.7310949402838798, 0.2609892975778647], [0.38278458559490836, 0.5544229330341326]]
Σy: Diagonal(Fill(0.001, 2000))
)</code></pre>
</div>
</div>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1">x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ColVecs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2000-element ColVecs{Float64, Matrix{Float64}, SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}}:
 [0.7714753598208173, 0.17451404189323316]
 [0.42425908263840695, 0.2124601416173687]
 [0.07272271000919628, 0.5482454543064469]
 [0.7059731358753187, 0.7259727573183643]
 [0.11460956633870045, 0.24344830224835445]
 [0.8300383940970001, 0.2790143015230281]
 [0.4477432799750962, 0.4551113837179096]
 [0.058584388428317924, 0.17827802331726972]
 [0.7793071586655852, 0.21791492416561375]
 [0.13358837960391345, 0.833479653115069]
 ⋮
 [0.7989244260415876, 0.6185838381828523]
 [0.7023053355322493, 0.7796220515234427]
 [0.8638621277598659, 0.061635729084563606]
 [0.8171989565611498, 0.8240352874225825]
 [0.6105743997173582, 0.10404049957766726]
 [0.3990949140503428, 0.9542567830909576]
 [0.47200770576798967, 0.922900672462661]
 [0.19074503951635113, 0.3108299131058804]
 [0.1447563133315517, 0.7373452805826761]</code></pre>
</div>
</div>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1">opt_m, opt_C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@btime</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_and_cov</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fx, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y)(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x2))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.156 ms (28 allocations: 61.16 MiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.6059480706502862, 0.40803777403564323, 0.3986292483384698, 0.9181528858346273, 0.22970844859000528, 0.7105468977081874, 0.5788983199916785, 0.15199134833403666, 0.6388331041719346, 0.6207664866757735  …  0.8070315642474819, 0.9086944609323611, 0.9502575404488182, 0.5926030564142932, 1.0523308290593398, 0.4576866093448145, 0.8682977878068852, 0.8948382509092377, 0.3217197069238477, 0.566180008870297], [1.4379522182192942e-6 6.316651977316091e-7 … -1.0093037669316541e-8 -6.925915889297121e-7; 6.316651977316091e-7 3.0593138536360454e-7 … 6.094832850339773e-8 -1.321418708611357e-7; … ; -1.0093037669316541e-8 6.094832850339773e-8 … 1.5031280378064394e-7 4.003327712855696e-7; -6.925915889297121e-7 -1.321418708611357e-7 … 4.003327712855696e-7 1.3745595946685778e-6])</code></pre>
</div>
</div>
<p>To compare against the implementation that uses a function-space perspective, we’ll use a bit of a hack: by adding a <code>ZeroKernel</code> to our <code>FiniteBasis</code> kernel, we get a kernel for which our custom <code>posterior</code> method won’t be called.</p>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1">fx2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(kern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ZeroKernel</span>())(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>AbstractGPs.FiniteGP{AbstractGPs.GP{AbstractGPs.ZeroMean{Float64}, KernelFunctions.KernelSum{Tuple{Main.Notebook.FiniteBasis, KernelFunctions.ZeroKernel}}}, KernelFunctions.ColVecs{Float64, Matrix{Float64}, SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}}, LinearAlgebra.Diagonal{Float64, FillArrays.Fill{Float64, 1, Tuple{Base.OneTo{Int64}}}}}(
f: GP{ZeroMean{Float64}, KernelSum{Tuple{FiniteBasis, ZeroKernel}}}(ZeroMean{Float64}(), Sum of 2 kernels:
    FiniteBasis()
    Zero Kernel)
x: SubArray{Float64, 1, Matrix{Float64}, Tuple{Base.Slice{Base.OneTo{Int64}}, Int64}, true}[[0.35149641083221217, 0.05763068729679277], [0.2014163045582935, 0.6982330113172243], [0.43743631452871634, 0.5829913842710026], [0.6661578075039322, 0.465895058162053], [0.29424765897527083, 0.28733242404477044], [0.6455059374287724, 0.6962644211821701], [0.24798696009517884, 0.3101824940598763], [0.6601860876479605, 0.3837676112030852], [0.28756466003278713, 0.7298156296435593], [0.4234423824785205, 0.628989944148036]  …  [0.7721172196470107, 0.3562414055654409], [0.6620141097416459, 0.5109659959662884], [0.5696028513670078, 0.5022467251213828], [0.9082232376802148, 0.6105194028256506], [0.27720475817422985, 0.6822809807126444], [0.9668046822131043, 0.08122834020244951], [0.3188134615509236, 0.4503848915058404], [0.0625915040682905, 0.8997850871147113], [0.7310949402838798, 0.2609892975778647], [0.38278458559490836, 0.5544229330341326]]
Σy: Diagonal(Fill(0.001, 2000))
)</code></pre>
</div>
</div>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1">m, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@btime</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_and_cov</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fx2, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y)(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x2))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>  263.622 ms (71 allocations: 458.03 MiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.6059480706526301, 0.4080377740373251, 0.39862924833721536, 0.9181528858364345, 0.22970844858986084, 0.7105468977106284, 0.5788983199925042, 0.15199134833355288, 0.6388331041741822, 0.620766486675052  …  0.807031564248291, 0.9086944609343846, 0.9502575404517302, 0.5926030564144185, 1.0523308290598834, 0.4576866093462968, 0.8682977878042948, 0.894838250912926, 0.3217197069247959, 0.5661800088709015], [1.4379522189643675e-6 6.31665197814435e-7 … -1.00930376278896e-8 -6.925915888300604e-7; 6.31665197814435e-7 3.059313857255449e-7 … 6.094832855074728e-8 -1.321418708621902e-7; … ; -1.00930376278896e-8 6.094832855074728e-8 … 1.5031280348287792e-7 4.003327714330318e-7; -6.925915888300604e-7 -1.321418708621902e-7 … 4.003327714330318e-7 1.3745595951474295e-6])</code></pre>
</div>
</div>
<div id="52" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>.(opt_C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> C)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>.(opt_m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> m)))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6.212141911987601e-12</code></pre>
</div>
</div>
<p>Our optimized technique produces the same results!</p>
<section id="random-fourier-features" class="level2">
<h2 class="anchored" data-anchor-id="random-fourier-features">Random Fourier Features</h2>
<p>One application of this technique is the <em>Random Fourier Features</em> approximation. By Bochner’s theorem, every kernel of the form <img src="https://latex.codecogs.com/png.latex?k(x,y)%20=%20f(x-y)"> for some <img src="https://latex.codecogs.com/png.latex?f"> can be expressed in the Fourier basis as <img src="https://latex.codecogs.com/png.latex?f(x-y)%20=%20E%20e%5E%7Bi%5Comega%20(x-y)%7D">, where the distribution from which <img src="https://latex.codecogs.com/png.latex?%5Comega"> is sampled determines the kernel. A Monte Carlo estimate of this expectation is just <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bw_j%7D%20e%5E%7Bi%20w_j%20x%7De%5E%7B-i%20w_j%20y%7D">, which is an inner product of features of the form <img src="https://latex.codecogs.com/png.latex?%5Cphi_j(x)%20=%20e%5E%7Bi%20w_j%20x%7D">. With some algebraic simplifications (see <a href="https://gregorygundersen.com/blog/2019/12/23/random-fourier-features/#a4-alternative-random-fourier-features">here</a> for a good derivation) we can ignore the imaginary parts and express this as <img src="https://latex.codecogs.com/png.latex?%5Cphi_j(x)=(%5Ccos(w_j%20x),%20%5Csin(w_j%20x))">.</p>
<div id="54" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb41-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> RandomFourierFeature</span>
<span id="cb41-3">    ws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Float64}</span></span>
<span id="cb41-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb41-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RandomFourierFeature</span>(kern<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">SqExponentialKernel</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RandomFourierFeature</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(k))</span>
<span id="cb41-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> (f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">RandomFourierFeature</span>)(x)</span>
<span id="cb41-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>.(f.ws <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> x); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>.(f.ws <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> x)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(f.ws))</span>
<span id="cb41-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb41-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="56" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb42-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FFApprox</span>(kern<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Kernel</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FiniteBasis</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">∘</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FunctionTransform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RandomFourierFeature</span>(kern, k))</span>
<span id="cb42-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FFApprox</span>(rng<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractRNG</span>, kern<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Kernel</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FiniteBasis</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">∘</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FunctionTransform</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RandomFourierFeature</span>(rng, kern, k))</span>
<span id="cb42-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>FFApprox (generic function with 2 methods)</code></pre>
</div>
</div>
<p>To support other spectral densities besides the RBF, we could add constructors for <code>RandomFourierFeature</code>.</p>
<div id="58" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1">rbf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SqExponentialKernel</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Squared Exponential Kernel (metric = Distances.Euclidean(0.0))</code></pre>
</div>
</div>
<div id="60" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1">flat_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2000-element Vector{Float64}:
 0.8262485689043089
 0.428468984864
 0.345564372312792
 0.6376102893364441
 0.25288608513089594
 0.42337735430117496
 0.6965653681089846
 0.6387935649325237
 0.5341863343340341
 0.8086038706781346
 ⋮
 0.9640717549579014
 0.1402547421925595
 0.20175123213064217
 0.22658244315688736
 0.16899866224516824
 0.3786632396773453
 0.7167636570113126
 0.4158869625613356
 0.6282980646795796</code></pre>
</div>
</div>
<div id="62" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1">flat_x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>100-element Vector{Float64}:
 0.8765314982311043
 0.436856034220347
 0.8668468831498979
 0.9134469399631979
 0.4870653556247635
 0.6596646711472544
 0.31423023225547797
 0.6780304136075354
 0.18625992923928625
 0.9051183709542147
 ⋮
 0.6289144203449463
 0.9998425990601125
 0.9487253381196158
 0.8139396150194459
 0.513503852026044
 0.6373971066414789
 0.706102962208211
 0.32186760637075507
 0.5846464209932682</code></pre>
</div>
</div>
<div id="64" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb50-1">ffkern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FFApprox</span>(rbf, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>FiniteBasis()
    - Function Transform: Main.Notebook.RandomFourierFeature([-0.9605425137782779, -0.4556580662486187, -0.0462526551078979, -1.3515990868234025, -1.1252083933432082, 0.43463448941753513, 1.700977151608801, 0.9116832996013912, 1.6391244777495146, 0.29478489882492276, 0.26310896178970455, 0.16536976449367444, 0.41311033576224077, 0.8021076108404168, -0.36224564234194234, -0.45140419700107354, -0.8404017324605675, -0.32575945151579616, -0.980445461745031, 1.1698215477932925, 0.5842088364572025, 0.5384055093260036, 0.05178873825595889, -0.6626447165057271, 0.8679493446281221, 1.349329080293985, -0.16802647757149256, 0.4710928234668019, -1.8247581525220078, -0.8597030133670049, -1.333558768499329, 0.580130059459092, 0.21509456524203416, 0.7054271578607293, -1.2379096528957472, -1.2014813367066064, -1.0410065900406815, -1.9226600346721625, -1.8514215521777038, -0.8180452155965721, -0.10190309416921497, 0.562650195374764, 0.8293657133221493, -1.2990338378436075, -0.5170154571788326, -0.9151706246010864, 1.483232320473878, 0.9048628480763394, -0.4017464202857643, -0.2240300957866955, 0.6098831636271618, -0.7606263017808166, -0.3746306045271828, -0.6625287549558049, -0.5831191968088915, 0.22422978158669804, -0.8904231441360309, -0.18624629873664772, 0.23746264724234228, 0.6564796280956496, -1.6226828341283277, 1.4493913670528968, 0.3359940295548781, -0.3683601416301013, 0.3014031635517683, 0.6877853582263126, 1.4380518243642266, -1.4638617310812916, 0.02025369338300898, 0.2192953880487077, 0.012093451637238975, -1.3428510181223463, 1.6005651034910295, -0.12585405343545533, 0.29018716162710834, 1.0245781887241046, -0.1545578835682928, -2.8782130742163887, -2.415730601110451, -0.19570567975859263, 0.3526448080108851, 0.46849487818920266, 1.2904901273290066, 0.005491063031410227, 1.1388679799042067, -0.25914475868047765, -0.2906027587870364, 0.16352409586397848, -2.4151073557100693, 0.5233804354699256, -0.3073352202906987, 0.7708555590835786, 1.17631703035191, -0.2407438030463325, -0.9776252136075437, 0.9427453274536897, 1.060523393924405, -0.5703270787509798, -0.4411228783126022, 0.06212947146234058])</code></pre>
</div>
</div>
<div id="66" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1">ff_m, ff_C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_and_cov</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(ffkern)(flat_x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>), y)(flat_x2))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.6685153185817398, 0.6674623265753326, 0.6689004704276158, 0.6668306862111422, 0.6687821690838973, 0.6719040257021334, 0.6644888551700205, 0.6719995286557605, 0.6631313700981991, 0.6672408172789801  …  0.6720328747069289, 0.6716173079512373, 0.6615481461990385, 0.6648991489923901, 0.6705943634497089, 0.6694427157613063, 0.6717114496368595, 0.6720259681410425, 0.6646426842835353, 0.6709597278850197], [2.0694806650577443e-6 -4.316087447442385e-7 … -2.1791949644800468e-7 5.8330127616912364e-8; -4.316087447442385e-7 1.547964608939912e-6 … 1.1850965961901494e-6 1.1310200658254388e-6; … ; -2.1791949644800468e-7 1.1850965961901494e-6 … 1.5535339965576663e-6 3.601289015886522e-7; 5.8330127616912364e-8 1.1310200658254388e-6 … 3.601289015886522e-7 1.5508166835164213e-6])</code></pre>
</div>
</div>
<div id="68" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1">m2, C2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_and_cov</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(rbf)(flat_x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>), y)(flat_x2))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.6685490108977774, 0.6673803029543706, 0.6689414161301102, 0.6668293718448695, 0.6687040195592999, 0.6719280128240825, 0.6644774650667387, 0.6720350848340786, 0.6632388504062874, 0.6672484082791925  …  0.6720775015810432, 0.6716201964375159, 0.6614222732557664, 0.6648538281624496, 0.6706607135324703, 0.6693735452645342, 0.6717203031507779, 0.67207682201024, 0.6646240488616968, 0.6709313820106217], [2.0496280453984335e-6 -4.031442002450092e-7 … -2.077162950531175e-7 6.837665633696588e-8; -4.031442002450092e-7 1.5371062037649049e-6 … 1.1907212842388049e-6 1.112839862149606e-6; … ; -2.077162950531175e-7 1.1907212842388049e-6 … 1.5617916862008537e-6 3.5271860387986465e-7; 6.837665633696588e-8 1.112839862149606e-6 … 3.5271860387986465e-7 1.5458090074648164e-6])</code></pre>
</div>
</div>
<div id="70" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>.(m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> ff_m)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maximum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>.(C2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> ff_C)))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>0.0002836960175045533</code></pre>
</div>
</div>
<p>Even with only 100 samples, we get a pretty close approximation!</p>


</section>

 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/finite_basis_gps/finite_basis_gps.html</guid>
  <pubDate>Tue, 02 Apr 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Finite Particle Approximations</title>
  <link>https://samanklesaria.github.io/posts/finite_particle_approx.html</link>
  <description><![CDATA[ 





<p>Say you have a discrete distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi"> that you want to approximate with a small number of weighted particles. Intuitively, it seems like the the best choice of particles would be the outputs of highest probability under <img src="https://latex.codecogs.com/png.latex?%5Cpi">, and that the relative weights of these particles should be the same under our approximation as they were under <img src="https://latex.codecogs.com/png.latex?%5Cpi">. This actually isn’t hard to prove!</p>
<section id="minimizing-the-kl-divergence" class="level3">
<h3 class="anchored" data-anchor-id="minimizing-the-kl-divergence">Minimizing the KL Divergence</h3>
<p>Let <img src="https://latex.codecogs.com/png.latex?q"> be our approximation: a version of <img src="https://latex.codecogs.com/png.latex?%5Cpi"> with support restricted to <img src="https://latex.codecogs.com/png.latex?b"> outcomes. We’ll try to minimize <img src="https://latex.codecogs.com/png.latex?KL%5Bq,%20%5Cpi%5D">. (Note that <img src="https://latex.codecogs.com/png.latex?KL%5B%5Cpi,%20q%5D"> will always be infinite as we do not have $ q$, so using this distance isn’t an option). Treat <img src="https://latex.codecogs.com/png.latex?%5Cpi"> and <img src="https://latex.codecogs.com/png.latex?q"> as vectors in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En">, and assume without loss of generality that <img src="https://latex.codecogs.com/png.latex?%5Cpi_1%20%5Cgeq%20%5Cpi_2%20%5Cgeq%20%5Cpi_3%20%5Cdotsc">.</p>
<p><strong>Claim 1: <img src="https://latex.codecogs.com/png.latex?KL%5Bq,%20%5Cpi%5D"> is minimized when the nonzero components of <img src="https://latex.codecogs.com/png.latex?q"> have <img src="https://latex.codecogs.com/png.latex?q%20%5Cpropto%20%5Cpi">.</strong></p>
<p><em>Proof:</em> Use Lagrange multipliers. Let <img src="https://latex.codecogs.com/png.latex?S"> be the support of <img src="https://latex.codecogs.com/png.latex?q">. <img src="https://latex.codecogs.com/png.latex?L(%5Clambda,%20q)%20=%20%5Csum_%7Bi%20%5Cin%20S%7D%20q_i%20%5Clog%20(q_i%20/%20%5Cpi_i)%20+%20%5Clambda%20(1%20-%20%5Clangle%20q,%201%20%5Crangle)">. The minimum will be at a fixed point of the Lagrangian. Differentiating, we find that <img src="https://latex.codecogs.com/png.latex?%5Clog%20(q_i/%5Cpi_i)%20+%20(q_i/q_i)%20+%20%5Clambda%20=%200"> for all <img src="https://latex.codecogs.com/png.latex?i"> in <img src="https://latex.codecogs.com/png.latex?q">’s support, or <img src="https://latex.codecogs.com/png.latex?%5Cpi_i%20/%20q_i%20=e%5E%7B%5Clambda%20+%201%7D">. As this proportionality constant is the same for all <img src="https://latex.codecogs.com/png.latex?i">, this confirms that minimizer is proportional to <img src="https://latex.codecogs.com/png.latex?%5Cpi"> whenever it is nonzero. <img src="https://latex.codecogs.com/png.latex?%5Csquare"></p>
<p><strong>Claim 2: If <img src="https://latex.codecogs.com/png.latex?q%20%5Cpropto%20m%20%5Codot%20%5Cpi"> where <img src="https://latex.codecogs.com/png.latex?%5Codot"> indicates point-wise multiplication and <img src="https://latex.codecogs.com/png.latex?m"> is a binary mask with <img src="https://latex.codecogs.com/png.latex?%5C%7Cm%5C%7C_0%20=%20b"> picking out the support of <img src="https://latex.codecogs.com/png.latex?q">, then <img src="https://latex.codecogs.com/png.latex?%5Carg%20%5Cmin%20KL%5Bq,%20%5Cpi%5D"> is obtained when <img src="https://latex.codecogs.com/png.latex?m_i%20=%201"> when <img src="https://latex.codecogs.com/png.latex?i%20%5Cleq%20b"> and <img src="https://latex.codecogs.com/png.latex?m_i%20=%200"> otherwise.</strong></p>
<p><em>Proof</em>: Let <img src="https://latex.codecogs.com/png.latex?P%20=%20m%5ET%5Cpi">. The KL divergence simplifies as follows <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AKL%5Bq,%20%5Cpi%5D%20&amp;=%20%5Cfrac%7B1%7D%7BP%7D%5Csum_%7Bi=1%7D%5En%20%5Cpi_i%20m_i%20%5Cleft(%20%5Clog%20(%5Cpi_i%20/%20P)%20-%20%5Clog%20%5Cpi_i%5Cright)%20%5C%5C%0A&amp;=%20-%5Clog(P)%0A%5Cend%7Balign*%7D%0A"> The <img src="https://latex.codecogs.com/png.latex?m"> maximizing <img src="https://latex.codecogs.com/png.latex?m%5ET%5Cpi"> is clearly the one with its mass on the <img src="https://latex.codecogs.com/png.latex?b"> highest outcomes in <img src="https://latex.codecogs.com/png.latex?%5Cpi">. <img src="https://latex.codecogs.com/png.latex?%5Csquare"></p>
</section>
<section id="minimizing-maximum-mean-discrepancy" class="level3">
<h3 class="anchored" data-anchor-id="minimizing-maximum-mean-discrepancy">Minimizing Maximum Mean Discrepancy</h3>
<p>The KL divergence isn’t the only way to measure distance between distributions. In fact, it’s not a particularly flexible way, as it only lets us compare our discrete distribution <img src="https://latex.codecogs.com/png.latex?q"> with other discrete distributions <img src="https://latex.codecogs.com/png.latex?%5Cpi">. Instead, we can minimize the “maximum mean discrepancy” or MMD. The big idea is to choose <img src="https://latex.codecogs.com/png.latex?q"> to make <img src="https://latex.codecogs.com/png.latex?E_%7BX%20%5Csim%20q%7Df(X)"> as close as possible to <img src="https://latex.codecogs.com/png.latex?E_%7BX%20%5Csim%20%5Cpi%7D%20f(X)"> for all functions <img src="https://latex.codecogs.com/png.latex?f"> in some space <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BH%7D">. <img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BMMD%7D%20=%20%5Csup_%7Bf%20%5Cin%20%5Cmathcal%7BH%7D,%20%5C%7Cf%5C%7C%20%5Cleq%201%7D%20(E_%7BX%20%5Csim%20%5Cpi%7D%20f(X)%20-%20E_%7BX%20%5Csim%20q%7D%20f(X))%5E2%0A"> If we assume that <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BH%7D"> is closed under negation, squaring this difference won’t change the optimal distribution <img src="https://latex.codecogs.com/png.latex?q%5E*"> minimizing the expression, so we can equivalently write this as <img src="https://latex.codecogs.com/png.latex?%0A%5Csup_%7Bf%20%5Cin%20%5Cmathcal%7BH%7D,%20%5C%7Cf%5C%7C%20%5Cleq%201%7D%20(E_%7BX%20%5Csim%20%5Cpi%7D%20f(X)%20-%20E_%7BX%20%5Csim%20q%7D%20f(X))%0A"> If we let <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BH%7D"> be a <a href="https://web.archive.org/web/https://en.wikipedia.org/wiki/Reproducing_kernel_Hilbert_space">reproducing kernel Hilbert space</a> with kernel <img src="https://latex.codecogs.com/png.latex?k">, function evaluation <img src="https://latex.codecogs.com/png.latex?f(x)"> is the same as taking the inner product <img src="https://latex.codecogs.com/png.latex?%5Clangle%20f,%20k(x,%20%5Ccdot)%20%5Crangle">, and we can write the result as <img src="https://latex.codecogs.com/png.latex?%0A%5Csup_%7Bf%20%5Cin%20%5Cmathcal%7BH%7D,%20%5C%7Cf%5C%7C%20%5Cleq%201%7D%20(E_%7BX%20%5Csim%20%5Cpi%7D%20%5Clangle%20f,%20k(X,%20%5Ccdot)%20%5Crangle%20-%20E_%7BX%20%5Csim%20q%7D%20%5Clangle%20f,%20k(X,%20%5Ccdot)%20%5Crangle)%0A"> You can read more about kernel mean embeddings like this <a href="https://web.archive.org/web/https://en.wikipedia.org/wiki/Kernel_embedding_of_distributions">here</a>.</p>
<p>Let’s assume that <img src="https://latex.codecogs.com/png.latex?%5Cpi"> is discrete, and we can use <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"> as this Hilbert space. Letting <img src="https://latex.codecogs.com/png.latex?%5Cpi"> and <img src="https://latex.codecogs.com/png.latex?q"> also indicate vectors of component probabilities, the expression simplifies as <img src="https://latex.codecogs.com/png.latex?%0A%5Csup_%7Bf%20%5Cin%20%5Cmathbb%7BR%7D%5En,%20%5C%7Cf%5C%7C%20%5Cleq%201%7D%20%5Clangle%20f,%20E_%7BX%20%5Csim%20%5Cpi%7D%5BX%5D,%20-%20E_%7BX%20%5Csim%20q%7D%5BX%5D%20%5Crangle%20=%20%5C%7C%5Cpi%20-%20q%5C%7C_2%5E2%20%5C%5C%0A"> Our problem, therefore, is to project <img src="https://latex.codecogs.com/png.latex?%5Cpi"> onto the space of all <img src="https://latex.codecogs.com/png.latex?q"> for which <img src="https://latex.codecogs.com/png.latex?%5C%7Cq%5C%7C_1%20=%201"> (the sum of components is 1) and <img src="https://latex.codecogs.com/png.latex?%5C%7Cq%5C%7C_0%20=%20b"> (the total number of non-zero components is <img src="https://latex.codecogs.com/png.latex?b">).</p>
<p>This space is not convex, but we can get around this by fixing a binary mask vector <img src="https://latex.codecogs.com/png.latex?m"> with 1-norm <img src="https://latex.codecogs.com/png.latex?b"> and minimizing <img src="https://latex.codecogs.com/png.latex?%5C%7C%5Cpi%20-%20m%20%5Codot%20q%5C%7C_2%5E2"> over all unit <img src="https://latex.codecogs.com/png.latex?q">, where <img src="https://latex.codecogs.com/png.latex?%5Codot"> indicates the Hadamard product. This gives us the Lagrangian <img src="https://latex.codecogs.com/png.latex?%0AL(%5Clambda,%20q)%20=%20%5C%7Cm%20%5Codot%20q%5C%7C%5E2%20-%202%20%5Clangle%20m%20%5Codot%20%5Cpi,%20q%20%5Crangle%20+%20%5Clambda%20(%5Clangle%20q,%20m%20%5Crangle%20-%201).%0A"> The derivative with respect to <img src="https://latex.codecogs.com/png.latex?q_i"> is zero when <img src="https://latex.codecogs.com/png.latex?2m_i%20q_i%20-%202m_i%20%5Cpi_i%20+%20%5Clambda%20m_i%20=%200"> from which we can conclude that <img src="https://latex.codecogs.com/png.latex?q_i%20=%20%5Cpi_i%20+%20c"> for some normalizing constant <img src="https://latex.codecogs.com/png.latex?c"> shared by all components in the support.</p>
<p>We can plug in this result about the optimal <img src="https://latex.codecogs.com/png.latex?q_i"> and solve to find the optimal <img src="https://latex.codecogs.com/png.latex?m_i">. Let <img src="https://latex.codecogs.com/png.latex?S"> be the support of <img src="https://latex.codecogs.com/png.latex?q"> we get from <img src="https://latex.codecogs.com/png.latex?m"> and <img src="https://latex.codecogs.com/png.latex?1"> be the all ones vector. We want to minimize <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Ctext%7BMMD%7D%20&amp;=%20%5C%7Cm%5Cpi%20+%20%5Cfrac%7B%5Clangle%201-m,%20%5Cpi%20%5Crangle%7D%7Bb%7Dm%20-%20%5Cpi%5C%7C%5E2%20%5C%5C%0A&amp;=%20%5Csum_i%20%5Cleft(%201_%7Bi%20%5Cnotin%20S%7D%20%5Cpi_i%20+%201_%7Bi%20%5Cin%20S%7D%5Cfrac%7B%5Clangle%201-m,%20%5Cpi%20%5Crangle%7D%7Bb%7D%5Cright)%5E2%20%5C%5C%0A&amp;=%20(1%20-%20b)%20+%20%5Csum_%7Bi%20%5Cnotin%20S%7D%20%5Cpi_i%5E2%0A%5Cend%7Balign*%7D%0A"> Clearly, this quantity is minimized by choosing <img src="https://latex.codecogs.com/png.latex?S"> to contain the <img src="https://latex.codecogs.com/png.latex?b"> most likely components of <img src="https://latex.codecogs.com/png.latex?%5Cpi">.</p>
</section>
<section id="unbiased-mmd-minimization" class="level3">
<h3 class="anchored" data-anchor-id="unbiased-mmd-minimization">Unbiased MMD Minimization</h3>
<p>The approximation schemes we’ve looked at so far have been deterministic: to make a <img src="https://latex.codecogs.com/png.latex?b"> particle approximation <img src="https://latex.codecogs.com/png.latex?q"> to a more complicated distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi">, we always choose <img src="https://latex.codecogs.com/png.latex?q">’s support <img src="https://latex.codecogs.com/png.latex?S"> to be the <img src="https://latex.codecogs.com/png.latex?b"> most likely elements in <img src="https://latex.codecogs.com/png.latex?%5Cpi">. But because of this determinism, these approximations are biased. By <em>biased</em> here, I mean that it is not generally the case that <img src="https://latex.codecogs.com/png.latex?E%5B%5Csum_%7Bi=1%7D%5En%20q_i%20f(x_i)%5D%20%5Cneq%20E_%7BX%20%5Csim%20%5Cpi%7D%20f(X)"> for any function <img src="https://latex.codecogs.com/png.latex?f"> unless <img src="https://latex.codecogs.com/png.latex?b"> is large enough to capture the full support of <img src="https://latex.codecogs.com/png.latex?%5Cpi">.</p>
<p>If this property (unbiased-ness) was more important to us than truly minimizing the maximum mean discrepancy, we could instead try to choose <img src="https://latex.codecogs.com/png.latex?S"> stochastically. Specifically, we could do the following: - Assign each outcome <img src="https://latex.codecogs.com/png.latex?i"> in <img src="https://latex.codecogs.com/png.latex?%5Cpi">’s support a weight <img src="https://latex.codecogs.com/png.latex?w_i">. - Sample an outcome with probability proportional to the remaining weights. - Put that outcome in <img src="https://latex.codecogs.com/png.latex?S"> and prevent it from being sampled again. - Repeat <img src="https://latex.codecogs.com/png.latex?b"> times.</p>
<p>With this scheme, the number of times outcome <img src="https://latex.codecogs.com/png.latex?i"> is included in <img src="https://latex.codecogs.com/png.latex?S"> is given by <a href="https://web.archive.org/web/https://en.wikipedia.org/wiki/Wallenius%27_noncentral_hypergeometric_distribution">Wallenius’ non-central hypergeometric distribution</a> with success-outcomes parameter <img src="https://latex.codecogs.com/png.latex?m_1%20=1">, total outcomes parameter <img src="https://latex.codecogs.com/png.latex?N"> being the size of <img src="https://latex.codecogs.com/png.latex?%5Cpi">’s support, draws parameter <img src="https://latex.codecogs.com/png.latex?n=b">, and odds parameter <img src="https://latex.codecogs.com/png.latex?%5Ctheta_i%20=%20%5Cfrac%7B(n-1)w_i%7D%7B1%20-%20w_i%7D">. If we know the odds parameter <img src="https://latex.codecogs.com/png.latex?%5Ctheta_i">, we can get back <img src="https://latex.codecogs.com/png.latex?w_i"> using <img src="https://latex.codecogs.com/png.latex?%5Csigma(%5Clog(%5Ctheta_i%20/%20(n-1)))"> where <img src="https://latex.codecogs.com/png.latex?%5Csigma"> is the standard logistic function.</p>
<p>Once we choose the support set <img src="https://latex.codecogs.com/png.latex?S">, we can deterministically assign probabilities to each outcome in <img src="https://latex.codecogs.com/png.latex?q"> to minimize the maximum mean discrepancy from our target distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi">. As shown above, the optimal choice is to set <img src="https://latex.codecogs.com/png.latex?q_i%20=%20%5Cpi_i%20+%20c"> where <img src="https://latex.codecogs.com/png.latex?c"> is the equally distributed un-allocated probability mass <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7Bb%7D%20%5Csum_%7Bj%20%5Cnotin%20S%7D%20%5Cpi_j">.</p>
<p>Now, we can choose the <img src="https://latex.codecogs.com/png.latex?w_i"> for each outcome in such a way that <img src="https://latex.codecogs.com/png.latex?%5Cpi_i%20=%20E%5Bq_i%5D">, making <img src="https://latex.codecogs.com/png.latex?q"> <em>unbiased</em> unlike the deterministic approximation discussed earlier. Let <img src="https://latex.codecogs.com/png.latex?s_i%20=%20P(i%20%5Cin%20S)"> and <img src="https://latex.codecogs.com/png.latex?r_i%20=%201%20-%20s_i">. <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cpi_i%20&amp;=%20E%5B1_%7Bi%20%5Cin%20S%7D(%5Cpi_i%20+%20%5Cfrac%7B1%7D%7Bb%7D%5Csum_j%201_%7Bj%20%5Cnotin%20S%7D%20P_j)%5D%20%5C%5C%0A&amp;=%20s_i(%5Cpi_i%20+%20%5Cfrac%7B1%7D%7Bb%7D%5Csum_j%20%5Cpi_j%20(1%20-%20s_j))%20%5C%5C%0Ab(1-s_i)%5Cpi_i%20&amp;=%20%5Csum_j%20%5Cpi_j%20(1%20-%20s_j)%20%5C%5C%0A(b%20-%201)r_i%20%5Cpi_i%20&amp;=%20%5Csum_%7Bj%20%5Cneq%20i%7D%20%5Cpi_j%20r_i%0A%5Cend%7Balign*%7D%0A"> This holds for all <img src="https://latex.codecogs.com/png.latex?i"> simultaneously, so letting <img src="https://latex.codecogs.com/png.latex?P"> be the matrix with <img src="https://latex.codecogs.com/png.latex?%5Cpi"> along its diagonal and <img src="https://latex.codecogs.com/png.latex?1"> be the all ones matrix, we can write the above equation in vectorized form as <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A(b-1)Pr%20&amp;=%20(1-I)Pr%20%5C%5C%0A((b-1)I%20-%201%20+%20I)Pr%20&amp;=%200%20%5C%5C%0A(bI%20-%201)Pr%20&amp;=%200%20%5C%5C%0A%5Cend%7Balign*%7D%0A"> We can see that if we find an eigenvector of <img src="https://latex.codecogs.com/png.latex?(bI%20-%201)P"> with eigenvalue zero, the entries will indicate the probability mass functions of our our non-central hypergeometric distributions at zero.</p>
<p>However, as <img src="https://latex.codecogs.com/png.latex?(bI%20-%201)"> is nonsingular for nonzero <img src="https://latex.codecogs.com/png.latex?b">, no such eigenvalue exists! This means this whole approach is actually impossible. <strong>We can’t randomly choose a support and then optimally pick the weights if we want the result to be unbiased.</strong> We can either choose optimal weights, or we can have an unbiased approximation. Having both at the same time is fundamentally impossible.</p>
</section>
<section id="quasi-monte-carlo-approximation" class="level3">
<h3 class="anchored" data-anchor-id="quasi-monte-carlo-approximation">Quasi Monte Carlo Approximation</h3>
<p>If we’d prefer to have unbiased-ness to optimal weights, there are other finite particle approximation strategies we could use besides standard Monte Carlo. One simple approach is to use randomized lattice <a href="https://web.archive.org/web/https://en.wikipedia.org/wiki/Quasi-Monte_Carlo_method">Quasi Monte Carlo</a>. The basic idea goes like this: - Let <img src="https://latex.codecogs.com/png.latex?u_i%20=%20i/b"> for <img src="https://latex.codecogs.com/png.latex?b"> different particles. - Choose a random number <img src="https://latex.codecogs.com/png.latex?s"> between 0 and 1 and add it to all the <img src="https://latex.codecogs.com/png.latex?u_i"> mod 1. These are unbiased, evenly dispersed samples from a uniform distribution. - Now apply the inverse CDF <img src="https://latex.codecogs.com/png.latex?%5CPhi"> of <img src="https://latex.codecogs.com/png.latex?%5Cpi"> to each of these samples. Here, we’re assuming an ordering among the possible outcomes; if <img src="https://latex.codecogs.com/png.latex?%5CPhi(0.3)%20=%203">, for example, that would mean that 30% of <img src="https://latex.codecogs.com/png.latex?%5Cpi">’s probability mass is for outcomes below 3. This is known as inverse transform sampling, and guarantees we’ll get unbiased samples from <img src="https://latex.codecogs.com/png.latex?%5Cpi">! We’ll set all the weights to be <img src="https://latex.codecogs.com/png.latex?1/b">, just as in the standard Monte Carlo case.</p>
<p>Some connections to think about: when the <img src="https://latex.codecogs.com/png.latex?%5Cpi"> we’re trying to approximate is a the empirical distribution of particles during a round of sequential Monte Carlo, this approximation is known as <em>systematic resampling</em>. If, as is often the case in probabilistic programming, we’re not trying to sample from a single categorical distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi">, but rather a sequence of dependent distributions <img src="https://latex.codecogs.com/png.latex?%5Cpi%5E1,%20%5Cpi%5E2,%20%5Cdotsc">, we can sample our uniform grid in the unit hypercube rather than along the unit interval and apply the inverse CDF of <img src="https://latex.codecogs.com/png.latex?%5Cpi%5Ei"> to the <img src="https://latex.codecogs.com/png.latex?i">th coordinates. In multiple dimensions, however, a uniform grid might not be the best idea. If we try to pick the lattice structure in a way that minimizes MMD between <img src="https://latex.codecogs.com/png.latex?q"> and <img src="https://latex.codecogs.com/png.latex?%5Cpi">, the best choice of lattice will depend on the class of functions <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BH%7D"> we’re considering for the MMD. For example, one common RKHS for multidimensional spaces has a kernel that is just the product of the kernels for each dimension. If the kernel for one of the dimensions has a lower bandwidth, it will make sense to pack our grid points more tightly in this dimension.</p>


</section>

 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/finite_particle_approx.html</guid>
  <pubDate>Tue, 02 Apr 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Nearest Neighbor Gaussian Processes</title>
  <link>https://samanklesaria.github.io/posts/nearest_neighbor_gps/nngp.html</link>
  <description><![CDATA[ 





<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">KernelFunctions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">SparseArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">AbstractGPs</span></span></code></pre></div></div>
</div>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CairoMakie</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">AbstractGPsMakie</span></span>
<span id="cb2-2">CairoMakie.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enable_only_mime!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span>)</span></code></pre></div></div>
</div>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ParameterHandling</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Optim</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Zygote</span></span></code></pre></div></div>
</div>
<p>In a <em><img src="https://latex.codecogs.com/png.latex?k">-Nearest Neighbor Gaussian Process</em>, we assume that the input points <img src="https://latex.codecogs.com/png.latex?x"> are ordered in such a way that <img src="https://latex.codecogs.com/png.latex?f(x_i)"> is independent of <img src="https://latex.codecogs.com/png.latex?f(x_j)"> whenever <img src="https://latex.codecogs.com/png.latex?i%20%3E%20j%20+%20k">. When <img src="https://latex.codecogs.com/png.latex?k=2">, for example, this means we can generate the sequence of process values by sampling the first value, then sampling the second given the first, then the third given the first two, then the fourth given the second and third, and so on.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Af_1%20&amp;%5Csim%20p(f_1)%20%5C%5C%0Af_2%20&amp;%5Csim%20p(f_2%20%7C%20f_1)%20%5C%5C%0Af_3%20&amp;%5Csim%20p(f_3%20%7C%20f_1,%20f_2)%20%5C%5C%0Af_4%20&amp;%5Csim%20p(f_4%20%7C%20f_2,%20f_3)%20%5C%5C%0A%5Cdotsc%0A%5Cend%7Balign*%7D%0A"></p>
<p>The conditional distribution for <img src="https://latex.codecogs.com/png.latex?f_i"> with <img src="https://latex.codecogs.com/png.latex?k">-predecessors in the set <img src="https://latex.codecogs.com/png.latex?S"> has mean <img src="https://latex.codecogs.com/png.latex?K_%7Bi,%20S%7DK_%7BS,S%7D%5E%7B-1%7D%20f_S"> and variance <img src="https://latex.codecogs.com/png.latex?K_%7Bi,%20i%7D%20-%20K_%7Bi,%20S%7DK_%7BS,S%7D%5E%7B-1%7D%20K_%7Bi,S%7D">. This means we can write the generation procedure as</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Af_1%20&amp;=%20%5Ceta_1%20%5C%5C%0Af_2%20&amp;=%20K_%7B2,%201%7DK_%7B1,1%7D%5E%7B-1%7Df_1%20+%20%5Ceta_2%20%5C%5C%0Af_3%20&amp;=%20K_%7B3,%20(2,1)%7DK_%7B(2,1),(2,1)%7D%5E%7B-1%7Df_%7B(2,1)%7D%20+%20%5Ceta_3%20%5C%5C%0Af_4%20&amp;=%20K_%7B4,%20(3,2)%7DK_%7B(3,2),%20(3,2)%7D%5E%7B-1%7Df_%7B(3,2)%7D%20+%20%5Ceta_3%20%5C%5C%0A%5Cdotsc%0A%5Cend%7Balign*%7D%0A"> where <img src="https://latex.codecogs.com/png.latex?%5Ceta_i%20%5Csim%20%5Cmathcal%7BN%7D(0,%20K_%7Bi,%20i%7D%20-%20K_%7Bi,%20S%7DK_%7BS,S%7D%5E%7B-1%7D%20K_%7Bi,S%7D)">. In matrix form, this means <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Af%20&amp;=%20Bf%20+%20%5Ceta%0Af%20&amp;=%20(I%20-%20B)%5E%7B-1%7D%5Ceta%0A%5Cend%7Balign*%7D%0A"> where <img src="https://latex.codecogs.com/png.latex?B"> is the strictly lower triangular matrix that comes from stacking zero-padded rows of the form <img src="https://latex.codecogs.com/png.latex?K_%7Bi,%20S%7DK_%7BSS%7D%5E%7B-1%7D">. This shows that <img src="https://latex.codecogs.com/png.latex?f"> has a precision matrix of the form <img src="https://latex.codecogs.com/png.latex?UU%5ET"> where <img src="https://latex.codecogs.com/png.latex?L=(I%20-%20B)%5ETF%5E%7B-1/2%7D"> and <img src="https://latex.codecogs.com/png.latex?F"> is diagonal.</p>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>We assume that <code>pts</code> are in order, and that each point is independent of all the previous ones given the previous <code>k</code>.</p>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_B</span>(pts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector{T}</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>, kern<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Kernel</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {T}</span>
<span id="cb4-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pts)</span>
<span id="cb4-3">    js <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>[]</span>
<span id="cb4-4">    is <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>[]</span>
<span id="cb4-5">    vals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T[]</span>
<span id="cb4-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n</span>
<span id="cb4-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-8">            ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T[]</span>
<span id="cb4-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb4-10">            ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pts[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> k)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb4-12">        row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernelmatrix</span>(kern, ns) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>.(ns, pts[i])</span>
<span id="cb4-13">        start_ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> k, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-14">        col_ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">start_ix+length</span>(row)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-15">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append!</span>(js, col_ixs)</span>
<span id="cb4-16">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append!</span>(is, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fill</span>(i, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(col_ixs)))</span>
<span id="cb4-17">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append!</span>(vals, row)</span>
<span id="cb4-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb4-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse</span>(is, js, vals, n, n)</span>
<span id="cb4-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>make_B (generic function with 1 method)</code></pre>
</div>
</div>
<p>To the understand the form of the B matrix described above more clearly, consider its form in a 2-nearest neighbor Gaussian Process.</p>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1">pts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.0</span>]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6-element Vector{Float64}:
 1.0
 2.0
 3.5
 4.2
 5.9
 8.0</code></pre>
</div>
</div>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1">kern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SqExponentialKernel</span>()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Squared Exponential Kernel (metric = Distances.Euclidean(0.0))</code></pre>
</div>
</div>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1">B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_B</span>(pts, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, kern)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6×6 SparseMatrixCSC{Float64, Int64} with 9 stored entries:
   ⋅          ⋅          ⋅          ⋅          ⋅         ⋅ 
  0.606531    ⋅          ⋅          ⋅          ⋅         ⋅ 
 -0.242002   0.471434    ⋅          ⋅          ⋅         ⋅ 
   ⋅        -0.184647   0.842651    ⋅          ⋅         ⋅ 
   ⋅          ⋅        -0.331424   0.495153    ⋅         ⋅ 
   ⋅          ⋅          ⋅        -0.0267458  0.116556   ⋅ </code></pre>
</div>
</div>
<p>The <img src="https://latex.codecogs.com/png.latex?F"> matrix can be constructed analogously.</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_F</span>(pts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector{T}</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>, kern<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Kernel</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> {T}</span>
<span id="cb12-2">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pts)</span>
<span id="cb12-3">    vals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T[]</span>
<span id="cb12-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n</span>
<span id="cb12-5">        prior <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>(pts[i], pts[i])</span>
<span id="cb12-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-7">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(vals, prior)</span>
<span id="cb12-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb12-9">            ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pts[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> k)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb12-10">            ki <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kern</span>.(ns, pts[i])</span>
<span id="cb12-11">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(vals, prior <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dot</span>(ki, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernelmatrix</span>(kern, ns) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> ki))</span>
<span id="cb12-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb12-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb12-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(vals)</span>
<span id="cb12-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>make_F (generic function with 1 method)</code></pre>
</div>
</div>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1">F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_F</span>(pts, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, kern)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6×6 Diagonal{Float64, Vector{Float64}}:
 1.0   ⋅         ⋅         ⋅         ⋅         ⋅ 
  ⋅   0.632121   ⋅         ⋅         ⋅         ⋅ 
  ⋅    ⋅        0.857581   ⋅         ⋅         ⋅ 
  ⋅    ⋅         ⋅        0.356873   ⋅         ⋅ 
  ⋅    ⋅         ⋅         ⋅        0.901874   ⋅ 
  ⋅    ⋅         ⋅         ⋅         ⋅        0.987169</code></pre>
</div>
</div>
<p>The associated covariance matrix has the form <img src="https://latex.codecogs.com/png.latex?(I-B)%5E%7B-1%7DF(I-B)%5E%7B-1%7D">. We can compare this approximation to the full (non nearest-neighbor) covariance matrix.</p>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> B) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(F)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6×6 Matrix{Float64}:
  1.0          0.0          0.0        0.0        0.0      0.0
  0.606531     0.79506      0.0        0.0        0.0      0.0
  0.0439369    0.374819     0.926056   0.0        0.0      0.0
 -0.0749706    0.169036     0.780342   0.597388   0.0      0.0
 -0.0516836   -0.0405252    0.0794716  0.295798   0.94967  0.0
 -0.00401888  -0.00924444  -0.011608   0.0184994  0.11069  0.993564</code></pre>
</div>
</div>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> L<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6×6 Matrix{Float64}:
  1.0          0.606531     0.0439369  -0.0749706    -0.0516836  -0.00401888
  0.606531     1.0          0.324652    0.0889216    -0.0635677  -0.00978746
  0.0439369    0.324652     1.0         0.782705      0.0561348  -0.0143912
 -0.0749706    0.0889216    0.782705    1.0           0.235746    0.000731802
 -0.0516836   -0.0635677    0.0561348   0.235746      1.0         0.110251
 -0.00401888  -0.00978746  -0.0143912   0.000731802   0.110251    1.0</code></pre>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernelmatrix</span>(kern, pts)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6×6 Matrix{Float64}:
 1.0          0.606531     0.0439369   0.00597602   6.11357e-6   2.28973e-11
 0.606531     1.0          0.324652    0.0889216    0.000497955  1.523e-8
 0.0439369    0.324652     1.0         0.782705     0.0561348    4.00653e-5
 0.00597602   0.0889216    0.782705    1.0          0.235746     0.000731802
 6.11357e-6   0.000497955  0.0561348   0.235746     1.0          0.110251
 2.28973e-11  1.523e-8     4.00653e-5  0.000731802  0.110251     1.0</code></pre>
</div>
</div>
<p>The two are pretty close!</p>
</section>
<section id="interface" class="level2">
<h2 class="anchored" data-anchor-id="interface">Interface</h2>
<p>To make this usable with Julia’s AbstractGPs library, we’ll add a new method for the <code>posterior</code> function.</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> NearestNeighbors</span>
<span id="cb22-2">    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span></span>
<span id="cb22-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> InvRoot{A}</span>
<span id="cb23-2">    U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb23-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1">AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag_Xt_invA_X</span>(A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">InvRoot</span>, X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVecOrMat</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag_At_A</span>(A.U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X)</span></code></pre></div></div>
</div>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">NearestNeighbors</span>, fx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractGPs.FiniteGP</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb25-2">    kern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fx.f.kernel</span>
<span id="cb25-3">    F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_F</span>(fx.x, nn.k, kern)</span>
<span id="cb25-4">    B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_B</span>(fx.x, nn.k, kern)</span>
<span id="cb25-5">    U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UpperTriangular</span>((I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> B)<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' * inv(sqrt(F)))</span></span>
<span id="cb25-6">    δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(fx)</span>
<span id="cb25-7">    α <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> δ)</span>
<span id="cb25-8">    C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">InvRoot</span>(U)</span>
<span id="cb25-9">    AbstractGPs.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PosteriorGP</span>(fx.f, (α<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>α, C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>C, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fx.x, δ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>δ))</span>
<span id="cb25-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
</div>
<p>Here’s how we use it:</p>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>.(pts)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>6-element Vector{Float64}:
  0.8414709848078965
  0.9092974268256817
 -0.35078322768961984
 -0.8715757724135882
 -0.373876664830236
  0.9893582466233818</code></pre>
</div>
</div>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1">fx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(kern)(pts, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>AbstractGPs.FiniteGP{AbstractGPs.GP{AbstractGPs.ZeroMean{Float64}, KernelFunctions.SqExponentialKernel{Distances.Euclidean}}, Vector{Float64}, LinearAlgebra.Diagonal{Float64, FillArrays.Fill{Float64, 1, Tuple{Base.OneTo{Int64}}}}}(
f: GP{ZeroMean{Float64}, SqExponentialKernel{Distances.Euclidean}}(ZeroMean{Float64}(), Squared Exponential Kernel (metric = Distances.Euclidean(0.0)))
x: [1.0, 2.0, 3.5, 4.2, 5.9, 8.0]
Σy: Diagonal(Fill(0.0, 6))
)</code></pre>
</div>
</div>
<p>Note that the nearest neighbor approximation requires a noise-free GP.</p>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1">post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NearestNeighbors</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), fx, y)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>AbstractGPs.PosteriorGP{GP{ZeroMean{Float64}, SqExponentialKernel{Distances.Euclidean}}, @NamedTuple{α::Vector{Float64}, C::InvRoot{UpperTriangular{Float64, SparseMatrixCSC{Float64, Int64}}}, x::Vector{Float64}, δ::Vector{Float64}}}(GP{ZeroMean{Float64}, SqExponentialKernel{Distances.Euclidean}}(ZeroMean{Float64}(), Squared Exponential Kernel (metric = Distances.Euclidean(0.0))), (α = [0.44959487401574766, 0.634378019439147, 0.31422639172541256, -1.1208602827978673, -0.23967552424377783, 1.0165902480943727], C = InvRoot{UpperTriangular{Float64, SparseMatrixCSC{Float64, Int64}}}([1.0 -0.7628739783668902 … 0.06024322535476907 -0.006784618661573238; 0.0 1.2577665549971213 … -0.12457526770687782 0.0140347496063293; … ; 0.0 0.0 … 1.0570415005635936 -0.12359893384397007; 0.0 0.0 … 0.0 1.0068137091164393]), x = [1.0, 2.0, 3.5, 4.2, 5.9, 8.0], δ = [0.8414709848078965, 0.9092974268256817, -0.35078322768961984, -0.8715757724135882, -0.373876664830236, 0.9893582466233818]))</code></pre>
</div>
</div>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, post)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/nearest_neighbor_gps/nngp_files/figure-html/cell-21-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="optimizing-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-hyperparameters">Optimizing Hyperparameters</h2>
<p>The last thing necessary to make this technique usable in practice is to ensure it works with autodifferentiation so that we can optimize hyperparameters like lengthscales.</p>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1">initial_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">positive</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>), lengthscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">positive</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(var = ParameterHandling.Positive{Float64, typeof(exp), Float64}(-1.490116130486996e-8, exp, 1.4901161193847656e-8), lengthscale = ParameterHandling.Positive{Float64, typeof(exp), Float64}(-1.490116130486996e-8, exp, 1.4901161193847656e-8))</code></pre>
</div>
</div>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1">flat_initial_params, unflatten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParameterHandling.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value_flatten</span>(initial_params)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([-1.490116130486996e-8, -1.490116130486996e-8], ParameterHandling.value ∘ ParameterHandling.var"#unflatten_to_NamedTuple#flatten##13"{Float64, @NamedTuple{var::ParameterHandling.Positive{Float64, typeof(exp), Float64}, lengthscale::ParameterHandling.Positive{Float64, typeof(exp), Float64}}, ParameterHandling.var"#unflatten_to_Tuple#flatten##11"{Float64, Int64, Int64, ParameterHandling.var"#unflatten_to_Tuple#flatten##11"{Float64, Int64, Int64, ParameterHandling.var"#unflatten_to_empty_Tuple#flatten##12"{Float64, Tuple{}}, ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}}, ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}}}((var = ParameterHandling.Positive{Float64, typeof(exp), Float64}(-1.490116130486996e-8, exp, 1.4901161193847656e-8), lengthscale = ParameterHandling.Positive{Float64, typeof(exp), Float64}(-1.490116130486996e-8, exp, 1.4901161193847656e-8)), ParameterHandling.var"#unflatten_to_Tuple#flatten##11"{Float64, Int64, Int64, ParameterHandling.var"#unflatten_to_Tuple#flatten##11"{Float64, Int64, Int64, ParameterHandling.var"#unflatten_to_empty_Tuple#flatten##12"{Float64, Tuple{}}, ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}}, ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}}(1, 1, ParameterHandling.var"#unflatten_to_Tuple#flatten##11"{Float64, Int64, Int64, ParameterHandling.var"#unflatten_to_empty_Tuple#flatten##12"{Float64, Tuple{}}, ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}}(0, 1, ParameterHandling.var"#unflatten_to_empty_Tuple#flatten##12"{Float64, Tuple{}}(()), ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}(ParameterHandling.Positive{Float64, typeof(exp), Float64}(-1.490116130486996e-8, exp, 1.4901161193847656e-8), ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}())), ParameterHandling.var"#unflatten_Positive#flatten##19"{Float64, ParameterHandling.Positive{Float64, typeof(exp), Float64}, ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}}(ParameterHandling.Positive{Float64, typeof(exp), Float64}(-1.490116130486996e-8, exp, 1.4901161193847656e-8), ParameterHandling.var"#unflatten_to_Real#flatten##2"{Float64, Float64}()))))</code></pre>
</div>
</div>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_gp</span>(params)</span>
<span id="cb37-2">    k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params.var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_lengthscale</span>(kern, params.lengthscale)</span>
<span id="cb37-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GP</span>(k2)(pts, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb37-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>build_gp (generic function with 1 method)</code></pre>
</div>
</div>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">objective</span>(flat_params)</span>
<span id="cb39-2">    params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unflatten</span>(flat_params)</span>
<span id="cb39-3">    fx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_gp</span>(params)</span>
<span id="cb39-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-logpdf</span>(fx, y)</span>
<span id="cb39-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>objective (generic function with 1 method)</code></pre>
</div>
</div>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1">training_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optim.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimize</span>(</span>
<span id="cb41-2">    objective,</span>
<span id="cb41-3">    θ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">only</span>(Zygote.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gradient</span>(objective, θ)),</span>
<span id="cb41-4">    flat_initial_params,</span>
<span id="cb41-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">BFGS</span>(</span>
<span id="cb41-6">        alphaguess<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Optim.LineSearches.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">InitialStatic</span>(scaled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>),</span>
<span id="cb41-7">        linesearch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Optim.LineSearches.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">BackTracking</span>(),</span>
<span id="cb41-8">    ),</span>
<span id="cb41-9">    inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>,</span>
<span id="cb41-10">)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code> * Status: success

 * Candidate solution
    Final objective value:     4.130829e+00

 * Found with
    Algorithm:     BFGS

 * Convergence measures
    |x - x'|               = 2.86e-07 ≰ 0.0e+00
    |x - x'|/|x'|          = 4.80e-07 ≰ 0.0e+00
    |f(x) - f(x')|         = 2.19e-12 ≰ 0.0e+00
    |f(x) - f(x')|/|f(x')| = 5.31e-13 ≰ 0.0e+00
    |g(x)|                 = 4.43e-09 ≤ 1.0e-08

 * Work counters
    Seconds run:   0  (vs limit Inf)
    Iterations:    11
    f(x) calls:    18
    ∇f(x) calls:   12</code></pre>
</div>
</div>
<p>With optimized parameters, we get much less uncertainty in our predictions.</p>
<div id="52" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NearestNeighbors</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb43-2">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_gp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unflatten</span>(training_results.minimizer)), y))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/nearest_neighbor_gps/nngp_files/figure-html/cell-27-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/nearest_neighbor_gps/nngp.html</guid>
  <pubDate>Fri, 16 Feb 2024 06:00:00 GMT</pubDate>
</item>
<item>
  <title>Krylov Methods</title>
  <link>https://samanklesaria.github.io/posts/Krylov-Methods.html</link>
  <description><![CDATA[ 





<p>The <img src="https://latex.codecogs.com/png.latex?i">th <em>Krylov subspace</em> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BK%7D_i"> for a symmetric matrix <img src="https://latex.codecogs.com/png.latex?A"> starting from vector <img src="https://latex.codecogs.com/png.latex?b"> is the subspace spanned by the vectors <img src="https://latex.codecogs.com/png.latex?b,%20Ab,%20A%5E2b,%20%5Cdotsc%20A%5E%7Bi-1%7Db">. Algorithms that use these subspaces are called Krylov subspace methods. To see why this subspace can be useful, it helps to see some examples.</p>
<section id="the-lanczos-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="the-lanczos-algorithm">The Lanczos Algorithm</h3>
<p>The Lanczos algorithm finds an orthonormal matrix <img src="https://latex.codecogs.com/png.latex?V"> and tridiagonal matrix <img src="https://latex.codecogs.com/png.latex?T"> so that <img src="https://latex.codecogs.com/png.latex?A%20=%20VTV%5ET">. The columns of <img src="https://latex.codecogs.com/png.latex?V"> are chosen from successive Krylov subspaces. <img src="https://latex.codecogs.com/png.latex?v_1"> is chosen to be <img src="https://latex.codecogs.com/png.latex?b/%20%5C%7Cb%5C%7C">. Afterwards, <img src="https://latex.codecogs.com/png.latex?v_i"> is just <img src="https://latex.codecogs.com/png.latex?Av_%7Bi-1%7D">, but normalized and without any components parallel to the previous columns. Specifically <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Aw_%7Bi+1%7D'%20&amp;=%20Av_i%20%5C%5C%0Aw_%7Bi+1%7D%20&amp;=%20w_%7Bi+1%7D'%20-%20%5Csum_%7Bk=1%7D%5Ei%20%5Clangle%20v_k,%20w_%7Bi+1%7D'%5Crangle%20v_k%20%5C%5C%0Av_%7Bi+1%7D%20&amp;=%20w_%7Bi+1%7D%20/%20%5C%7Cw_%7Bi+1%7D%5C%7C%0A%5Cend%7Balign*%7D%0A"> Note that this means <img src="https://latex.codecogs.com/png.latex?Av_k"> is a linear combination of <img src="https://latex.codecogs.com/png.latex?v_1"> through <img src="https://latex.codecogs.com/png.latex?v_%7Bk+1%7D">, so <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Clangle%20v_k%20,%20w_%7Bi+1%7D'%20%5Crangle%20&amp;=%20%5Clangle%20v_k%20,%20A%20v_i%20%5Crangle%20%5C%5C%0A&amp;=%20%5Clangle%20Av_k,%20v_i%20%5Crangle%20%5C%5C%0A&amp;=%20%5Cleft%20%5Clangle%20%5Csum_%7Bj=1%7D%5E%7Bk+1%7D%20c_j%20v_j%20,%20v_i%20%5Cright%5Crangle%0A%5Cend%7Balign*%7D%0A"> for some constants <img src="https://latex.codecogs.com/png.latex?c_j">. As the <img src="https://latex.codecogs.com/png.latex?v_i"> are chosen to be orthogonal, the inner product will be zero whenever <img src="https://latex.codecogs.com/png.latex?k+1%3Ci">. This means that we only need to orthogonalize each <img src="https://latex.codecogs.com/png.latex?w_%7Bi+1%7D%E2%80%99"> with respect to <img src="https://latex.codecogs.com/png.latex?v_i"> and <img src="https://latex.codecogs.com/png.latex?v_%7Bi-1%7D">; the rest will already be orthogonal. This property shows that <img src="https://latex.codecogs.com/png.latex?T%20=%20V%5ETAV"> (with entry <img src="https://latex.codecogs.com/png.latex?(i,j)"> of the form <img src="https://latex.codecogs.com/png.latex?v_i%5ETAv_j">) must be tridiagonal as required.</p>
<p>Finally, note that <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Clangle%20v_%7Bi-1%7D%20,%20w_%7Bi+1%7D'%20%5Crangle%20&amp;=%20%5Clangle%20Av_%7Bi-1%7D,%20v_i%20%5Crangle%20%5C%5C%0A&amp;=%20%5Clangle%20w_i',%20v_i%20%5Crangle%20%5C%5C%0A&amp;=%20%5Clangle%20w_i%20+%20c_1%20v_%7Bi-1%7D%20+%20c_2%20v_%7Bi-2%7D,%20v_i%20%5Crangle%20%5C%5C%0A&amp;=%20%5Clangle%20w_i%20,%20v_i%20%5Crangle%20%5C%5C%0A&amp;=%20%5Clangle%20w_i%20,%20w_i%20%5Crangle%20/%20%5C%7Cw_i%5C%7C%20=%20%5C%7Cw_i%5C%7C%0A%5Cend%7Balign*%7D%0A"></p>
<p>We already calculated this quantity when normalizing to get <img src="https://latex.codecogs.com/png.latex?v_i">, so this saves us an extra multiplication at each step.</p>
</section>
<section id="the-conjugate-gradients-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="the-conjugate-gradients-algorithm">The Conjugate Gradients Algorithm</h3>
<p>The conjugate gradients algorithm computes <img src="https://latex.codecogs.com/png.latex?A%5E%7B-1%7Db"> using a similar strategy. While the Lanczos algorithm makes <img src="https://latex.codecogs.com/png.latex?v_i"> orthogonal to the previous <img src="https://latex.codecogs.com/png.latex?v_j">, the conjugate gradients algorithm makes it <img src="https://latex.codecogs.com/png.latex?A">-orthogonal. We say that <img src="https://latex.codecogs.com/png.latex?v_i"> and <img src="https://latex.codecogs.com/png.latex?v_j"> are <img src="https://latex.codecogs.com/png.latex?A">-orthogonal when <img src="https://latex.codecogs.com/png.latex?v_i%5ETAv_j%20=%200">. I will also write <img src="https://latex.codecogs.com/png.latex?v_i%5ETAv_j"> as <img src="https://latex.codecogs.com/png.latex?%5Clangle%20v_i,%20v_j%20%5Crangle_A">.</p>
<p>Say there was a matrix where <img src="https://latex.codecogs.com/png.latex?u%20=%20%5Csum_t%20c_t%20v_t"> for <img src="https://latex.codecogs.com/png.latex?A">-orthogonal <img src="https://latex.codecogs.com/png.latex?v_t">. Then <img src="https://latex.codecogs.com/png.latex?%5Clangle%20v_i,u%20%5Crangle_A%20=%20c_i%20%5Clangle%20v_i,%20v_i%20%5Crangle_A">, so <img src="https://latex.codecogs.com/png.latex?c_i%20=%20%5Cfrac%7B%5Clangle%20v_i%20u%20%5Crangle_A%7D%7B%5Clangle%20v_i,%20v_i%20%5Crangle_A%7D">. This means we can make <img src="https://latex.codecogs.com/png.latex?u"> <img src="https://latex.codecogs.com/png.latex?A">-orthogonal to <img src="https://latex.codecogs.com/png.latex?v_i"> by subtracting <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Clangle%20v_i%20u%20%5Crangle_A%7D%7B%5Clangle%20v_i,%20v_i%20%5Crangle_A%7D%20v_i">.</p>
<p>This lets conjugate gradients compute the vectors <img src="https://latex.codecogs.com/png.latex?v_i"> as follows: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Aw_%7Bi+1%7D'%20&amp;=%20Av_i%20%5C%5C%0Aw_%7Bi+1%7D%20&amp;=%20w_%7Bi+1%7D'%20-%20%5Csum_%7Bk=1%7D%5Ei%20%5Cfrac%7B%5Clangle%20v_k,%20w_%7Bi+1%7D'%5Crangle_A%7D%7B%5Clangle%20v_k,%20v_k%5Crangle_A%7Dv_k%20%5C%5C%0Av_%7Bi+1%7D%20&amp;=%20w_%7Bi+1%7D/%5C%7Cw_%7Bi+1%7D%5C%7C%0A%5Cend%7Balign*%7D%0A"> This is exactly the same as the computation of the <img src="https://latex.codecogs.com/png.latex?v_i"> in the Lanczos algorithm except that the inner products use the <img src="https://latex.codecogs.com/png.latex?A"> metric.</p>
<p>Once we have an <img src="https://latex.codecogs.com/png.latex?A">-orthogonal basis like this, we can find an <img src="https://latex.codecogs.com/png.latex?x"> to minimize <img src="https://latex.codecogs.com/png.latex?%5C%7Cx%20-%20A%5E%7B-1%7Db%5C%7C_A"> (which is equivalent to finding <img src="https://latex.codecogs.com/png.latex?A%5E%7B-1%7Db"> if it exists). This is the same as minimizing <img src="https://latex.codecogs.com/png.latex?x%5ETAx%20-2x%5ETb">. Expressing <img src="https://latex.codecogs.com/png.latex?x"> as <img src="https://latex.codecogs.com/png.latex?%5Csum_i%20%5Calpha_i%20v_i"> and using A-orthogonality gives <img src="https://latex.codecogs.com/png.latex?%0A%5Csum_i%20(%5Calpha_i)%5E2%20v_i%5ETAv_i%20-%202%5Calpha_iv_i%5ETb%0A"> The derivative is zero when <img src="https://latex.codecogs.com/png.latex?%5Calpha_i%20=%20%5Cfrac%7Bv_i%5ETb%7D%7Bv_i%5ETAv_i%7D">. This lets us solve <img src="https://latex.codecogs.com/png.latex?A%5E%7B-1%7Db"> in a linear number of matrix vector multiplications. If multiplication by <img src="https://latex.codecogs.com/png.latex?A"> is <img src="https://latex.codecogs.com/png.latex?O(n%5E2)">, then this isn’t any better than <img src="https://latex.codecogs.com/png.latex?O(n%5E3)"> Gaussian elimination. But it’s often the case that multiplication by <img src="https://latex.codecogs.com/png.latex?A"> is much faster than that, especially if it’s sparse or Toeplitz or comes from a Kronecker product.</p>


</section>

 ]]></description>
  <category>math</category>
  <guid>https://samanklesaria.github.io/posts/Krylov-Methods.html</guid>
  <pubDate>Tue, 13 Feb 2024 06:00:00 GMT</pubDate>
</item>
<item>
  <title>Mapping with Gaussian Conditioning</title>
  <link>https://samanklesaria.github.io/posts/kalman/kalman.html</link>
  <description><![CDATA[ 





<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">SparseArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">FillArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Rotations</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">RecursiveArrayTools</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ForwardDiff</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">DiffResults</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LazyArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CairoMakie</span></span>
<span id="cb1-2">CairoMakie.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enable_only_mime!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span>)</span></code></pre></div></div>
</div>
<p>For a robot to navigate autonomously, it needs to learn the locations of any potential obsticles around it. One of the standard ways to do this is with an algorithm known as EKF-Slam. Slam stands for “simultaneous localization and mapping”, as the algorithm must simultaneously find out where the robot is (localization) and where the obstacles are (mapping). The “EKF” part refers to the “extended Kalman filter”, which is just a fancy name for Gaussian conditioning with Taylor approximations. The idea goes as follows:</p>
<p>Describe the robot by its position coordinates <img src="https://latex.codecogs.com/png.latex?u%20%5Cin%20%5Cmathbb%7BR%7D%5E2">. Assume it has a sensor that gives noisy measurements <img src="https://latex.codecogs.com/png.latex?Y"> of the displacement to an obstacle at location <img src="https://latex.codecogs.com/png.latex?v%20%5Cin%20%5Cmathbb%7BR%7D%5E2">. Specifically, assume <img src="https://latex.codecogs.com/png.latex?Y%20%5Csim%20%5Cmathcal%7BN%7D(v%20-%20u,%20%5CSigma_2)">.</p>
<p>Let our uncertainty about the locations <img src="https://latex.codecogs.com/png.latex?u"> and <img src="https://latex.codecogs.com/png.latex?v"> be jointly be described by the random variable <img src="https://latex.codecogs.com/png.latex?X%20%5Csim%20%5Cmathcal%7BN%7D(%5Cmu,%20%5CSigma_1)"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E4">. Given the observation <img src="https://latex.codecogs.com/png.latex?Y">, we’d like to find the posterior distribution over <img src="https://latex.codecogs.com/png.latex?X">.</p>
<p>Conditioning Gaussians is easier in the natural paramteterization. Instead of describing distributions with a mean <img src="https://latex.codecogs.com/png.latex?%5Cmu"> and covariance <img src="https://latex.codecogs.com/png.latex?%5CSigma">, we describe them with a precision <img src="https://latex.codecogs.com/png.latex?%5CLambda"> and information vector <img src="https://latex.codecogs.com/png.latex?%5CLambda%20%5Cmu">. In this parameterization, say <img src="https://latex.codecogs.com/png.latex?X%20%5Csim%20%5Cmathcal%7BN%7D(%5CLambda_1,%20%5CLambda_1%5Cmu_1)"> and <img src="https://latex.codecogs.com/png.latex?Y%20%5Csim%20%5Cmathcal%7BN%7D(%5CLambda_2,%20%5CLambda_2%20(Ax%20%20+%20b))"> where <img src="https://latex.codecogs.com/png.latex?A"> is a linear transformation. Then by Bayes’ rule, a little algebra tells us that <img src="https://latex.codecogs.com/png.latex?%0AX%20%7C%20y%20%5Csim%20%5Cmathcal%7BN%7D(%5CLambda_1%5Cmu%20+%20A%5ET%5CLambda_2(y%20-%20b),%20%5CLambda_1%20+%20A%5ET%5CLambda_2A)%0A"></p>
<p>When <img src="https://latex.codecogs.com/png.latex?X"> describes robot and obstacle locations and <img src="https://latex.codecogs.com/png.latex?Y"> describes noisy displacement observations as above, we get the posterior natural parameters <img src="https://latex.codecogs.com/png.latex?%0A(%5CSigma_1%5E%7B-1%7D%20%5Cmu%20+%20A%5ET%5CSigma_2%5E%7B-1%7DY,%20%5CSigma_1%5E%7B-1%7D%20+%20A%5ET%5CSigma_2%5E%7B-1%7DA)%0A"> where <img src="https://latex.codecogs.com/png.latex?A%20=%20%5Cbegin%7Bbmatrix%7D%20-I%20&amp;%20I%20%5Cend%7Bbmatrix%7D">.</p>
<p>We also need to update the distribution for <img src="https://latex.codecogs.com/png.latex?X"> when the robot moves. Say we know that the robot’s position was displaced by some <img src="https://latex.codecogs.com/png.latex?%5CDelta%20%5Csim%20%5Cmathcal%7BN%7D(%5Cdelta,%20%5CSigma_3)">. After this displacement</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AX%20%5Csim%20%5Cmathcal%7BN%7D%5Cleft(%5Cmu%20+%20%5Cbegin%7Bbmatrix%7D%20%5Cdelta%20%200%20%5Cend%7Bbmatrix%7D,%20%5CSigma_1%20+%20%5Cbegin%7Bbmatrix%7D%20%5CSigma_3%20&amp;%20%20%20&amp;%200%20%5Cend%7Bbmatrix%7D%5Cright)%0A"></p>
<p>By repeatedly updating our distribution over <img src="https://latex.codecogs.com/png.latex?X"> in response to observations <img src="https://latex.codecogs.com/png.latex?Y"> and movements <img src="https://latex.codecogs.com/png.latex?%5CDelta">, we can track the likely position of the robot and the obstacle over time.</p>
<section id="adding-a-heading" class="level2">
<h2 class="anchored" data-anchor-id="adding-a-heading">Adding a Heading</h2>
<p>To make this toy example slightly more realistic, let us also give the robot a heading angle <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. Assume now that the sensor measurement above is rotated <img src="https://latex.codecogs.com/png.latex?-%5Ctheta"> degrees, so that <img src="https://latex.codecogs.com/png.latex?Y%20=%20f(X)%20+%20%5Cepsilon">, where <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%20%5Csim%20%5Cmathcal%7BN%7D(0,%20%5CSigma_2)">, <img src="https://latex.codecogs.com/png.latex?f(x)%20=%20R_x(x_2%20-%20x_1)">, <img src="https://latex.codecogs.com/png.latex?x_1"> and <img src="https://latex.codecogs.com/png.latex?x_2"> refer to the robot and obstacle coordinate components of <img src="https://latex.codecogs.com/png.latex?x"> respectively, and <img src="https://latex.codecogs.com/png.latex?R_x"> is the corresponding rotation matrix. Although <img src="https://latex.codecogs.com/png.latex?f"> isn’t linear, we can use the Taylor approximation of <img src="https://latex.codecogs.com/png.latex?f"> about <img src="https://latex.codecogs.com/png.latex?%5Cmu"> to pretend it is. <img src="https://latex.codecogs.com/png.latex?%0Af(x)%20=%20f(%5Cmu%20+%20(x%20-%20%5Cmu))%20%5Capprox%20f(%5Cmu)%20+%20%5Cnabla%20f(%5Cmu)(x%20-%20%5Cmu)%0A"> This makes <img src="https://latex.codecogs.com/png.latex?Y"> a linear transformation of <img src="https://latex.codecogs.com/png.latex?X">, so we can continue to use the standard Gaussian conditioning formula. We get natural parameters</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A(%5CSigma_1%5E%7B-1%7D%20%5Cmu%20+%20J%5ET%5CSigma_2%5E%7B-1%7D(Y%20-%20b),%20%5CSigma_1%5E%7B-1%7D%20+%20J%5ET%5CSigma_2%5E%7B-1%7DJ)%0A"> where <img src="https://latex.codecogs.com/png.latex?J%20=%20%5Cnabla%20f(%5Cmu)"> and <img src="https://latex.codecogs.com/png.latex?b%20=%20f(%5Cmu)%20-%20J%20%5Cmu">. This expression naturally extends to handling observations for multiple obstacles.</p>
<p>This is the EKF-Slam algorithm in a nutshell. With the math out of the way, let’s get to some code.</p>
</section>
<section id="code-for-observing" class="level1">
<h1>Code for Observing</h1>
<p>While finding the Jacobian above analytically is easy enough, it’s even easier to let Julia do it with Forward mode automatic differentiation.</p>
<p>For ease of notation let <img src="https://latex.codecogs.com/png.latex?L=%5CSigma_2%5E%7B-2%7D">.</p>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1">L <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Eye</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×2 FillArrays.RectDiagonal{Float64, Vector{Float64}, Tuple{Base.OneTo{Int64}, Base.OneTo{Int64}}}:
 10.0    ⋅ 
   ⋅   10.0</code></pre>
</div>
</div>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_approx</span>(μ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>, ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractVector</span>)</span>
<span id="cb4-2">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffResults.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">JacobianResult</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), μ)</span>
<span id="cb4-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(μ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RotMatrix</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">{2}</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>μ[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (μ[ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> μ[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb4-4">    ForwardDiff.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jacobian!</span>(result, f, μ)</span>
<span id="cb4-5">    f_μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffResults.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(result)</span>
<span id="cb4-6">    J <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffResults.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jacobian</span>(result)</span>
<span id="cb4-7">    JL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> J<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> L</span>
<span id="cb4-8">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f_μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> J <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> μ</span>
<span id="cb4-9">    JL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> b), JL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> J</span>
<span id="cb4-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>obs_approx (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="code-for-moving" class="level1">
<h1>Code for Moving</h1>
<p>For simplicity, let’s assume that at each step in time, the robot walks in the direction <img src="https://latex.codecogs.com/png.latex?(1,1)"> and rotates its heading by <img src="https://latex.codecogs.com/png.latex?2%5Cpi/100"> radians.</p>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1">dμ_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">π</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3-element Vector{Float64}:
 1.0
 1.0
 0.06283185307179587</code></pre>
</div>
</div>
<p>These updates are noisy however, accounting for any imprecision in our dynamics model. Our uncertainty about the robot’s location increases at each step according to the following covariance matrix.</p>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1">Σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3_1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>])</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×3 Diagonal{Float64, Vector{Float64}}:
 1.0   ⋅    ⋅ 
  ⋅   1.0   ⋅ 
  ⋅    ⋅   0.02</code></pre>
</div>
</div>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>4</code></pre>
</div>
</div>
<p>We add this to our mean vector…</p>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1">dμ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparsevec</span>([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], dμ_1, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> N)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>11-element SparseVector{Float64, Int64} with 3 stored entries:
  [1]  =  1.0
  [2]  =  1.0
  [3]  =  0.0628319</code></pre>
</div>
</div>
<p>…and this to our covariance matrix…</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1">Σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_vcat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_hcat</span>(Σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3_1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> N)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> N))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>11×11 SparseMatrixCSC{Float64, Int64} with 3 stored entries:
 1.0   ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅   1.0   ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅   0.02   ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅     ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ </code></pre>
</div>
</div>
<p>… which can be factored as <img src="https://latex.codecogs.com/png.latex?U%20%5CSigma_%7B3,1%7D%20U'">, where <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AU%20=%20%5Cbegin%7Bbmatrix%7D%20I%20%200%20%5Cend%7Bbmatrix%7D%0A%5Cend%7Balign%7D%0A"></p>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1">U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Vcat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> N, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>vcat(3×3 Diagonal{Float64, Vector{Float64}}, 8×3 Zeros{Float64}):
 1.0   ⋅    ⋅ 
  ⋅   1.0   ⋅ 
  ⋅    ⋅   1.0
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ 
  ⋅    ⋅    ⋅ </code></pre>
</div>
</div>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1">V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SparseMatrixCSC</span>(U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×11 SparseMatrixCSC{Float64, Int64} with 3 stored entries:
 1.0   ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅   1.0   ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ 
  ⋅    ⋅   1.0   ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅    ⋅ </code></pre>
</div>
</div>
<p>This is a low rank matrix. And we’ll need to invert the resut when we condition on the observations, as described above. So we’ll express our update to the covariance matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma_1"> in terms of the Woodbury Matrix identity, which says that <img src="https://latex.codecogs.com/png.latex?(%5CSigma_1%20+%20%20U%5CSigma_%7B3,1%7DV)%5E%7B-1%7D%20=%20%5CSigma_1%5E%7B-1%7D%20-%20%5CSigma_1%5E%7B-1%7D%20U%20(%5CSigma_%7B3,1%7D%5E%7B-1%7D%20+%20V%5CSigma_1%5E%7B-1%7D%20U)%5E%7B-1%7DV%5CSigma_1%5E%7B-1%7D">. Let <img src="https://latex.codecogs.com/png.latex?%5CSigma_1%5E%7B-1%7D%20=%20%5CLambda">.</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1">Λ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3_1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(Σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3_1</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×3 Diagonal{Float64, Vector{Float64}}:
 1.0   ⋅     ⋅ 
  ⋅   1.0    ⋅ 
  ⋅    ⋅   50.0</code></pre>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_precision</span>(Λ)</span>
<span id="cb22-2">    Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (((Λ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3_1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Λ[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> V) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Λ)</span>
<span id="cb22-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>update_precision (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="putting-them-together" class="level1">
<h1>Putting them Together</h1>
<p>We want to update the distribution over possible locations <img src="https://latex.codecogs.com/png.latex?X"> after a single time-step. First, the movement of the robot is accounted for by the dynamics model. Then we condition on the observations of each obstacle <img src="https://latex.codecogs.com/png.latex?ys">.</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tupsum</span>(x,y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> y</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>tupsum (generic function with 1 method)</code></pre>
</div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>((μ,Λ), ys)</span>
<span id="cb26-2">    μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> dμ</span>
<span id="cb26-3">    Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_precision</span>(Λ)</span>
<span id="cb26-4">    msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(tupsum, (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_approx</span>(μ, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), y)</span>
<span id="cb26-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i, y) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(ys))))</span>
<span id="cb26-6">    (Λμ, Λ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> μ, Λ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> msg</span>
<span id="cb26-7">    (Λ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span> Λμ, Λ)</span>
<span id="cb26-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>step (generic function with 1 method)</code></pre>
</div>
</div>
<p>That’s it! We’ve written the algorithm for EKF-Slam. It remains to see how it performs on fake data.</p>
</section>
<section id="fake-data" class="level1">
<h1>Fake Data</h1>
<p>Here we generate the unknown, true trajectory that the robot takes by following our dynamics model.</p>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1">K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>100</code></pre>
</div>
</div>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1">true_x1s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repeat</span>(dμ_1, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(Σ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3_1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×100 Matrix{Float64}:
 0.0  2.11762   4.55484   5.13519   7.09133   …  93.3984   92.5634   93.3861
 0.0  3.32292   4.84397   5.95895   8.00179      80.1535   82.0442   83.7126
 0.0  0.242689  0.339492  0.622383  0.606434      8.75449   8.83309   8.99149</code></pre>
</div>
</div>
<p>We’ll also set up the true but unknown obstacle locations.</p>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1">true_x2s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, N)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×4 Matrix{Float64}:
 19.0432    9.47417  14.7808   1.49347
  6.61717  11.7026   39.9869  46.6605</code></pre>
</div>
</div>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb34-2">f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb34-3">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f)</span>
<span id="cb34-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_x1s[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_x1s[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"robot path"</span>)</span>
<span id="cb34-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scatter!</span>(true_x2s[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_x2s[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obstacles"</span>)</span>
<span id="cb34-6">f[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Legend</span>(f, ax)</span>
<span id="cb34-7">f</span>
<span id="cb34-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/kalman/kalman_files/figure-html/cell-19-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Imagine the displacement observations the robot sees along its trajectory look like this:</p>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1">intRootL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv</span>(L))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2×2 Matrix{Float64}:
 0.316228  0.0
 0.0       0.316228</code></pre>
</div>
</div>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1">ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RotMatrix</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">{2}</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (true_x2s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> x[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> intRootL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,N) for x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(true_x1s)]</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>100-element Vector{Matrix{Float64}}:
 [19.603741851669007 9.479204551258722 14.900654400589262 1.2139374388079114; 7.109167442992881 11.775011318681827 39.864880815432244 46.47732302265945]
 [17.428417732717854 9.186205752268958 21.58418858968195 10.302514798231858; -1.2775894214216188 6.503682945931601 32.4600792973359 42.1391721408444]
 [13.744198022456898 6.46742218871332 21.604198711877444 11.647194636830429; -3.0604680460453797 5.150291438464928 30.071311279180946 40.276065820668954]
 [11.719737913056772 6.320470356596162 27.311754677102762 21.15040031222601; -7.2877817184007 1.9961194947595295 22.015843280684727 34.7138674395836]
 [9.170647717903567 4.097154497685532 24.594517778984052 17.415084927101788; -8.168926103520667 1.3713381045796311 21.868856926106677 34.58207095408722]
 [6.851771008557176 2.8387315768003183 23.86519784545656 17.74815319262439; -7.620934369097298 1.8534328414257264 21.12961974465073 35.08617798718458]
 [1.398221192786282 1.2409843183837255 27.95514193245455 26.82854294580393; -10.086407748075187 0.018919119178708033 11.240493348899419 25.699635303326286]
 [0.3169655976859883 -0.39285744142372026 26.649019797009263 25.561068751895768; -10.536310387809673 0.30927290312356137 10.084782216747216 25.16572017266392]
 [2.0434381516062126 0.5639742214775894 25.912435608559953 23.022673246126974; -10.776295296075798 0.38883939303539855 13.127995130484802 27.676442341737296]
 [-2.3710757827037687 -3.2802287127408833 23.21854805575887 21.636363251553103; -8.429720638807137 1.7055137837804848 13.483351917616712 28.44462483387499]
 ⋮
 [-85.01537842242018 -82.61016689991195 -53.73990062912071 -51.62829545307723; 48.31044159300804 58.2521122905678 61.27458633125155 75.24876490536376]
 [-77.92158877538101 -74.16003378399459 -45.675320451009426 -40.54218710372369; 60.4334255290315 70.2293122899909 69.20913376130136 83.34947961682585]
 [-70.53372215169925 -64.68037466576178 -36.7496876006135 -29.96711191806724; 69.85817704833501 79.24606738372202 74.53101886911851 87.23432715129978]
 [-33.98099706546737 -25.03165642202575 -2.057248863963723 10.12979068910752; 95.52485097649517 101.22558541520517 84.60871367148738 94.33592881378806]
 [-12.043085472099799 -2.5026403638765027 16.615205968496387 30.48133220980331; 100.64644061904743 106.00976882843113 83.95087259794121 91.08771713790362]
 [25.338843399166226 35.91483691197125 46.137066300048794 61.1525044695857; 100.16309327986784 101.23885333657653 74.11040091177298 75.58909399184269]
 [11.989506064945864 23.753886929613135 36.95714374615932 51.39192149833056; 103.51764309193247 105.77665278482468 80.20229964834772 83.03976466509822]
 [18.689727331037783 29.57774053380095 41.464426214945114 55.489635695847284; 104.09395263404592 104.18947951304438 78.66245385208178 79.59735168397988]
 [34.58203052852036 45.39969886132603 53.65821015648627 67.58345887809908; 101.16246858622048 99.85185965577973 72.26982436583816 72.23512917823203]</code></pre>
</div>
</div>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb39-2">plt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>([y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] for y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ys], [y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] for y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ys])</span>
<span id="cb39-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N</span>
<span id="cb39-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>([y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,i] for y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ys], [y[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,i] for y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ys])</span>
<span id="cb39-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb39-6">plt</span>
<span id="cb39-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/kalman/kalman_files/figure-html/cell-22-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="simulating-the-algorithm" class="level1">
<h1>Simulating the Algorithm</h1>
<p>When we start tracking the robot, we know its location almost (making these precision terms super high), but we know nothing about the locations of the obstacles, so the rest of the precision terms should be low.</p>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1">Λ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vcat</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> N)))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>11×11 Diagonal{Float64, Vector{Float64}}:
 50.0    ⋅     ⋅    ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅ 
   ⋅   50.0    ⋅    ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅ 
   ⋅     ⋅   50.0   ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅ 
   ⋅     ⋅     ⋅   0.02   ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅ 
   ⋅     ⋅     ⋅    ⋅    0.02   ⋅     ⋅     ⋅     ⋅     ⋅     ⋅ 
   ⋅     ⋅     ⋅    ⋅     ⋅    0.02   ⋅     ⋅     ⋅     ⋅     ⋅ 
   ⋅     ⋅     ⋅    ⋅     ⋅     ⋅    0.02   ⋅     ⋅     ⋅     ⋅ 
   ⋅     ⋅     ⋅    ⋅     ⋅     ⋅     ⋅    0.02   ⋅     ⋅     ⋅ 
   ⋅     ⋅     ⋅    ⋅     ⋅     ⋅     ⋅     ⋅    0.02   ⋅     ⋅ 
   ⋅     ⋅     ⋅    ⋅     ⋅     ⋅     ⋅     ⋅     ⋅    0.02   ⋅ 
   ⋅     ⋅     ⋅    ⋅     ⋅     ⋅     ⋅     ⋅     ⋅     ⋅    0.02</code></pre>
</div>
</div>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1">start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> N), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Matrix</span>(Λ<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [50.0 0.0 … 0.0 0.0; 0.0 50.0 … 0.0 0.0; … ; 0.0 0.0 … 0.02 0.0; 0.0 0.0 … 0.0 0.02])</code></pre>
</div>
</div>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1">progress <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VectorOfArray</span>([p[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] for p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">accumulate</span>(step, ys; init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start)])</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>VectorOfArray{Float64,2}:
100-element Vector{Vector{Float64}}:
 [0.19603470614227045, -1.1019964687272161]
 [2.889909146537032, 2.0345416147280435]
 [5.4465674824236805, 3.490024263516243]
 [5.834140865479254, 5.621543266706627]
 [6.867610338133039, 7.345006193785757]
 [8.771160897989832, 7.684325652555491]
 [9.671871792436933, 10.576968282019857]
 [9.719187902983348, 11.137261142975037]
 [9.495176663250813, 10.67180669193075]
 [12.693960332347404, 12.717406136495278]
 ⋮
 [82.59429723485445, 80.39396991410229]
 [83.94394349825295, 80.6031184162581]
 [83.6086549631126, 81.54608657915432]
 [80.03442589307521, 78.98054759382246]
 [85.88962193557168, 81.58140447738558]
 [84.69253231070572, 81.38863317696293]
 [86.65021564031672, 83.97002446611756]
 [87.02483988117402, 87.00435824964622]
 [87.93827854608371, 87.48235512496616]</code></pre>
</div>
</div>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb46-2">f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Figure</span>()</span>
<span id="cb46-3">ax2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f2[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Axis</span>(f2)</span>
<span id="cb46-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(true_x1s[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], true_x1s[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true robot trajectory"</span>)</span>
<span id="cb46-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(progress[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], progress[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inferred robot trajectory"</span>)</span>
<span id="cb46-6">f2[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Legend</span>(f2, ax2)</span>
<span id="cb46-7">f2</span>
<span id="cb46-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/kalman/kalman_files/figure-html/cell-26-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, although the robot’s trajectory did not follow our dynamics model exactly thanks to the added noise at each step, conditioning on the observations allowed us to keep track of its approximate position regardless.</p>


</section>

 ]]></description>
  <category>SLAM</category>
  <guid>https://samanklesaria.github.io/posts/kalman/kalman.html</guid>
  <pubDate>Mon, 02 Oct 2023 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Conjugate Computation</title>
  <link>https://samanklesaria.github.io/posts/conjugate_computation/Conjugate-Computation.html</link>
  <description><![CDATA[ 





<p>This post is about a technique that allows us to use variational message passing on models where the likelihood doesn’t have a conjugate prior. There will be a lot of Jax code snippets to make everything as concrete as possible.</p>
<section id="the-math" class="level2">
<h2 class="anchored" data-anchor-id="the-math">The Math</h2>
<p>Say <img src="https://latex.codecogs.com/png.latex?X"> comes from a distribution with density <img src="https://latex.codecogs.com/png.latex?q(X;%5Ctheta)">, and we want to find <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> to maximize <img src="https://latex.codecogs.com/png.latex?E%5Bg(X)%5D">. While in gradient descent we let <img src="https://latex.codecogs.com/png.latex?%5Ctheta_%7Bt+1%7D=%5Ctheta_t%20+%20%5Calpha%20%5Cnabla_%5Ctheta%20E%5Bg(X)%5D">, the <em>natural gradient</em> update is <img src="https://latex.codecogs.com/png.latex?%5Ctheta_%7Bt+1%7D=%5Ctheta_t%20+%20%5Calpha%20F%5E%7B-1%7D%5Cnabla_%5Ctheta%20E%5Bg(X)%5D">, where <img src="https://latex.codecogs.com/png.latex?F"> is the <em>Fisher Information Matrix</em>. When <img src="https://latex.codecogs.com/png.latex?q"> is the density for an exponential family (which is the only form of <img src="https://latex.codecogs.com/png.latex?q"> I will consider here), <img src="https://latex.codecogs.com/png.latex?F"> is the Hessian of the log normalizer <img src="https://latex.codecogs.com/png.latex?A(%5Ctheta)">.</p>
<p>Variational inference seeks a <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> that maximizes the ELBO <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D%20=%20f(%5Ctheta)%20+%20E_%7Bq_%5Ctheta%7D%5B%5Clog%20p(X)%20-%20%5Clog%20q(X)%5D"> where the expected likelihood <img src="https://latex.codecogs.com/png.latex?f(%5Ctheta)%20=%20E_%7Bq_%5Ctheta%7D%20%5Clog%20p(y%20%5Cvert%20%20X)">. When <img src="https://latex.codecogs.com/png.latex?p"> and <img src="https://latex.codecogs.com/png.latex?q"> come from an exponential family with statistic <img src="https://latex.codecogs.com/png.latex?T(X)"> and natural parameters <img src="https://latex.codecogs.com/png.latex?%5Ceta"> and <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> respectively, taking the gradient of the ELBO gives</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cnabla_%5Ctheta%20L%20&amp;=%20%5Cnabla_%5Ctheta%20f%20+%20%5Cnabla_%5Ctheta%20%5Clangle%20E%5BT(X)%5D,%20%5Ceta%20-%20%5Ctheta%20%5Crangle%20+%20%5Cnabla_%7B%5Ctheta%7D%20A(%5Ctheta)%20%5C%5C%0A&amp;=%20%5Cnabla_%5Ctheta%20f%20+%20%5Cnabla_%5Ctheta%20%5Clangle%20%5Cnabla%20A(%5Ctheta),%20%5Ceta%20-%20%5Ctheta%20%5Crangle%20+%20%5Cnabla_%7B%5Ctheta%7D%20A(%5Ctheta)%20%5C%5C%0A&amp;=%20%5Cnabla_%5Ctheta%20f%20+%20%5Cnabla_%5Ctheta%5E2A(%5Ctheta)(%5Ceta%20-%20%5Ctheta)%20%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<p>This means that the natural gradient is <img src="https://latex.codecogs.com/png.latex?F%5E%7B-1%7D%20%5Cnabla_%5Ctheta%20f%20+%20(%5Ceta%20-%20%5Ctheta)">.</p>
<p>When the likelihood is conjugate to the prior, <img src="https://latex.codecogs.com/png.latex?%5Clog%20p(y%5Cvert%20x)"> can be written as <img src="https://latex.codecogs.com/png.latex?%5Clangle%20T(X),%20%5Cphi(y)%20%5Crangle%20+%20c">, where <img src="https://latex.codecogs.com/png.latex?c"> does not depend on <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?%5Cphi"> is a transformation of the observations. This means that <img src="https://latex.codecogs.com/png.latex?%5Clog%20p(y%5Cvert%20x)%20+%20%5Clog%20p(x)%20=%20%5Clangle%20T(x),%20%5Cphi(y)%20+%20%5Ceta%20%5Crangle%20+%20c">. Taking the gradient as above, we get <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cnabla_%5Ctheta%20L%20&amp;=%20%5Cnabla_%5Ctheta%20%5Clangle%20E%5BT(X)%5D,%20%5Cphi(y)%20+%20%5Ceta%20-%20%5Ctheta%20%5Crangle%20+%20%5Cnabla_%7B%5Ctheta%7D%20A(%5Ctheta)%20%5C%5C%0A&amp;=%20%5Cnabla_%5Ctheta%5E2A(%5Ctheta)(%5Cphi(y)%20+%20%5Ceta%20-%20%5Ctheta)%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>This means that the natural gradient is <img src="https://latex.codecogs.com/png.latex?%5Cphi(y)%20+%20%5Ceta%20-%20%5Ctheta">; a unit length step along the natural gradient recovers the conjugate update.</p>
<p>When <img src="https://latex.codecogs.com/png.latex?q"> factors as <img src="https://latex.codecogs.com/png.latex?q(X_1;%20%5Ctheta_1)q(X_2;%20%5Ctheta_2)"> and non-leaf children in <img src="https://latex.codecogs.com/png.latex?p"> are always conjugate to their parents, we can update each component separately. Say <img src="https://latex.codecogs.com/png.latex?f"> is a function of <img src="https://latex.codecogs.com/png.latex?X_1"> alone, <img src="https://latex.codecogs.com/png.latex?%5Ceta_1"> is a function of <img src="https://latex.codecogs.com/png.latex?X_2">, and <img src="https://latex.codecogs.com/png.latex?%5Ceta_2"> is a constant. The gradient of the ELBO with respect to <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1"> becomes <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cnabla_%7B%5Ctheta_1%7D%20L%20&amp;=%20%5Cnabla_%7B%5Ctheta_1%7D%20f%20+%20%5Cnabla_%7B%5Ctheta_1%7D%20%5Clangle%20E%5BT(X_1)%5D,%20E%5B%5Ceta_1(X_2)%5D%20-%20%5Ctheta_1%20%5Crangle%20+%20%5Cnabla_%7B%5Ctheta_1%7D%20A(%5Ctheta_1)%20%5C%5C%0A&amp;=%20%5Cnabla_%7B%5Ctheta_1%7D%20f%20+%20%5Cnabla_%7B%5Ctheta_1%7D%5E2A(%5Ctheta_1)(%20E%5B%5Ceta_1(X_2)%5D%20-%20%5Ctheta_1)%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Similarly, the gradient for <img src="https://latex.codecogs.com/png.latex?%5Ctheta_2"> is $ _{_2}^2A(_2)(E[(X_1)] + _2 - _2)$. This coordinate-wise natural gradient update is called “variational message passing”.</p>
<p>We can find <img src="https://latex.codecogs.com/png.latex?F%5E%7B-1%7D%20%5Cnabla_%5Ctheta%20f"> by using the “conjugate computation” trick. Let <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Ctheta%7D"> be the expected-statistic parameterization corresponding to natural parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. Observe that, by the chain rule:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Ctheta%7D%20=%20%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Chat%7B%5Ctheta%7D%7D%5Cfrac%7B%5Cpartial%20%5Chat%7B%5Ctheta%7D%7D%7B%5Cpartial%20%5Ctheta%7D"></p>
<p>As <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Ctheta%7D%20=%20%5Cnabla_%5Ctheta%20A(%5Ctheta)">, this simiplies to <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Ctheta%7D%20=%20%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Chat%7B%5Ctheta%7D%7D%20%5Cnabla_%5Ctheta%5E2%20A(%5Ctheta)%20"> So <img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_%5Ctheta%5E%7B-2%7D%20A(%5Ctheta)%20%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Ctheta%7D%20=%20%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Chat%7B%5Ctheta%7D%7D%20"> That is, the natural gradient with respect to the natural parameterization is just the ordinary gradient with respect to the mean parameterization.</p>
</section>
<section id="the-code" class="level2">
<h2 class="anchored" data-anchor-id="the-code">The Code</h2>
<p>To see how this works in practice, consider doing variational inference for a hierarchical latent Gaussian mixture model. Let our observations <img src="https://latex.codecogs.com/png.latex?y_i"> have log density <img src="https://latex.codecogs.com/png.latex?f(y_i;%20%5Cmu_%7Bc_i%7D)"> where <img src="https://latex.codecogs.com/png.latex?f"> is some complicated function like a neural net and <img src="https://latex.codecogs.com/png.latex?c_i"> is the known mixture component responsible for <img src="https://latex.codecogs.com/png.latex?z_i">. The <img src="https://latex.codecogs.com/png.latex?%5Cmu_j%20%5Csim%20%5Cmathcal%7BN%7D(m_%7Bd_j%7D,%20%5Ctau_2)">, where <img src="https://latex.codecogs.com/png.latex?d_j"> is the known mixture component responsible for <img src="https://latex.codecogs.com/png.latex?%5Cmu_j">, and <img src="https://latex.codecogs.com/png.latex?m_k%20%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Ctau_3)">. In our variational approximation, we will assume the <img src="https://latex.codecogs.com/png.latex?%5Cmu_j"> and <img src="https://latex.codecogs.com/png.latex?m_k"> are all independently Gaussian distributed with natural parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> and <img src="https://latex.codecogs.com/png.latex?%5Ctheta_k"> respectively. Then the natural gradient update for <img src="https://latex.codecogs.com/png.latex?%5Cmu_j"> is <img src="https://latex.codecogs.com/png.latex?F%5E%7B-1%7D%20%5Cnabla_%7B%5Ctheta_j%7D%20f%20+%20%5Cbegin%7Bbmatrix%7D%20%5Ctau_2%20m_%7Bd_j%7D%20%5C%5C%20-%5Ctau_2/2%20%5Cend%7Bbmatrix%7D%20-%20%5Ctheta_j"> The update for <img src="https://latex.codecogs.com/png.latex?m_k"> is <img src="https://latex.codecogs.com/png.latex?%5Csum_j%20%5Cbegin%7Bbmatrix%7D%20%5Ctau_2%20E%5B%5Cmu_j%5D%20%5C%5C%20-%5Ctau_2/2%20%5Cend%7Bbmatrix%7D%20+%20%5Cbegin%7Bbmatrix%7D%200%20%5C%5C%20-%5Ctau_3/2%20%5Cend%7Bbmatrix%7D%20-%20%5Ctheta_k"></p>
<p>If the number of observations <img src="https://latex.codecogs.com/png.latex?N"> is large, it may be hard to find <img src="https://latex.codecogs.com/png.latex?%5Cnabla_%7B%5Ctheta_j%7D%20f%20=%20%5Csum_i%5EN%20%5Clog%20p(y_i%20%5Cvert%20%20%5Cmu_%7Bc_i%7D)"> exactly. In this case, we can take a Monte Carlo estimate <img src="https://latex.codecogs.com/png.latex?N%20%5Cnabla_%7B%5Ctheta_j%7D%20E_%7Bi%20%5Cin%20%5BN%5D%7D%20%5Clog%20p(y_i%20%5Cvert%20%20%5Cmu_%7Bc_i%7D)">. Alternately, we can divide the learning rate by <img src="https://latex.codecogs.com/png.latex?N">, so that the natural gradient is <img src="https://latex.codecogs.com/png.latex?%0AF%5E%7B-1%7D_i%20%5Cnabla_%7B%5Ctheta_i%7D%20%5Clog%20p(y_i%20%5Cvert%20%20%5Cmu_%7Bc_i%7D)%20+%20%5Cfrac%7B1%7D%7BN%7D%20%5Cleft(%20%5Cbegin%7Bbmatrix%7D%20%5Ctau_2%20m_%7Bd_j%7D%20%5C%5C%20-%5Ctau_2/2%20%5Cend%7Bbmatrix%7D%20-%20%5Ctheta_j%20%5Cright)%0A"> The same goes for the sums involved in the variational message passing updates.</p>
<p>In Jax, we’ll represent our posterior distributions in vectorized form; each <code>Normal</code> will actually represent a plate of <img src="https://latex.codecogs.com/png.latex?n"> normal distributions. Plates of distributions will have methods for their means and natural gradient updates.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> NamedTuple</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jaxtyping <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Array, Float, Int</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax, jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp, jax.random <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jr, jax.tree_util <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jt, jax.nn</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt, numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> einops <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> repeat</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> equinox <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> eqx, equinox.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn, optax, diffrax <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dfx</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ft</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Normal(NamedTuple):</span>
<span id="cb2-2">    nat_params: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n ... 2"</span>]</span>
<span id="cb2-3">    n_obs: Int[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>]</span>
<span id="cb2-4">    lr: jnp.float32</span>
<span id="cb2-5">    prior_mean: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution"</span></span>
<span id="cb2-6">    prior_prec: jnp.float32</span>
<span id="cb2-7">    parent_ixs: Int[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>]</span>
<span id="cb2-8"></span>
<span id="cb2-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mean(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ix):</span>
<span id="cb2-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nat_params[ix, ..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nat_params[ix, ..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-11"></span>
<span id="cb2-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mean_params(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ix):</span>
<span id="cb2-13">        prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nat_params[ix, ..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-14">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mean(ix)</span>
<span id="cb2-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> jnp.stack((mu, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> prec) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> jnp.square(mu)), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-16"></span>
<span id="cb2-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, df, ix):</span>
<span id="cb2-18">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.prior_mean.mean(ix)</span>
<span id="cb2-19">        ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones(mu.shape)</span>
<span id="cb2-20">        prior_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.stack((<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.prior_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mu,</span>
<span id="cb2-21">                               <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.prior_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-22">        onestr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1 "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:])</span>
<span id="cb2-23">        n_obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> repeat(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_obs, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n -&gt; n "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> onestr)</span>
<span id="cb2-24">        nat_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (prior_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nat_params[ix]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n_obs[ix]</span>
<span id="cb2-25">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._replace(nat_params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nat_params.at[ix].add(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nat_grad))</span>
<span id="cb2-26">        parent_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.stack((<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.prior_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mean(ix), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.prior_prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-27">        prior_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.prior_mean.update(parent_df, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.parent_ixs[ix])</span>
<span id="cb2-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._replace(prior_mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prior_mean)</span></code></pre></div></div>
<p>We’ll make a helper function to initialize one of these variational posterior plates given a plate of prior distributions.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> normal(mean_dist, prec, n_obs, parent_ixs, lr, key):</span>
<span id="cb3-2">    mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mean_dist.mean(parent_ixs)</span>
<span id="cb3-3">    post_mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> jnp.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prec) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key, mean.shape)</span>
<span id="cb3-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> Normal(normal_nats(post_mu, prec), n_obs, lr, mean_dist, prec, parent_ixs)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> normal_nats(mu, prec):</span>
<span id="cb4-2">    ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones(mu.shape)</span>
<span id="cb4-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> jnp.stack([prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mu, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prec <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ones], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div></div>
<p>The prior mean for <img src="https://latex.codecogs.com/png.latex?m_k"> is a delta distribution, so we’ll need a representation of this as well.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Delta(NamedTuple):</span>
<span id="cb5-2">    val: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>]</span>
<span id="cb5-3"></span>
<span id="cb5-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mean(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ix):</span>
<span id="cb5-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> repeat(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.val, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'... -&gt; i ...'</span>, i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ix.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb5-6"></span>
<span id="cb5-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, df, ix):</span>
<span id="cb5-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">colon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">slice</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span></code></pre></div></div>
</section>
<section id="example-simple-nonlinearity" class="level2">
<h2 class="anchored" data-anchor-id="example-simple-nonlinearity">Example: Simple Nonlinearity</h2>
<p>Let the expected likelihood <img src="https://latex.codecogs.com/png.latex?f"> be a monte carlo estimate of a normal distribution around a transformation of <img src="https://latex.codecogs.com/png.latex?z"> with precision <img src="https://latex.codecogs.com/png.latex?%5Ctau_1">. We’ll have two <img src="https://latex.codecogs.com/png.latex?m">s, two <img src="https://latex.codecogs.com/png.latex?%5Cmu">s for each <img src="https://latex.codecogs.com/png.latex?m">, and 20 <img src="https://latex.codecogs.com/png.latex?z">s for each <img src="https://latex.codecogs.com/png.latex?%5Cmu">.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">TAU3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb7-2">TAU2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-3">TAU1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, key):</span>
<span id="cb8-2">    key, key2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-3">    m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> normal(Delta(jnp.float32(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)), jnp.float32(TAU3), n_obs_ms,</span>
<span id="cb8-4">        jnp.zeros(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(n_obs_mus), jnp.int32), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, key)</span>
<span id="cb8-5">    mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> normal(m, jnp.float32(TAU2),</span>
<span id="cb8-6">        n_obs_mus, mu_parents, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, key2)</span>
<span id="cb8-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mu</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">data_key, post_key, obs_key, key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(jr.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb9-2">n_obs_ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.full(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, jnp.int32)</span>
<span id="cb9-3">n_obs_mus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.full(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, jnp.int32)</span>
<span id="cb9-4">mu_parents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> repeat(jnp.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a -&gt; (a b)'</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-5">true_mu_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, data_key)</span>
<span id="cb9-6">true_z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> true_mu_dist.mean(colon)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> jnp.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> TAU1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(obs_key, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))</span>
<span id="cb9-7">true_z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ravel(true_z)</span>
<span id="cb9-8">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, post_key)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">init_mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, post_key)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">plt.hist(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(jnp.reshape(true_z, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))), stacked<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-2">plt.legend(labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>We’ll keep the nonlinear log likelihood simple for now:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> trans_val(z):</span>
<span id="cb12-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> jnp.square(z)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@jax.value_and_grad</span></span>
<span id="cb13-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(moments, y, key):</span>
<span id="cb13-3">    key, key2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb13-4">    std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sqrt(moments[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> jnp.square(moments[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))</span>
<span id="cb13-5">    mu_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> moments[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key, std.shape)</span>
<span id="cb13-6">    noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> TAU1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key2, std.shape)</span>
<span id="cb13-7">    z_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise</span>
<span id="cb13-8">    obs_lik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(jnp.square(y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> trans_val(z_sample)))</span>
<span id="cb13-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> obs_lik</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trans_val(true_z)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">plt.hist(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(jnp.reshape(y, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))), stacked<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>Although it’s unnecessary for this toy example, we’ll process the observations in batches to demonstrate how to handle a big-data setting.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">orig_ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> repeat(jnp.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a -&gt; (a b)'</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">permkey, key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb17-2">ixs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.reshape(jr.permutation(permkey, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@jax.jit</span></span>
<span id="cb18-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> step(mu, y, noise_key, ix):</span>
<span id="cb18-3">    keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(noise_key, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ix))</span>
<span id="cb18-4">    oix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> orig_ixs[ix]</span>
<span id="cb18-5">    logprob, ng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.vmap(f)(mu.mean_params(oix), y[ix], keys)</span>
<span id="cb18-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>jnp.mean(logprob), mu.update(ng, oix)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> epoch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb19-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ix <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ixs:</span>
<span id="cb19-3">        noise_key, key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb19-4">        loss, mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step(mu, y, noise_key, ix)</span>
<span id="cb19-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb19-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss"</span>, loss)</span></code></pre></div></div>
<pre><code>Loss 100.12155
Loss 23.347706
Loss 15.448761
Loss 9.154531
Loss 6.0349517
Loss 8.66155
Loss 6.0191417
Loss 6.167668
Loss 3.9419441
Loss 4.059013</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">true_mu_dist.mean(colon)</span></code></pre></div></div>
<pre><code>Array([ 0.93337744, -0.959161  , -2.7729065 , -2.4498918 ], dtype=float32)</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">mu.mean(colon)</span></code></pre></div></div>
<pre><code>Array([-1.8313473, -1.6707655,  2.7105517,  2.4046152], dtype=float32)</code></pre>
<p>Inference got pretty close to the true values (up to sign, which isn’t identifiable here). Compare this to where we started:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">init_mu.mean(colon)</span></code></pre></div></div>
<pre><code>Array([-7.319654  , -6.7709327 ,  1.2107476 ,  0.45153332], dtype=float32)</code></pre>
</section>
<section id="example-simple-neural-nonlinearity" class="level2">
<h2 class="anchored" data-anchor-id="example-simple-neural-nonlinearity">Example: Simple Neural Nonlinearity</h2>
<p>For a slightly more sophisticated example, let’s try to generate some related sin-curves from noise. Our linlinearity will come from a neural net.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">jax.clear_caches()</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">RES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, RES)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">post_key, net_key, data_key, key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(jr.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">w_base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.15</span>])[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]</span>
<span id="cb31-2">w_resid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>])[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb31-3">w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> w_base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> w_base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w_resid</span>
<span id="cb31-4">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sin(inputs[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (w[...,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (jr.normal(data_key, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))[...,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])))</span>
<span id="cb31-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.reshape(y, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ix, yi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(jnp.reshape(y, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>))):</span>
<span id="cb32-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> yj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> yi:</span>
<span id="cb32-3">        plt.plot(inputs, yj, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ix, yi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(jnp.reshape(y, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>))):</span>
<span id="cb33-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> yj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> yi:</span>
<span id="cb33-3">        plt.plot(inputs, yj, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, key):</span>
<span id="cb34-2">    key, key2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb34-3">    m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> normal(Delta(jnp.zeros(RES)), jnp.float32(TAU3), n_obs_ms,</span>
<span id="cb34-4">        jnp.zeros(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(n_obs_mus), jnp.int32), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, key)</span>
<span id="cb34-5">    mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> normal(m, jnp.float32(TAU2),</span>
<span id="cb34-6">        n_obs_mus, mu_parents, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, key2)</span>
<span id="cb34-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mu</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@ft.partial</span>(eqx.filter_vmap, in_axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb35-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@eqx.filter_value_and_grad</span></span>
<span id="cb35-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(args, y, key):</span>
<span id="cb35-4">    moments, net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args</span>
<span id="cb35-5">    key, key2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb35-6">    std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sqrt(moments[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> jnp.square(moments[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))</span>
<span id="cb35-7">    mu_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> moments[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key, std.shape)</span>
<span id="cb35-8">    noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> TAU1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key2, std.shape)</span>
<span id="cb35-9">    z_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise</span>
<span id="cb35-10">    obs_lik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(jnp.square(y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> net(z_sample)))</span>
<span id="cb35-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>obs_lik</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@eqx.filter_jit</span></span>
<span id="cb36-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> step(mu, net, y, noise_key, ix, opt_state, opt_update):</span>
<span id="cb36-3">    keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(noise_key, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ix))</span>
<span id="cb36-4">    oix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> orig_ixs[ix]</span>
<span id="cb36-5">    params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu.mean_params(oix)</span>
<span id="cb36-6">    neg_logprob, grads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f((params, net), y[ix], keys)</span>
<span id="cb36-7">    ng, net_grads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grads</span>
<span id="cb36-8">    net_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jt.tree_map(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> g: jnp.mean(g, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), net_grads)</span>
<span id="cb36-9">    updates, opt_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> opt_update(net_grad, opt_state)</span>
<span id="cb36-10">    net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eqx.apply_updates(net, updates)</span>
<span id="cb36-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> jnp.mean(neg_logprob), mu.update(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ng, oix), net, opt_state</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, post_key)</span>
<span id="cb37-2">net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.MLP(RES, RES, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>jax.nn.swish, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>net_key)</span>
<span id="cb37-3">lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span></span>
<span id="cb37-4">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> optax.adabelief(learning_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span>
<span id="cb37-5">opt_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> opt.init(eqx.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(net, eqx.is_inexact_array))</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> epoch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>):</span>
<span id="cb38-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ix <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ixs:</span>
<span id="cb38-3">        noise_key, key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb38-4">        loss, mu, net, opt_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step(mu, net, y, noise_key, ix, opt_state, opt.update)</span>
<span id="cb38-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb38-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss"</span>, loss)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu.mean(colon)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> params:</span>
<span id="cb40-2">    plt.plot(inputs, net(p))</span></code></pre></div></div>
<p>The distances between <img src="https://latex.codecogs.com/png.latex?%5Cmu"> values correspond to what we’d assume given the prior.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">plt.imshow(jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(jnp.square(params[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> params[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb41-2">plt.colorbar()</span></code></pre></div></div>
</section>
<section id="example-diffusion-nonlinearity" class="level2">
<h2 class="anchored" data-anchor-id="example-diffusion-nonlinearity">Example: Diffusion Nonlinearity</h2>
<p>We can try to accomplish the same task using a ODE-based model. We learn a neural network describing a vector field. Integrating along this vector field maps from our latent space to the space of observations.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">jax.clear_caches()</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@ft.partial</span>(eqx.filter_vmap, in_axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb43-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@eqx.filter_value_and_grad</span></span>
<span id="cb43-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f(args, y, key):</span>
<span id="cb43-4">    moments, net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args</span>
<span id="cb43-5">    key, key2, key3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb43-6">    std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sqrt(moments[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> jnp.square(moments[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))</span>
<span id="cb43-7">    mu_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> moments[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key, std.shape)</span>
<span id="cb43-8">    noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> TAU1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jr.normal(key2, std.shape)</span>
<span id="cb43-9">    z_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise</span>
<span id="cb43-10">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.uniform(key3)</span>
<span id="cb43-11">    pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z_sample</span>
<span id="cb43-12">    target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> z_sample</span>
<span id="cb43-13">    obs_lik <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(jnp.square(target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> net(t, pos)))</span>
<span id="cb43-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>obs_lik</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Net(eqx.Module):</span>
<span id="cb44-2">    net: nn.MLP</span>
<span id="cb44-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, key):</span>
<span id="cb44-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb44-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.MLP(RES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, RES, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>jax.nn.swish, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key)</span>
<span id="cb44-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, t, y, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args):</span>
<span id="cb44-7">        t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> repeat(t, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-&gt; 1"</span>)</span>
<span id="cb44-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.net(jnp.concatenate([y, t]))</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_posteriors(n_obs_ms, n_obs_mus, mu_parents, post_key)</span>
<span id="cb45-2">lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span></span>
<span id="cb45-3">net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Net(net_key)</span>
<span id="cb45-4">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> optax.adabelief(learning_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span>
<span id="cb45-5">opt_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> opt.init(eqx.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(net, eqx.is_inexact_array))</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">losses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb46-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> epoch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>):</span>
<span id="cb46-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ix <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ixs:</span>
<span id="cb46-4">        noise_key, key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jr.split(key, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb46-5">        loss, mu, net, opt_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step(mu, net, y, noise_key, ix, opt_state, opt.update)</span>
<span id="cb46-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb46-7">        losses.append(loss)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">plt.plot(losses)</span>
<span id="cb47-2">plt.yscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu.mean(colon)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@ft.partial</span>(jax.vmap, in_axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb49-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forwardflow(net, z):</span>
<span id="cb49-3">    term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dfx.ODETerm(net)</span>
<span id="cb49-4">    solver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dfx.ReversibleHeun()</span>
<span id="cb49-5">    sol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dfx.diffeqsolve(term, solver, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, z)</span>
<span id="cb49-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sol.ys[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forwardflow(net, params)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results:</span>
<span id="cb51-2">    plt.plot(inputs, p)</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">plt.imshow(jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(jnp.square(params[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> params[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb52-2">plt.colorbar()</span></code></pre></div></div>
<p>One of the nice things about ODE models is that we can use them for prediction as well as generation.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@ft.partial</span>(jax.vmap, in_axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb53-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> backflow(net, x):</span>
<span id="cb53-3">    term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dfx.ODETerm(net)</span>
<span id="cb53-4">    solver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dfx.ReversibleHeun()</span>
<span id="cb53-5">    sol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dfx.diffeqsolve(term, solver, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, x)</span>
<span id="cb53-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sol.ys[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div></div>
<p>We’ll take one sample from each class.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">ry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.reshape(y, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>))</span>
<span id="cb54-2">topy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ry[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:]</span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> yi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> topy:</span>
<span id="cb55-2">    plt.plot(inputs, yi)</span></code></pre></div></div>
<p>We can integrate backwards through time to get the latent code associated with each sample.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">zs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> backflow(net, topy)</span></code></pre></div></div>
<p>The latent codes are well separated in Euclidean space.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1">plt.imshow(jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(jnp.square(zs[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> params[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb57-2">plt.colorbar()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>We can visualize the embeddings with PCA.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpy.linalg <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> eig</span>
<span id="cb58-2">pmu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.mean(params, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb58-3">Xbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> pmu[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,:]</span>
<span id="cb58-4">S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xbar.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Xbar</span>
<span id="cb58-5">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eig(S)</span>
<span id="cb58-6">proj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][:, :<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb58-7">plt.scatter(proj[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], proj[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb58-8">plt.scatter(proj[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], proj[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>


</section>

 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/conjugate_computation/Conjugate-Computation.html</guid>
  <pubDate>Wed, 16 Aug 2023 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Generative ODE Models are VAEs</title>
  <link>https://samanklesaria.github.io/posts/Diffusion-is-a-fancy-VAE.html</link>
  <description><![CDATA[ 





<p>Generative image models based on ordinary differential equations can be seen as forms of variational auto-encoders with a partially deterministic inference network. <img src="https://latex.codecogs.com/png.latex?%5Cnewcommand%7B%5Ccoloneqq%7D%7B%5Cmathrel%7B%5Cvcenter%7B:%7D%7D=%7D"></p>
<section id="variational-auto-encoders" class="level1">
<h1>Variational Auto-encoders</h1>
<p>Given a dataset of samples <img src="https://latex.codecogs.com/png.latex?y"> from an unknown distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi_1">, generative models attempt to find parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> for a fixed family that maximizes the likelihood <img src="https://latex.codecogs.com/png.latex?p_%5Ctheta(y)">. When the family implicitly marginalizes over a latent variable <img src="https://latex.codecogs.com/png.latex?z"> so that <img src="https://latex.codecogs.com/png.latex?%5Clog%20p_%5Ctheta(y)%20=%20%5Clog%20E_%7Bz%20%5Csim%20p%7D%20p_%5Ctheta(y%20%5Cvert%20%20z)">, maximum likelihood estimation becomes intractable in general. Variational auto-encoders address this problem by maximizing a lower bound on the likelihood: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Clog%20p_%5Ctheta(y)%20&amp;=%20%5Clog%20E_%7Bz%20%5Csim%20p%7D%20p_%5Ctheta(y%20%5Cvert%20%20z)%20%5C%5C%0A&amp;=%5Clog%20E_%7Bq(z%20%5Cvert%20%20y)%7D%20%5Cfrac%7Bp(y%5Cvert%20z)%20p(z)%7D%7Bq(z%5Cvert%20y)%7D%20&amp;%5Ctext%7B%20(importance%20sampling)%7D%5C%5C%0A&amp;%20%5Cgeq%20E_%7Bq(z%20%5Cvert%20%20y)%7D%20%5Clog%20%5Cfrac%7Bp(y%5Cvert%20z)%20p(z)%7D%7Bq(z)%7D%20&amp;%5Ctext%7B%20(Jensen's%20inequality)%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>This quantity <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D%20%5Ccoloneqq%20E_%7Bq(z%20%5Cvert%20%20y)%7D%20%5Clog%20p(y,z)%20-%20%5Clog%20q(z)"> is known as the <em>evidence lower bound</em> or ELBO. The distribution <img src="https://latex.codecogs.com/png.latex?q(z%5Cvert%20y)"> used for importance sampling is usually parameterized by a neural net and is known as the <em>inference network</em>. In what follows, we will implicitly assume that <img src="https://latex.codecogs.com/png.latex?q"> is a function of neural net parameters <img src="https://latex.codecogs.com/png.latex?%5Cphi">.</p>
</section>
<section id="from-variational-auto-encoders-to-rectified-flows" class="level1">
<h1>From Variational Auto-encoders to Rectified Flows</h1>
<p>Assume that the model’s prior over <img src="https://latex.codecogs.com/png.latex?z"> factors as <img src="https://latex.codecogs.com/png.latex?p(z)%20=%20p(z_0)%5Cprod_t%20p(z_%7Bt+%5CDelta%7D%20%5Cvert%20%20z_t)">, where <img src="https://latex.codecogs.com/png.latex?t"> ranges from <img src="https://latex.codecogs.com/png.latex?0"> to <img src="https://latex.codecogs.com/png.latex?1"> in increments of <img src="https://latex.codecogs.com/png.latex?%5CDelta"> and <img src="https://latex.codecogs.com/png.latex?z_1"> is observed (taking the place of <img src="https://latex.codecogs.com/png.latex?y"> in the discussion so far). Instead of fixing the model <img src="https://latex.codecogs.com/png.latex?p"> and learning parameters for a distribution <img src="https://latex.codecogs.com/png.latex?q"> to approximate its posterior, with diffusion-based approaches, we do the opposite.. Fix the posterior approximation <img src="https://latex.codecogs.com/png.latex?q(z_t%20%5Cvert%20%20z_1,%20z_0)"> to be a Delta distribution at <img src="https://latex.codecogs.com/png.latex?tz_1%20+%20(1%20-%20t)z_0"> (linearly interpolating between observations). Let <img src="https://latex.codecogs.com/png.latex?p(z_%7Bt+%5CDelta%7D%20%5Cvert%20%20z_t)"> be distributed as <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BN%7D(z_t%20+%20%5CDelta%20f_%5Ctheta(z_t,%20t),%20%5Csigma%5E2/%5CDelta%5E2)">, where <img src="https://latex.codecogs.com/png.latex?f_%5Ctheta"> is a neural network parameterized by <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. Under this linear interpolation scheme, <img src="https://latex.codecogs.com/png.latex?z_%7Bt%20+%20%5CDelta%7D%20-%20z_t%20=%20%5CDelta%20(z_1%20-%20z_0)">. This means that <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%20%20%20%20&amp;E%5Cleft%5B%5Clog%20p((z_%7Bt+%5CDelta%7D%20%5Cvert%20%20z_t)%5Cright%5D%20%5C%5C%0A%20%20%20%20&amp;=%20E%5Cleft%5B-%5Cfrac%7B1%7D%7B2%7D%20%5Cfrac%7B(z_%7Bt%20+%20%5CDelta%7D%20-%20%5Bz_t%20+%20%5CDelta%20f_%5Ctheta%20(z_t,%20t)%5D)%5E2%7D%7B%5Csigma%5E2%20%5CDelta%5E2%7D%5Cright%5D%20%5C%5C%0A%20%20%20%20&amp;=%20E%5Cleft%5B%5Cfrac%7B-1%7D%7B2%5Csigma%5E2%20%5CDelta%7D%20((z_1%20-%20z_0)%20-%20f_%5Ctheta%20(z_t,%20t))%5E2%5Cright%5D%0A%5Cend%7Balign*%7D%0A"></p>
<p>We can plug this simplification into the full ELBO, noting that the sum over time can be written as an expectation.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE_%7Bz_0%7D%20%5Cleft%5B%20%5Clog%20p(z_0)%20-%20%5Clog%20q(z_0%5Cvert%20z_1)%20+%20%5Csum_t%20%5Clog%20p(z_%7Bt+%5CDelta%7D%20%5Cvert%20%20z_t)%20%5Cright%5D%20=%20%5C%5C%0A-KL%5Bq(z_0%5Cvert%20z_1)%20%5Cvert%20p(z_0)%5D%20+%20%5Cfrac%7B-1%7D%7B2%5Csigma%5E2%7D%20E_%7Bt,%20z_0%7D%20%5Cleft%5B%20((z_1%20-%20z_0)%20-%20f_%5Ctheta%20(z_t,%20t))%5E2%20%5Cright%5D%0A"></p>
<p>It breaks into two parts: a KL divergence keeping <img src="https://latex.codecogs.com/png.latex?q(z_0%5Cvert%20z_1)"> close to <img src="https://latex.codecogs.com/png.latex?p(z_0)">, and a stochastic squared loss in which both time and latent code are sampled. As <img src="https://latex.codecogs.com/png.latex?%5CDelta%20%5Cto%200">, the distribution over times approaches uniform. This is precisely the loss for the <em>Rectified Flow</em> model for the case of a fixed <img src="https://latex.codecogs.com/png.latex?q(z_0%20%5Cvert%20%20z_1)">. Originally, the authors interpreted this loss as a way to learn an ODE <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20z%7D%7B%5Cpartial%20t%7D%20=%20f(z,%20t)"> which transports samples <img src="https://latex.codecogs.com/png.latex?z_0"> to observations <img src="https://latex.codecogs.com/png.latex?z_1">. By casting the loss in the language of variational auto-encoders, however, we can learn a posterior distribution for <img src="https://latex.codecogs.com/png.latex?z_0"> at the same time.</p>


</section>

 ]]></description>
  <category>machine_learning</category>
  <guid>https://samanklesaria.github.io/posts/Diffusion-is-a-fancy-VAE.html</guid>
  <pubDate>Tue, 15 Aug 2023 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Sparse Variational Gaussian Processes</title>
  <link>https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes.html</link>
  <description><![CDATA[ 





<p>This notebook introduces <em>Fully Independent Training Conditional</em> (FITC) sparse variational Gaussian process model. You shouldn’t need any prior knowledge about Gaussian processes- it’s enough to know how to condition and marginalize finite dimensional Gaussian distributions. I’ll assume you know about variational inference and Pyro, though.</p>
<div id="b84661b7" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyro</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyro.distributions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dist</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyro <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> poutine</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyro.infer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SVI, Trace_ELBO, Predictive</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.distributions.transforms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LowerCholeskyTransform</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gpytorch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> gp</span></code></pre></div></div>
</div>
<p>Say we observe some data <img src="https://latex.codecogs.com/png.latex?x_1,%20x_2,%20%5Cdotsc">.</p>
<div id="7b42cda5" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">xs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span></code></pre></div></div>
</div>
<p>Assume there’s an unknown function <img src="https://latex.codecogs.com/png.latex?f"> that maps each data point <img src="https://latex.codecogs.com/png.latex?x_i"> to an unknown value <img src="https://latex.codecogs.com/png.latex?f_i">.</p>
<div id="2260da1e" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">fs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>torch.sin(xs)</span></code></pre></div></div>
</div>
<p>And each <img src="https://latex.codecogs.com/png.latex?f_i"> is associated with an observed noisy version <img src="https://latex.codecogs.com/png.latex?y_i">.</p>
<div id="71c7fa37" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>torch.randn(xs.shape)</span></code></pre></div></div>
</div>
<div id="eafecd7c" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">plt.plot(xs, ys)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes_files/figure-html/cell-6-output-1.png" width="569" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Say we have some additional inputs <img src="https://latex.codecogs.com/png.latex?x_1%5E%5Cast,%20x_2%5E%5Cast,%20%5Cdotsc"> and we want to estimate the associated <img src="https://latex.codecogs.com/png.latex?f%5E%5Cast_1,%20f%5E%5Cast_2,%20%5Cdotsc">. We’ll assume that the <img src="https://latex.codecogs.com/png.latex?f_i"> and <img src="https://latex.codecogs.com/png.latex?f%5E%5Cast">, along with a latent vector <img src="https://latex.codecogs.com/png.latex?u"> of outouts at known inputs <img src="https://latex.codecogs.com/png.latex?z">, are all jointly Gaussian. The <img src="https://latex.codecogs.com/png.latex?u_i"> are known as <em>inducing points</em>. We’ll ensure that the conditional covariance structure is sparse, however: <img src="https://latex.codecogs.com/png.latex?f_i"> will be conditionally independent given <img src="https://latex.codecogs.com/png.latex?u">. This will keep the computation of the posterior tractable, even when we have a large number of training points <img src="https://latex.codecogs.com/png.latex?f">.</p>
<p>Specifically, say <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bbmatrix%7D%20u%20%5C%5C%20f%20%5C%5C%20f%5E*%20%5Cend%7Bbmatrix%7D%20%5Csim%20%5Cmathcal%7BN%7D%5Cleft(0,%20%5Cbegin%7Bbmatrix%7D%20K_%7Buu%7D%20%20&amp;%20K_%7Buf%7D%20&amp;%20K_%7Bu*%7D%20%5C%5C%20K_%7Bfu%7D%20&amp;%20D_%7Bff%7D%20&amp;%20K_%7Bfu%7DK_%7Buu%7D%5E%7B-1%7DK_%7Bu*%7D%20%5C%5C%20K_%7B*u%7D%20&amp;%20K_%7B*u%7DK_%7Buu%7D%5E%7B-1%7DK_%7Buf%7D%20&amp;%20K_%7B**%7D%20%5Cend%7Bbmatrix%7D%20%5Cright)%0A"></p>
<p>The expressions for conditionally independent covariances keep popping up, so We’ll abbreviate <img src="https://latex.codecogs.com/png.latex?K_%7Bau%7DK_%7Buu%7D%5E%7B-1%7DK_%7Bub%7D"> as <img src="https://latex.codecogs.com/png.latex?Q_%7Bab%7D">. Using the standard Gaussian conditioning formula, we find that</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bbmatrix%7D%20f%20%5C%5C%20f%5E*%20%5Cend%7Bbmatrix%7D%20%5C,%20%20%5Cbigg%20%5Cvert%20%5C,%20u%20%5Csim%20%5Cmathcal%7BN%7D%20%5Cleft(%0A%5Cbegin%7Bbmatrix%7D%20K_%7Bfu%7DK_%7Buu%7D%5E%7B-1%7Du%20%5C%5C%20K_%7B*u%7DK_%7Buu%7D%5E%7B-1%7Du%20%5Cend%7Bbmatrix%7D%0A,%20%5Cbegin%7Bbmatrix%7D%20%20D_%7Bff%7D%20-%20Q_%7Bff%7D%20&amp;%20Q_%7Bf*%7D%20%5C%5C%20Q_%7B*f%7D%20&amp;%20K_%7B**%7D%20-%20Q_%7B**%7D%5Cend%7Bbmatrix%7D%20%5Cright)%0A"></p>
<p>We’ll choose <img src="https://latex.codecogs.com/png.latex?D_%7Bff%7D"> so that <img src="https://latex.codecogs.com/png.latex?D_%7Bff%7D%20-%20Q_%7Bff%7D"> is diagonal. Specifically, we’ll let <img src="https://latex.codecogs.com/png.latex?D_%7Bff%7D%20=%20Q_%7Bff%7D%20+%20%5Ctext%7BDiag%7D(I%20-%20Q_%7Bff%7D)">.</p>
<p>It remains to choose the dense covariances <img src="https://latex.codecogs.com/png.latex?K_%7Buu%7D">. We’ll choose a covariance structure that makes <img src="https://latex.codecogs.com/png.latex?u_i"> and <img src="https://latex.codecogs.com/png.latex?u_j"> close when <img src="https://latex.codecogs.com/png.latex?z_i"> and <img src="https://latex.codecogs.com/png.latex?z_j"> are.</p>
<div id="c49dcae4" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> kernel(a,b):</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((a[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> b[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,:])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
</div>
<div id="51eb3b2d" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div></div>
</div>
<div id="f2e68f36" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">k_uu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel(z, z)</span>
<span id="cb8-2">k_uu_chol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linalg.cholesky(k_uu)</span>
<span id="cb8-3">k_uu_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cholesky_inverse(k_uu_chol)</span>
<span id="cb8-4">k_fu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel(xs, z)</span>
<span id="cb8-5">k_ff_given_u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.diag(torch.eye(fs.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (k_fu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> k_uu_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> k_fu.T)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span></span>
<span id="cb8-6">conditioner <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_fu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> k_uu_inv</span></code></pre></div></div>
</div>
<p>This gives us a fully generative prior for the function values <img src="https://latex.codecogs.com/png.latex?f"> and inducing points <img src="https://latex.codecogs.com/png.latex?u">.</p>
<div id="93ea01d4" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model(obs):</span>
<span id="cb9-2">    u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"u"</span>, dist.MultivariateNormal(torch.zeros(k_uu_inv.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), precision_matrix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_uu_inv))</span>
<span id="cb9-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>):</span>
<span id="cb9-4">        f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span>, dist.Normal(conditioner <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> u, k_ff_given_u))</span>
<span id="cb9-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs"</span>, dist.Normal(f, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.16</span>), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>obs)</span></code></pre></div></div>
</div>
<p>We’ll assume that the posterior over <img src="https://latex.codecogs.com/png.latex?u"> given our observations <img src="https://latex.codecogs.com/png.latex?y"> is Gaussian as well.</p>
<div id="fa1a5426" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">lower_cholesky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LowerCholeskyTransform()</span></code></pre></div></div>
</div>
<div id="6835e8ec" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> guide(obs):</span>
<span id="cb11-2">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k_uu_inv.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-3">    m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.param(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>, torch.randn(M))</span>
<span id="cb11-4">    S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lower_cholesky(pyro.param(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>, k_uu_chol))</span>
<span id="cb11-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"u"</span>, dist.MultivariateNormal(m, scale_tril<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>S))</span></code></pre></div></div>
</div>
<p>This guide only covers <img src="https://latex.codecogs.com/png.latex?u">, not <img src="https://latex.codecogs.com/png.latex?f">. The conditional distribution of <img src="https://latex.codecogs.com/png.latex?f"> given <img src="https://latex.codecogs.com/png.latex?u"> will be the same as in the prior because it’s independent of <img src="https://latex.codecogs.com/png.latex?y">. To let the model know that the associated guide has the same conditional distribution for <img src="https://latex.codecogs.com/png.latex?f">, we use Pyro’s <code>block</code> function. As <img src="https://latex.codecogs.com/png.latex?y"> here is Normally distributed about <img src="https://latex.codecogs.com/png.latex?f">, we could analytically marginalize out <img src="https://latex.codecogs.com/png.latex?f">. But we’ll keep things simple and use samples of <img src="https://latex.codecogs.com/png.latex?f"> instead.</p>
<div id="e72cff9c" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">marginalized_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> poutine.block(model, hide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span>)</span></code></pre></div></div>
</div>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>We can fit the parameters in our variational approximation to maximize the ELBO using a standard Pyro training loop.</p>
<div id="32588827" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">adam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.optim.Adam({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lr"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>})</span>
<span id="cb13-2">svi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SVI(marginalized_model, guide, adam, loss<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Trace_ELBO())</span>
<span id="cb13-3">pyro.clear_param_store()</span>
<span id="cb13-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1500</span>):</span>
<span id="cb13-5">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> svi.step(ys)</span>
<span id="cb13-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb13-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>7876.168869018555
1096.6914720535278
678.0399866104126
410.22321701049805
347.35849380493164
295.4183578491211
338.96053409576416
299.43280029296875
245.88098907470703
397.6497116088867
272.0316352844238
280.7838191986084
233.17931365966797
235.1186876296997
250.67036628723145</code></pre>
</div>
</div>
<div id="89b3ed02" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Predictive(model, guide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>guide, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb15-2">samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pred(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'f'</span>].numpy()</span>
<span id="cb15-3">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb15-4">plt.plot(xs, samples.T, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-5">plt.scatter(z, pyro.param(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>).detach().numpy())</span>
<span id="cb15-6">plt.scatter(xs.numpy(), ys.numpy())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes_files/figure-html/cell-15-output-1.png" width="1164" height="781" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="using-gpytorch" class="level1">
<h1>Using GPytorch</h1>
<p>This approach to inference is also available in pre-packaged from the GPytorch library.</p>
<div id="f8a22d33" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> GPModel(gp.models.ApproximateGP):</span>
<span id="cb16-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, num_inducing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb16-3">        variational_strategy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp.variational.VariationalStrategy(</span>
<span id="cb16-4">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, num_inducing),</span>
<span id="cb16-5">            gp.variational.CholeskyVariationalDistribution(num_inducing_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_inducing))</span>
<span id="cb16-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(variational_strategy)</span>
<span id="cb16-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mean_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp.means.ConstantMean()</span>
<span id="cb16-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.covar_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp.kernels.ScaleKernel(gp.kernels.RBFKernel())</span>
<span id="cb16-9"></span>
<span id="cb16-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb16-11">        mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mean_module(x)</span>
<span id="cb16-12">        covar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.covar_module(x)</span>
<span id="cb16-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> gp.distributions.MultivariateNormal(mean, covar)</span></code></pre></div></div>
</div>
<div id="b9efc7b5" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">gp_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GPModel()</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> guide(x, y):</span>
<span id="cb17-4">    pyro.module(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gp"</span>, gp_model)</span>
<span id="cb17-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>):</span>
<span id="cb17-6">        pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span>, gp_model.pyro_guide(x))</span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model(x, y):</span>
<span id="cb17-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>):</span>
<span id="cb17-10">        f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span>, gp_model.pyro_model(x))</span>
<span id="cb17-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs"</span>, dist.Normal(f, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span>), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb17-12"></span>
<span id="cb17-13">gp_model.train()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-14"></span>
<span id="cb17-15">adam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.optim.Adam({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lr"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>})</span>
<span id="cb17-16">svi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SVI(model, guide, adam, loss<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Trace_ELBO(retain_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb17-17"></span>
<span id="cb17-18">pyro.clear_param_store()</span>
<span id="cb17-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb17-20">    gp_model.zero_grad()</span>
<span id="cb17-21">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> svi.step(xs, ys)</span>
<span id="cb17-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-23">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>113.40755844116211
71.39605712890625
74.9711046218872
68.54665279388428
76.04235744476318
78.64530992507935
73.61101055145264
75.58063983917236
76.11869812011719
75.50554418563843</code></pre>
</div>
</div>
<div id="f23aaaaf" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">gp_model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-2">pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Predictive(model, guide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>guide, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb19-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb19-4">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pred(xs, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'f'</span>]</span></code></pre></div></div>
</div>
<div id="c19b2853" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp_model.variational_strategy.inducing_points.detach().numpy()</span>
<span id="cb20-2">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp_model.variational_strategy._variational_distribution.variational_mean.detach().numpy()</span>
<span id="cb20-3">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb20-4">plt.plot(xs.numpy(), samples.T.numpy(), alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb20-5">plt.scatter(z, m)</span>
<span id="cb20-6">plt.scatter(xs.numpy(), ys.numpy())</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes_files/figure-html/cell-19-output-1.png" width="1164" height="781" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="using-a-non-gaussian-likelihood" class="level1">
<h1>Using a non-Gaussian Likelihood</h1>
<p>We don’t always need <img src="https://latex.codecogs.com/png.latex?y"> to be a version of <img src="https://latex.codecogs.com/png.latex?f"> with added noise. We can use an arbitrary stochastic function of <img src="https://latex.codecogs.com/png.latex?f">. For example, say we observe discrete count data instead. We’d like our likelihood to be Poisson.</p>
<div id="9e27466b" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">gp_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GPModel()</span></code></pre></div></div>
</div>
<div id="75f5e054" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model(x, y):</span>
<span id="cb22-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>):</span>
<span id="cb22-3">        f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span>, gp_model.pyro_model(x))</span>
<span id="cb22-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs"</span>, dist.Poisson(F.softplus(f)), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span></code></pre></div></div>
</div>
<div id="d8dd5746" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">latent_fs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div></div>
</div>
<div id="866ba964" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.Poisson(latent_fs).sample()</span></code></pre></div></div>
</div>
<div id="4b159ae1" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">plt.plot(xs, latent_fs)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes_files/figure-html/cell-24-output-1.png" width="575" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9c5a798c" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">plt.plot(xs, ys)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes_files/figure-html/cell-25-output-1.png" width="575" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="54276ed9" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">gp_model.train()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</div>
<div id="b6a8b572" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">adam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyro.optim.Adam({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lr"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>})</span>
<span id="cb28-2">svi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SVI(model, guide, adam, loss<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Trace_ELBO(retain_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span></code></pre></div></div>
</div>
<div id="d09e392e" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">pyro.clear_param_store()</span>
<span id="cb29-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb29-3">    gp_model.zero_grad()</span>
<span id="cb29-4">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> svi.step(xs, ys)</span>
<span id="cb29-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb29-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>6083.084411621094
1781.496367931366
883.2217831611633
674.2122783660889
640.2556610107422
531.372368812561
520.1974086761475
500.5093593597412
485.35011196136475
544.6471176147461</code></pre>
</div>
</div>
<div id="aa57d313" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">gp_model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</div>
<div id="b4f377f8" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Predictive(model, guide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>guide, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div></div>
</div>
<div id="9116e68e" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb33-2">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pred(xs, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'f'</span>]</span></code></pre></div></div>
</div>
<div id="8fc361cc" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb34-2">plt.plot(xs, F.softplus(samples.T).numpy(), alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb34-3">plt.scatter(xs, ys)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes_files/figure-html/cell-32-output-1.png" width="1170" height="781" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>statistics</category>
  <guid>https://samanklesaria.github.io/posts/sparse_variational_gp/Sparse-Variational-Gaussian-Processes.html</guid>
  <pubDate>Mon, 20 Sep 2021 05:00:00 GMT</pubDate>
</item>
</channel>
</rss>
